<link rel="import" href="../lib/jsorolla/src/lib/components/jso-select-box.html">

<dom-module id="team-new-diagnostic-element">
    <style>
        :host {
            display: block;
            position: relative;
            box-sizing: border-box;
            width: 100%;
            height: 750px;
        }

        .file {
            text-align: center;
            color: #445D76;
            margin-top: 5px;
            width: 100px;
        }

        .selbox {
            /*box-sizing: border-box;
            border-right: 1px solid #d0d0d0;*/
            height: 650px;
            width: 25%;
            overflow-y: auto;

        }

        .panel-item {
            padding: 2px 5px;
        }

        .panel-item {
            color: #555;
        }

        .panel-item:hover {
            background-color: #eee;
        }

        .panel-item[data-checked] {
            background-color: #ddd;
        }

        label.jso {
            display: block;
        }

        jso-opencga-browser {
            position: relative;
            width: 100%;
            height: 300px;
        }

        .errmsg {
            color: #8b0000;
            font-size: 15px;
            font-style: italic;
        }

        #panelPreview {
            width: 70%;
            height: 650px;
        }

        .titlePreview {
            font-size: 15px;
            color: #445D76;
            margin-top: 5px;
            /*text-align: center;*/
            border-bottom: 1px solid #445D76;
            margin-left: 10px;
        }

        .eye > i:hover {
            color: #666;
            cursor: pointer;
        }

        .stepName {
            font-size: 20px;
            text-align: center;
            color: #445D76;
            margin-bottom: 10px;
        }

        #personalData {
            border: 1px solid #d3d3d3;
            padding: 10px;
            margin: 20px 100px;
        }

        .data {
            color: #666;
            margin-top: 10px;
            margin-bottom: 5px;
        }

        .sgenesTextArea {
            box-sizing: border-box;
            width: 100%;
            resize: none;
            height: 100px;
            margin-top: 5px;
        }
    </style>
    <template>

        <jso-wizard id="formWizard">
            <!-- <form id="form"> -->
            <div class="step">
                <!-- <div class="jso-formbox"> -->
                <div class="stepName">
                    Step 1: Choose a File
                    <span class="errmsg" style="margin-right: 50px;">{{errorMessageFile}}</span>
                </div>

                <div class="jso-formbox" style="padding:0">
                    <jso-opencga-browser id="brower" projects="{{projects}}" bioformats="{{bioformats}}" on-fileselect="handleFileSelected" disable-new-project disable-new-study></jso-opencga-browser>
                </div>
                <!-- </div> -->
            </div>
            <div class="step">
                <!-- <div class="jso-formbox"> -->
                <div class="stepName">Step 2: Choose a Panel
                    <!-- <span class="eye">&nbsp;<i class="fa fa-eye" title="View Panel" on-click="handlePreviewFile"></i> </span> -->
                    <span class="errmsg" style="margin-right: 50px;">{{errorMessagePanel}}</span>
                </div>
                <div class="horizontal layout">
                    <div class=" selbox" id="panelSelector">
                      <div class="titlePreview"><i class="fa fa-list"></i>&nbsp; Panel List</div>
                        <!-- <template is="dom-repeat" items="{{panels}}" filter="isPanel">
                                    <label class="horizontal layout jso-control" style="margin-top:10px">
                                        <input type="radio" name="panel" class="panel-item" on-click="handlePanelClick" data-file$="{{item.file.id}}">
                                        <span>{{item.name}}</span>
                                    </label>
                                </template> -->
                        <jso-select-box style="margin:10px" options="{{panels}}" title-attribute="name" on-select="handlePanelClick"></jso-select-box>
                    </div>
                    <div id="panelPreview">
                        <div class="titlePreview">
                            <i class="fa fa-eye"></i>&nbsp; Panel Preview
                        </div>
                        <team-panel-preview selected-panel="{{selectedPanel}}">
                        </team-panel-preview>
                    </div>
                </div>

                <!-- </div> -->
                <!-- <jso-panel modal closable hidden id="panelPreview">
                        <div class="header">
                            <i class="fa fa-eye"></i> Panel Preview
                        </div>
                        <team-panel-preview class="container" selected-panel="{{selectedPanel}}">
                        </team-panel-preview>
                    </jso-panel> -->
            </div>
            <div class="step">
                <!-- <div class="jso-formbox"> -->
                <div class="stepName">Step 3: Job information</div>
                <div class="jso-formcontent vertical layout" id="personalData">
                    <div style="color:#666;margin-top:5px;">Job name</div>
                    <input style="margin-top: 5px;border-color:#d3d3d3;" type="text" id="jobName" value="{{jobName::change}}" required>
                    <div class="data">Description</label>
                        <textarea class="jso sgenesTextArea flex" value="{{jobDescription}}" required></textarea>
                    </div>
                    <!-- </div> -->
                    <div class="horizontal layout">
                        <div class="jso-btn jso-btn-shdw file" style="width:200px;margin:0 auto" on-click="handleForm"><i class="fa fa-rocket"></i>&nbsp; Run
                        </div>
                        <span class="errmsg" style="margin-right: 50px;">{{errorMessage}}</span>
                    </div>
                </div>

                </form>
        </jso-wizard>

    </template>
</dom-module>
<script>
    Polymer({
        is: "team-new-diagnostic-element",
        properties: {
            panels: {
                type: Array,
                value: function() {
                    return [];
                },
                observer: 'handlePanelsChanged'
            },
            projects: {
                type: Array,
                value: function() {
                    return [];
                }
            },
            selectedPanelId: {
                type: Number,

                observer: 'handleSelectedPanelChanged'
            },
            selectedPanel: {
                type: Object,


            },
            bioformats: {
                type: Array,
                value: function() {
                    return [];
                }
            },
            defaultStudy: {
                type: Object,
                value: function() {
                    return {};
                }
            },
            analysisFolder: {
                type: Object,
                value: function() {
                    return {};
                }
            },
            jobName: {
                type: String,
                value: "TEAM Diagnosis"
            },
            jobDescription: {
                type: String,
                value: "New Diagnosis"
            },

        },

        ready: function() {

        },
        handlePanelsChanged: function(neo, old) {

        },
        isPanel: function(item) {
            return item.file.name.indexOf("panel") == 0;
        },
        handleForm: function(e) {
            var me = this;

            if (this.inputSelectedFile == null) {
                this.errorMessageFile = "No input file selected";
            }
            if (this.selectedPanelId == "") {
                this.errorMessagePanel = "No panel selected";
            }

            if (this.inputSelectedFile != null && this.selectedPanelId != "") {
                this.errorMessage = " ";

                var query = {
                    sid: Cookies("bioinfo_sid"),
                    studyId: this.defaultStudy.id,
                    toolId: "team",
                    //                outdir: this.$.outdir.selectedFile.id,
                    //                name: "TEAM_JOB_NAME",
                    name: this.jobName,
                    description: "TEAM_DESC",
                    //                description: this.description,

                    "input": this.inputSelectedFile.id,
                    "panel": this.selectedPanelId,
                    output: this.analysisFolder.id

                };

                OpencgaManager.jobs.create({
                    query: query,
                    request: {
                        //method: 'POST',
                        success: function(response) {
                            if (response.response[0].errorMsg === '' || response.response[0].errorMsg == null) {
                                var userId = response.response[0].result[0].id;
                                me.fire('run');
                                //                            me.message = userId + ' created';
                                //                            me.selectedOption = "jobLaunched"
                            } else {
                                //                            me.message = response.response[0].errorMsg;
                            }
                        },
                        error: function() {
                            me.message = 'Server error, try again later.';
                        }
                    }
                })
            } else {
                this.errorMessage = "There are errors in the form. Correct them before launching work.";
            }
        },
        handleClose: function(e) {
            this.fire('close');
        },
        handlePanelClick: function(e) {
            //  var sel = this.querySelectorAll('.panel-item');
            // for (var i = 0; i < sel.length; i++) {
            //     var el = sel[i];
            //     el.removeAttribute('data-checked');
            // }
            this.selectedPanelId = e.detail.file.id;
            this.errorMessagePanel = " ";
            //  e.currentTarget.setAttribute('data-checked', '');

            // var aux = this.$.panelSelector.querySelectorAll('input[type=radio]');
            // for (var i = 0; i < aux.length; i++) {
            //     var filech = aux[i];
            //     if (filech.checked) {
            //         fileId = parseInt(filech.dataset.file);
            //     }
            // }

            var data;

            OpencgaManager.files.content({
                id: this.selectedPanelId,
                query: {
                    sid: Cookies('bioinfo_sid'),
                    limit: 100
                },
                request: {
                    async: false,
                    success: function(response) {
                        data = response;
                    },
                    error: function() {}
                }
            });

            if (data) {
                this.selectedPanel = JSON.parse(data);
            }

        },
        handleSelectedPanelChanged: function(neo, old) {
            console.log(this.selectedPanelId);
        },
        handleFileSelected: function(e) {
            this.inputSelectedFile = e.detail;
            this.errorMessageFile = " ";
        },
        // handlePreviewFile: function(e) {
        //     var aux = this.$.panelSelector.querySelectorAll('input[type=radio]');
        //     for (var i = 0; i < aux.length; i++) {
        //         var filech = aux[i];
        //         if (filech.checked) {
        //             fileId = parseInt(filech.dataset.file);
        //         }
        //     }
        //
        //     var data;
        //
        //     OpencgaManager.files.content({
        //         id: fileId,
        //         query: {
        //             sid: Cookies('bioinfo_sid'),
        //             limit: 100
        //         },
        //         request: {
        //             async: false,
        //             success: function(response) {
        //                 data = response;
        //             },
        //             error: function() {}
        //         }
        //     });
        //
        //     if (data) {
        //         this.selectedPanel = JSON.parse(data);
        //         this.$.panelPreview.hidden = false;
        //     }
        //
        //     this.$.panelPreview.hidden = false;
        // },
    });
</script>
