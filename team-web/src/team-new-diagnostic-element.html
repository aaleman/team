<link rel="import" href="../lib/jsorolla/src/lib/components/jso-select-box.html">
<link rel="import" href="../lib/jsorolla/src/lib/components/jso-wizard.html">

<dom-module id="team-new-diagnostic-element">
    <style>
        :host {
            display: block;
            position: relative;
            box-sizing: border-box;
            width: 100%;
            height: 770px;
        }

        .file {
            text-align: center;
            color: #445D76;
            margin: 5px;
            width: 100px;
        }

        .selbox {
            /*box-sizing: border-box;
            border-right: 1px solid #d0d0d0;*/
            height: 600px;
            width: 300px;
            overflow-y: auto;
        }

        .panel-item {
            padding: 2px 5px;
        }

        .panel-item {
            color: #555;
        }

        .panel-item:hover {
            background-color: #eee;
        }

        .panel-item[data-checked] {
            background-color: #ddd;
        }

        label.jso {
            display: block;
        }

        jso-opencga-browser {
            position: relative;
            width: 100%;
            height: 400px;
        }

        .errmsg {
            color: #8b0000;
            font-size: 15px;
            font-style: italic;
        }

        #panelPreview {
            width: 70%;
            height: 650px;
        }

        .titlePreview {
            font-size: 15px;
            color: #445D76;
            margin-top: 5px;
            /*text-align: center;*/
            border-bottom: 1px solid #445D76;
            margin-left: 10px;
        }

        .eye > i:hover {
            color: #666;
            cursor: pointer;
        }

        #personalData {
            border: 1px solid #d3d3d3;
            padding: 10px;
            margin: 20px 250px;
            width: 500px;
        }

        .data {
            color: #666;
            margin-top: 10px;
            margin-bottom: 5px;
        }

        .sgenesTextArea {
            box-sizing: border-box;
            width: 100%;
            resize: none;
            height: 100px;
            margin-top: 5px;
        }

        #newPanelPanel {
            /*top:25px;*/
            width: 50%;
            min-width: 1000px;
            margin: 0 auto;
            box-shadow: 0px 0px 12px 6px rgba(0, 0, 0, 0.30);
        }

        .newPanelButon {
            margin: 10px;
            border: 1px solid #d3d3d3;
            margin-bottom: 0px;
        }
    </style>
    <template>

        <jso-wizard id="formWizard">
            <div class="title">
                <div class="stepName">Choose a File
                    <span class="errmsg" style="margin-right: 50px;">{{errorMessageFile}}</span>
                </div>
                <div class="stepName">Choose a Panel
                    <span class="errmsg" style="margin-right: 50px;">{{errorMessagePanel}}</span>
                </div>

                <div class="stepName">Job information</div>
            </div>

            <div class="container">
                <div class="step">
                    <div class="jso-forcontent" style="padding:0">
                        <jso-opencga-browser id="fileBrowser" projects="{{projects}}" bioformats="{{bioformats}}" on-fileselect="handleFileSelected" mode="file"></jso-opencga-browser>
                    </div>
                </div>
                <div class="step">
                    <div class="horizontal layout">
                        <!-- <div class="vertical layout"> -->
                            <div class="selbox vertical layout" id="panelSelector">
                                <div class="horizontal layout">
                                    <div class="titlePreview flex"><i class="fa fa-list"></i>&nbsp; Panel List</div>
                                </div>
                                <jso-select-box style="margin:10px" options="{{panels}}" title-attribute="name" on-select="handlePanelClick"></jso-select-box>

                                <div class="flex"></div>
                                <div class="newPanelButon">
                                    <div class="jso-formtitle" style="font-size:14px;">Create a New Panel &nbsp;</div>
                                    <div class="horizontal layout">
                                        <div class="flex"></div>
                                        <div id="botbar" class="jso-btn jso-btn-shdw file" title="New Panel" on-click="handleNewPanel">
                                            <i class="fa fa-plus"></i>&nbsp; Panel</div>
                                    </div>
                                </div>
                            </div>
                        <!-- </div> -->

                        <div id="panelPreview">
                            <div class="titlePreview">
                                <i class="fa fa-eye"></i>&nbsp; Panel Preview
                            </div>
                            <team-panel-preview selected-panel="{{selectedPanel}}">
                            </team-panel-preview>
                        </div>
                    </div>
                    <jso-panel modal movable expandible closable id="newPanelPanel" hidden>
                        <div class="header" style="text-align:left;font-size:15px;">
                            <i class="fa fa-plus"></i> New Panel
                        </div>
                        <team-panel-form-wizard id="formWizard" class="container" team-config-folder="{{teamConfigFolder}}" default-study="{{defaultStudy}}" panels="{{panels}}"></team-panel-form-wizard>
                    </jso-panel>

                </div>
                <div class="step">
                    <div class="jso-formcontent vertical layout" id="personalData">
                        <div style="color:#666;margin-top:5px;">Job name</div>
                        <input style="margin-top: 5px;border-color:#d3d3d3;" type="text" id="jobName" value="{{jobName::change}}" required>

                        <div class="data">Description</label>
                            <textarea class="jso sgenesTextArea flex" value="{{jobDescription::change}}" required></textarea>
                        </div>
                        <div class="horizontal layout">
                            <div class="jso-btn jso-btn-shdw file" style="width:200px;margin: 0 auto;margin-top:10px;" on-click="handleForm"><i class="fa fa-rocket"></i>&nbsp; Run
                            </div>
                            <span class="errmsg" style="margin-right: 50px;">{{errorMessage}}</span>
                        </div>
                    </div>
                </div>
            </div>
        </jso-wizard>

    </template>
</dom-module>
<script>
    Polymer({
        is: "team-new-diagnostic-element",
        properties: {
            panels: {
                type: Array,
                value: function() {
                    return [];
                },

            },
            projects: {
                type: Array,
                value: function() {
                    return [];
                }
            },
            selectedPanelId: {
                type: Number,

                observer: 'handleSelectedPanelChanged'
            },
            selectedPanel: {
                type: Object,
                observer: 'handleSelectedPanelChanged'
            },
            bioformats: {
                type: Array,
                value: function() {
                    return [];
                }
            },
            defaultStudy: {
                type: Object,
                value: function() {
                    return {};
                }
            },
            analysisFolder: {
                type: Object,
                value: function() {
                    return {};
                }
            },
            jobName: {
                type: String,
                value: "TEAM Diagnosis"
            },
            jobDescription: {
                type: String,
                value: "New Diagnosis"
            },
            selectedStudy: {
                type: Object,
            },

        },
        observers: [
            "handlePanelsChanged(panels.splices)"
        ],

        ready: function() {

        },
        handlePanelsChanged: function(value) {
            var aux = 0;
            if (this.panels == "") {
                this.set('selectedPanel', null);
            } else {
                for (var i = 0; i < this.panels.length; i++) {
                    if (this.panels[i].file.id == this.selectedPanelId) {
                        aux = 1;
                    }
                }
                if (aux == 0) {
                    this.set('selectedPanel', null);
                    this.set('selectedPanelId', "");
                }

            }

        },
        isPanel: function(item) {
            return item.file.name.indexOf("panel") == 0;
        },
        handleForm: function(e) {
            var me = this;

            if (this.inputSelectedFile == null) {
                this.errorMessageFile = "No input file selected";
            }
            if (this.selectedPanelId == "") {
                this.errorMessagePanel = "No panel selected";
            }

            if (this.inputSelectedFile != null && this.selectedPanelId != "") {
                this.errorMessage = " ";
                var studyId = this.$.fileBrowser.selectedStudy.study.id;
                this.selectedStudy = this.$.fileBrowser.selectedStudy;

                var query = {
                    sid: Cookies("bioinfo_sid"),
                    studyId: studyId,
                    toolId: "team",
                    name: this.jobName,
                    description: this.jobDescription,

                    fileId: this.inputSelectedFile.id,
                    panel: this.selectedPanelId,
                    output: this.analysisFolder.id,
                    sessionId: Cookies("bioinfo_sid"),
                };

                OpencgaManager.jobs.create({
                    query: query,
                    request: {
                        //method: 'POST',
                        success: function(response) {
                            if (response.response[0].errorMsg === '' || response.response[0].errorMsg == null) {
                                var userId = response.response[0].result[0].id;
                                me.fire('run');
                                //                            me.message = userId + ' created';
                                //                            me.selectedOption = "jobLaunched"
                            } else {
                                //                            me.message = response.response[0].errorMsg;
                            }
                        },
                        error: function() {
                            me.message = 'Server error, try again later.';
                        }
                    }
                })
            } else {
                this.errorMessage = "There are errors in the form. Correct them before launching work.";
            }
            this.set('jobName', "TEAM Diagnosis");
            this.set('jobDescription', "New Diagnosis");
        },
        handleClose: function(e) {
            this.fire('close');
        },
        handlePanelClick: function(e) {

            this.selectedPanelId = e.detail.file.id;
            this.errorMessagePanel = " ";

            var data;

            OpencgaManager.files.content({
                id: this.selectedPanelId,
                query: {
                    sid: Cookies('bioinfo_sid'),
                    limit: 100
                },
                request: {
                    async: false,
                    success: function(response) {
                        data = response;
                    },
                    error: function() {}
                }
            });

            if (data) {
                this.selectedPanel = JSON.parse(data);
            }

        },
        handleSelectedPanelChanged: function(neo, old) {
            console.log(this.selectedPanelId);
            console.log(this.selectedPanel);
        },
        handleFileSelected: function(e) {
            this.inputSelectedFile = e.detail;
            this.errorMessageFile = " ";
        },
        handleNewPanel: function(e) {
            this.$.newPanelPanel.hidden = false;
        }

    });
</script>
