<dom-module id="team-new-diagnostic-element">
    <style>
        :host {
            display: block;
            position: relative;
            box-sizing: border-box;

            width: 100%;
            height: 600px;
        }

        .file {
            text-align: center;
            color: #445D76;
            margin-top: 5px;
            width: 100px;
        }

        .selbox {
            box-sizing: border-box;
            height: 150px;
            overflow-y: auto;
        }

        .panel-item {
            padding: 2px 5px;
        }

        .panel-item {
            color: #555;
        }

        .panel-item:hover {
            background-color: #eee;
        }

        .panel-item[data-checked] {
            background-color: #ddd;
        }

        label.jso {
            display: block;
        }

        jso-opencga-browser {
            position: relative;
            width: 100%;
            height: 300px;
        }

    </style>
    <template>

        <jso-wizard id="formWizard">
            <form id="form">
                <div class="step">
                    <div class="jso-formbox">
                        <div class="jso-formtitle">
                            Step 1: Choose a File
                        </div>
                        <div class="jso-formcontent" style="padding:0">
                            <jso-opencga-browser id="brower" projects="{{projects}}" bioformats="{{bioformats}}"
                                                 on-fileselect="handleFileSelected" disable-new-project
                                                 disable-new-study></jso-opencga-browser>
                        </div>
                    </div>
                </div>
                <div class="step">
                    <div class="jso-formbox">
                        <div class="jso-formtitle">Step 2: Choose a Panel</div>
                        <div class="jso-formcontent selbox" id="panelSelector">
                            <template is="dom-repeat" items="{{panels}}" filter="isPanel">
                                <div class="panel-item" on-click="handlePanelClick" data-file$="{{item.file.id}}">
                                    <span>{{item.name}}</span>
                                </div>
                            </template>
                        </div>
                    </div>
                </div>
                <div class="step">
                    <div class="jso-formbox">
                        <div class="jso-formtitle">Step 3: Job information</div>
                        <div class="jso-formcontent">
                            <label class="jso">Job name</label>
                            <input class="jso" type="text" id="jobName" value="{{jobName::change}}" required>
                            <label class="jso">Description</label>
                            <textarea class="jso" value="{{jobDescription}}" required></textarea>
                        </div>
                    </div>
                    <div class="jso-btn jso-btn-shdw file" style="width:200px;margin:0 auto" on-click="handleForm"><i
                            class="fa fa-rocket"></i>&nbsp; Run
                    </div>
                </div>

            </form>
        </jso-wizard>

    </template>
</dom-module>
<script>
    Polymer({
        is: "team-new-diagnostic-element",
        properties: {
            panels: {
                type: Array,
                value: function () {
                    return [];
                },
                observer: 'handlePanelsChanged'
            },
            projects: {
                type: Array,
                value: function () {
                    return [];
                }
            },
            selectedPanel: {
                type: Object,
                value: function () {
                    return [];
                },
                observer: 'handleSelectedPanelChanged'
            },
            bioformats: {
                type: Array,
                value: function () {
                    return [];
                }
            },
            defaultStudy: {
                type: Object,
                value: function () {
                    return {};
                }
            },
            analysisFolder: {
                type: Object,
                value: function () {
                    return {};
                }
            },
            jobName: {
                type: String,
                value: "TEAM Diagnosis"
            },
            jobDescription: {
                type: String,
                value: "New Diagnosis"
            }
        },
        handlePanelsChanged: function (neo, old) {
            //            debugger
        },
        isPanel: function (item) {
            return item.file.name.indexOf("panel") == 0;
        },
        handleForm: function (e) {
            var me = this;
            var query = {
                sid: Cookies("bioinfo_sid"),
                studyId: this.defaultStudy.id,
                toolId: "team",
                //                outdir: this.$.outdir.selectedFile.id,
                //                name: "TEAM_JOB_NAME",
                name: this.jobName,
                description: "TEAM_DESC",
                //                description: this.description,
                "input": this.inputSelectedFile.id,
                "panel": this.selectedPanel,
                output: this.analysisFolder.id
            };

            OpencgaManager.jobs.create({
                query: query,
                request: {
                    //method: 'POST',
                    success: function (response) {
                        if (response.response[0].errorMsg === '' || response.response[0].errorMsg == null) {
                            var userId = response.response[0].result[0].id;
                            me.fire('run');
                            //                            me.message = userId + ' created';
                            //                            me.selectedOption = "jobLaunched"
                        } else {
                            //                            me.message = response.response[0].errorMsg;
                        }
                    },
                    error: function () {
                        me.message = 'Server error, try again later.';
                    }
                }
            })


        },
        handleClose: function (e) {
            this.fire('close');
        },
        handlePanelClick: function (e) {
            var sel = this.querySelectorAll('.panel-item');
            for (var i = 0; i < sel.length; i++) {
                var el = sel[i];
                el.removeAttribute('data-checked');
            }
            this.selectedPanel = e.currentTarget.dataset.file;
            e.currentTarget.setAttribute('data-checked', '')

        },
        handleSelectedPanelChanged: function (neo, old) {
            console.log(this.selectedPanel);
        },
        handleFileSelected: function (e) {
            this.inputSelectedFile = e.detail;
        }
    });
</script>
