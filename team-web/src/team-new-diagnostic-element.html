<link rel="import" href="../lib/jsorolla/src/lib/components/jso-select-box.html">
<link rel="import" href="../lib/jsorolla/src/lib/components/jso-wizard.html">
<link rel="import" href="../lib/jsorolla/src/lib/components/jso-progress-bar.html">

<dom-module id="team-new-diagnostic-element">
    <style>
        :host {
            display: block;
            position: relative;
            box-sizing: border-box;
            width: 100%;
            height: 100%;
            font-size: 12px;
        }

        .file {
            text-align: center;
            color: #445D76;
            margin: 5px;
            width: 100px;
        }

        .selbox {
            /*box-sizing: border-box;
            border-right: 1px solid #d0d0d0;*/
            height: 400px;
            width: 300px;
            overflow-y: hidden;
        }

        label.jso {
            display: block;
        }

        jso-opencga-sample-browser {
            position: relative;
            width: 100%;
            height: 400px;
        }

        .errmsg {
            color: #8b0000;
            font-size: 11px;
            font-style: italic;
        }

        #panelPreview {
            width: 70%;
            height: 60%;
        }

        .titlePreview {
            font-size: 12px;
            color: #445D76;
            margin: 2px 10px 0px 10px;
            border-bottom: 1px solid #445D76;
            /*padding-bottom: 3px;*/
        }

        .eye > i:hover {
            color: #666;
            cursor: pointer;
        }

        #personalData {
            border: 1px solid #d3d3d3;
            padding: 5px;
            margin: 0 auto;
            width: 500px;
            margin-top:10px;
            height: 80%;
        }

        .data {
            color: #666;
            margin-top: 10px;
            margin-bottom: 5px;
        }

        .sgenesTextArea {
            box-sizing: border-box;
            width: 100%;
            resize: none;
            height: 100px;
            margin-top: 5px;
        }

        #newPanelPanel {
            /*top:25px;*/
            width: 50%;
            min-width: 800px;
            margin: 0 auto;
            box-shadow: 0px 0px 12px 6px rgba(0, 0, 0, 0.30);
        }

        .newPanelButon {
            margin: 10px;
            padding-left: 5px;
            border: 1px solid #d3d3d3;
            margin-bottom: 0px;
            margin-top:5px;
            line-height: 30px;
            background-color: #E5E8EA;
        }

        #botbar {
            text-align: center;
            color: #445D76;
            margin: 5px;
            width: 80px;
        }

        jso-select-box {
            overflow-y: auto;
            height: 250px;
        }

        #examplePanels {
            height: 100px;
            display: block;
            position: relative;
            box-sizing: border-box;
            overflow-y: auto;
            border: 1px solid var(--divider-color);
            background-color: #FFF;
            margin: 10px;
        }

        .jso-formtitle {
            font-size: 12px;
        }

        .panel-item {
            padding: 2px 5px;
            cursor: pointer;
        }

        .panel-item[selected] {
            background-color: #ddd;
        }

        .panel-item:hover {
            background-color: var(--hover-color);
        }
    </style>
    <template>

        <jso-wizard id="jsoFormWizard">
            <div class="title">
                <div class="stepName">Choose a Sample
                    <span class="errmsg" style="margin-right: 50px;">{{errorMessageFile}}</span>
                </div>
                <div class="stepName">Choose a Panel
                    <span class="errmsg" style="margin-right: 50px;">{{errorMessagePanel}}</span>
                </div>

                <div class="stepName">Job information</div>
            </div>

            <div class="container">
                <div class="step">
                    <div class="jso-formcontent" style="padding:0">
                        <!--<jso-opencga-browser id="fileBrowser" projects="{{projects}}" bioformats="{{bioformats}}" on-fileselect="handleFileSelected" mode="file"></jso-opencga-browser>-->
                        <jso-opencga-sample-browser enable-multiselect enable-auto-index class="container" id="sampleBrowser" projects="{{projects}}" filtered-samples="{{filteredSamples}}" bioformats="{{bioformats}}" on-sampleselected="handleSampleSelected" disable-case-control></jso-opencga-sample-browser>

                    </div>
                </div>
                <div class="step">
                    <div class="horizontal layout">
                        <!-- <div class="vertical layout"> -->
                        <div class="selbox vertical layout" id="panelSelector">
                            <div class="titlePreview flex" style="margin-right=0px !important;padding-bottom:5px"><i class="fa fa-list"></i>&nbsp; User Panel List</div>
                            <jso-select-box id="newDiagnosticPanels" style="margin:5px" options="{{jobsPanels}}" data-panels="{{jobsPanels}}" title-attribute="name" on-select="handlePanelClick"></jso-select-box>

                            <div class="titlePreview flex" style=""><i class="fa fa-list"></i>&nbsp; Example Panel List</div>
                            <div id="examplePanels">
                                <template is="dom-repeat" items="{{examplePanels}}">
                                    <div class="panel-item horizontal layout center" data-file="{{item}}" on-click="handlePanelExampleSelected">
                                        <div class="flex" style="color:black;">{{item.name}}</div>
                                    </div>
                                </template>
                            </div>
                            <div class="newPanelButon horizontal layout">
                                <div class="flex" style="font-size:11px;">Or create a New Panel &nbsp;</div>
                                <div id="botbar" class="jso-btn jso-btn-shdw" title="New Panel" on-click="handleNewPanel">
                                    <i class="fa fa-plus"></i>&nbsp; Panel
                                </div>
                            </div>
                        </div>

                        <div id="panelPreview">
                            <div class="titlePreview">
                                <i class="fa fa-eye"></i>&nbsp; Panel Preview
                            </div>
                            <team-panel-preview id="newDiagnosticPanelPreview" data-panel="{{selectedPanel}}" selected-panel="{{selectedPanel}}" style="width:95%;">
                            </team-panel-preview>
                        </div>
                    </div>
                    <jso-panel modal movable expandible closable id="newPanelPanel" hidden>
                        <div class="header" style="text-align:left;font-size:15px;">
                            <i class="fa fa-plus"></i> New Panel
                        </div>
                        <team-panel-form-wizard panel-config="{{panelConfig}}" id="formWizard" class="container" team-config-folder="{{teamConfigFolder}}" default-study="{{defaultStudy}}" config-panel="{{configPanel}}"></team-panel-form-wizard>
                    </jso-panel>

                </div>
                <div class="step">
                    <div class="jso-formcontent vertical layout" id="personalData">
                        <div style="color:#666;margin-top:5px;">Job name</div>
                        <input style="margin-top: 5px;border-color:#d3d3d3;" type="text" id="jobName" value="{{jobName::change}}" required>

                        <div class="data">Description</label>
                            <textarea class="jso sgenesTextArea flex" value="{{jobDescription::change}}" required></textarea>
                        </div>
                        <div class="horizontal layout">
                            <div class="jso-btn jso-btn-shdw file" style="width:200px;margin: 0 auto;margin-top:10px;" on-click="handleForm"><i class="fa fa-rocket"></i>&nbsp; Run
                            </div>
                            <span class="errmsg" style="margin-right: 50px;">{{errorMessage}}</span>
                        </div>
                    </div>
                </div>
            </div>
        </jso-wizard>
        <jso-progress-bar id="progressBar" percent="{{percent}}" text="Launching jobs..." hidden></jso-progress-bar>
    </template>
</dom-module>
<script>
    Polymer({
        is: "team-new-diagnostic-element",
        properties: {
            panelConfig: {
                type: Object,
                value: function() {
                    return {};
                },
                observer: 'panelConfigChanged'

            },
            projects: {
                type: Array,
                value: function() {
                    return [];
                },
                notify: true,
                observer: 'projectsChanged'
            },
            selectedPanelId: {
                type: Number,

                observer: 'handleSelectedPanelChanged'
            },
            selectedPanel: {
                type: Object,
                observer: 'handleSelectedPanelChanged'
            },
            bioformats: {
                type: Array,
                notify: true,
                value: [{
                    text: "VCF 4.0",
                    value: "VARIANT",
                    validator: VCFValidator
                }]
            },
            defaultStudy: {
                type: Object,
                value: function() {
                    return {};
                }
            },
            analysisFolder: {
                type: Object,
                value: function() {
                    return {};
                }
            },
            jobName: {
                type: String,
                value: "TEAM Diagnosis"
            },
            jobDescription: {
                type: String,
                value: "New Diagnosis"
            },
            selectedStudy: {
                type: Object,
            },
            selectedSample: {
                type: Object,
                value: function() {
                    return {};
                }
            },
            selectedSamples: {
                type: Array,
                value: function() {
                    return [];
                }
            },
            examplePanels: {
                type: Array,
                value: function() {
                    return EXAMPLE_PANELS;
                }
            },
            jobsPanels: {
                type: Array,
                value: function() {
                    return [];
                }
            },
            filteredSamples: {
                type: Array,
                value: function() {
                    return [];
                },
                observer: "filteredSamplesChanged"
            },
            percent: {
                type: Number,
                value: 0
            },
        },
        observers: [
            "handlePanelsChanged(panels.splices)"
        ],

        ready: function() {
            this.$.sampleBrowser._parentJsoPanel = this;
        },
        handlePanelsChanged: function(value) {
            var aux = 0;
            if (this.panels == "") {
                this.set('selectedPanel', null);
            } else {
                for (var i = 0; i < this.configPanel.panels.length; i++) {
                    if (this.configPanel.panels[i].fileId == this.selectedPanelId) {
                        aux = 1;
                    }
                }
                if (aux == 0) {
                    this.set('selectedPanel', null);
                    this.set('selectedPanelId', "");
                }
            }
        },
        isPanel: function(item) {
            return item.file.name.indexOf("panel") == 0;
        },
        handleForm: function(e) {
            var me = this;
            this.selectedSamples = this._getSelectedSamples();
            if (this.selectedSamples == null) {
                this.errorMessageFile = "No sample/s selected or sample/s status are not READY"
            }
            if (this.selectedPanelId == null) {
                this.errorMessagePanel = "No panel selected";
            }
            if (this.selectedSamples != null && this.selectedPanelId != null) {
                this.$.progressBar.hidden = false;
                this.async(function() {
                    this.errorMessage = " ";
                    this.selectedPanel.used = true;
                    for (var i = 0; i < this.panelConfig.panels.length; i++) {
                        panel = this.panelConfig.panels[i];
                        if (panel.name == this.selectedPanel.name) {
                            panel.used++;
                        }
                    }
                    var studyId = this.$.sampleBrowser.selectedStudy.study.id;
                    this.selectedStudy = this.$.sampleBrowser.selectedStudy;
                    var total = this.selectedSamples.length;
                    for (var i = 0; i < total; i++) {
                        var sampleId = this.selectedSamples[i].id;
                        console.log(sampleId)

                        var name = me.jobName + sampleId;
                        console.log(name)
                        var query = {
                            sid: Cookies("bioinfo_sid"),
                            studyId: studyId,
                            toolId: "team",
                            name: name,
                            description: me.jobDescription,

                            sampleId: sampleId,
                            panel: me.selectedPanelId,
                            output: me.analysisFolder.id,
                            sessionId: Cookies("bioinfo_sid"),
                        };
                        this._processJob(query, i, total);
                    }
                }, 50);
            } else {
                alert("There are errors in the form. Correct them before launching work");
                return;
            }
        },
        _processJob: function(query, i, total) {
            var me = this;
            this.async(function() {
                OpencgaManager.jobs.create({
                    query: query,
                    request: {
                        //method: 'POST',
                        success: function(response) {
                            if (response.response[0].errorMsg === '' || response.response[0].errorMsg == null) {
                                var userId = response.response[0].result[0].id;
                                me.set('percent', Math.ceil((i + 1) * (100 / total)));
                                console.log(me.percent);
                                me.panelConfig.savePanelConfig();
                                if (i + 1 == total) {
                                    me.set('jobName', "TEAM Diagnosis");
                                    me.set('jobDescription', "New Diagnosis");
                                    me.set('selectedSamples', []);
                                    me.fire('run');
                                }
                            } else {}
                        },
                        error: function() {
                            me.message = 'Server error, try again later.';
                        }
                    }
                });
            }, i * 1000)
        },
        handleClose: function(e) {
            this.fire('close');
        },
        handlePanelClick: function(e) {
            this.selectedPanelId = e.detail.fileId;
            this.errorMessagePanel = " ";
            if (this.selectedSamples.length > 0) {
                this.errorMessage = "";
            }

            var data;

            OpencgaManager.files.content({
                id: this.selectedPanelId,
                query: {
                    sid: Cookies('bioinfo_sid'),
                    limit: 100
                },
                request: {
                    async: false,
                    success: function(response) {
                        data = response;
                    },
                    error: function() {}
                }
            });
            var selectedExample = this.$.examplePanels.querySelector('div[selected]');
            if (selectedExample != null) {
                selectedExample.removeAttribute("selected", "");
            }
            if (data) {
                this.selectedPanel = JSON.parse(data);
            }

        },
        handleSelectedPanelChanged: function(neo, old) {
            console.log(this.selectedPanelId);
            console.log(this.selectedPanel);
        },
        handleFileSelected: function(e) {
            this.inputSelectedFile = e.detail;
            this.errorMessageFile = " ";
        },
        handleSampleSelected: function(e) {
            // this.selectedSample = {};
            // if (e.detail.status != "READY") {
            //     alert("Sample status must be READY");
            //     return;
            // } else {
            //     this.selectedSample = e.detail;
            //     this.push('selectedSamples', e.detail)
            //     this.errorMessageFile = " ";
            //     if (this.selectedPanelId != "") {
            //         this.errorMessage = "";
            //     }
            // }
        },
        handleNewPanel: function(e) {
            this.$.newPanelPanel.hidden = false;
        },
        handlePanelExampleSelected: function(e) {
            this.set('selectedPanel', e.currentTarget.dataFile);
            var selectedExample = this.$.examplePanels.querySelector('div[selected]');
            this.$.newDiagnosticPanels.set('selected', null);

            if (selectedExample != null) {
                selectedExample.removeAttribute("selected", "");
            }
            e.currentTarget.setAttribute("selected", "");
        },
        projectsChanged: function(neo, old) {},
        panelConfigChanged: function(neo, old) {
            this.jobsPanels = [];
            if (neo.panels) {
                for (var i = 0; i < neo.panels.length; i++) {
                    if (!neo.panels[i].archived) {
                        this.push('jobsPanels', neo.panels[i]);
                    }
                }

            }
        },
        _getSelectedSamples: function() {
            var samplesArray = [];
            var samples = this.$.sampleBrowser.querySelectorAll('jso-opencga-sample-list-item[selected]')

            if (samples.length == 0) {
                if (this.filteredSamples.length == 0) {
                    alert('You must select at least one sample');
                }
                return null;
            } else {
                for (var i = 0; i < samples.length; i++) {
                    if (samples[i].sample.status != 'READY') {
                        alert('All selected samples must be READY');
                        return null;
                    } else {
                        samplesArray.push(samples[i].sample);
                    }
                }
                return samplesArray;
            }
        },
        filteredSamplesChanged: function(neo, old) {}
    });
</script>
