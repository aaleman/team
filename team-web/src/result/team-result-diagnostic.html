<link rel="import" href="../lib/jsorolla/src/lib/components/table/jso-table.html">
<dom-module id="team-result-diagnostic">
    <style>
        :host {
            display: block;
            position: relative;
            box-sizing: border-box;
        }

        .title {
            font-size: 22px;
            border-bottom: thin solid #edebe3;
            /*margin: 7px 5px;*/
        }

        jso-table {
            height: 365px;
            border: 1px solid #d0d0d0;
        }

        jso-table::shadow .table-row {
            height: 25px;
        }

        jso-table::shadow {
            font-size: 11px;
        }

        jso-table::shadow .table-pager > input {
            width: 40px !important;
        }
        jso-genome-viewer-element {
            height: 400px;
            overflow-y: auto;
            margin: 0 auto;
            box-shadow: 0px 0px 2px 0px rgba(0, 0, 0, 0.2);
        }
    </style>
    <template>
        <div class="title">{{title}}</div>
        <jso-table id="table" data="{{_data}}" enable-paging selectable exportable enable-resize on-rowclick="handleRowClick"></jso-table>
        <jso-genome-viewer-element id="gv"></jso-genome-viewer-element>
    </template>

</dom-module>
<script>
    Polymer({
        is: "team-result-diagnostic",
        properties: {
            data: {
                type: Array,
                value: function() {
                    return [];
                },
                observer: 'dataChanged'
            },
            _data: {
                type: Array,
                value: function() {
                    return [];
                },
            },
            title: {
                type: String,
                value: ""
            },
            query: {
                type: Object,
                value: function() {
                    return {};
                },
                observer: 'queryChanged'
            },
        },
        _columns: [{
            name: 'chr',
            title: "Chr",
            width: 100
        }, {
            name: 'pos',
            title: "Pos",
            width: 100
        }, {
            name: 'ref',
            title: "Ref",
            width: 100
        }, {
            name: 'alt',
            title: "Alt",
            width: 100
        }, {
            name: 'id',
            title: 'SNP Id',
            width: 100,
            defaultValue: '.'
        }, {
            name: 'qual',
            title: 'Qual',
            width: 100,
            defaultValue: '.',
            formula: function(row) {
                if (isNaN(row.qual)) {
                    return ".";
                }
                return parseFloat(row.qual, 3);

            }
        }, {
            name: 'dp',
            title: 'DP',
            width: 100,
            defaultValue: '.'
        }, {
            name: 'gene',
            title: 'Gene',
            width: 200,
            defaultValue: '.'
        }, {
            name: 'ct',
            title: 'Conseq. Type',
            width: 300,
            defaultValue: '.'
        }, {
            name: 'phylop',
            title: 'phyloP',
            width: 100,
            defaultValue: '.'
        }, {
            name: 'phastcons',
            title: 'Phastcons',
            width: 100,
            defaultValue: '.'
        }, {
            name: 'sift',
            title: 'SIFT',
            width: 100,
            defaultValue: '.'
        }, {
            name: 'polyphen',
            title: 'Polyphen',
            width: 100,
            defaultValue: '.'
        }, {
            name: 'maf1000G',
            title: 'MAF 1000G',
            width: 100,
            defaultValue: '.'
        }, {
            name: 'maf1000GP3',
            title: 'MAF 1000G Phase 3',
            width: 100,
            defaultValue: '.'
        }, {
            name: 'phenotype',
            title: 'Phenotype',
            width: 400,
            defaultValue: '.'
        }, {
            name: 'source',
            title: 'Source',
            width: 100,
            defaultValue: '.'
        }],

        ready: function() {
            this.$.table.columns = this._columns;
            var me = this;
               this.async(function() {
                   this.$.gv.createGenomeViewer();
                   var seq = this.$.gv.genomeViewer.trackListPanel.tracks[2];
                   this.$.gv.genomeViewer.draw();

                   this.genomeViewer = this.$.gv.genomeViewer;
               });
        },
        handleRowClick: function(e) {
            console.log(e.detail.row);
            var row = e.detail.row;
                var reg = row.chr + ":" + row.pos + "-" + row.pos;
                var region = new Region(reg);

                  this.$.gv.genomeViewer.setRegion(region);
        },
        dataChanged: function(neo, old) {
            var _data = [];
            for (var i = 0; i < this.data.length; i++) {
                var elem = this.data[i];
                _data.push(elem);
            };
            this._data = _data;

        },
        queryChanged: function(neo, old) {
            if (neo) {
                // neo => query
                console.log(neo);
                var data = [];
                for (var i = 0; i < this.data.length; i++) {
                    var elem = this.data[i];
                    if (this._applyFilters(elem, neo) == 1) {
                        data.push(elem);
                    }
                };
                this.set('_data', data);
            }
        },

        _applyFilters: function(data, filters) {
            // data = row
            var filtered = true;
            for (var key in filters) {
                var query = filters[key]; // query => value
                var match = false;
                if (key === "filterView") {
                    match = this._checkData(data.sift, query);

                } else if (key === "region") {
                    match = this._checkPosition(data.chr, data.pos, query);
                } else if (key === "gene") {
                    var gene_aux = data.gene.toUpperCase().split(",");
                    match = this._checkValue(gene_aux, query);
                } else if (key === "dp") {
                    match = this._computeInputOption(data.dp, query, filters["dp_op"]);
                } else if (key === "qual") {
                    match = this._computeInputOption(data.qual, query, filters["qual_op"]);
                } else if (key === "maf1000g") {
                    match = this._computeInputOption(data.maf1000g, query, filters["maf1000g_op"]);
                } else if (key === "mafEVS") {
                    // match = this._computeInputOption(data.mafEVS, query, filters["mafEVS_op"]);
                    match = true;
                } else if (key === "sift") {
                    match = this._computeInputOption(data.sift, query, filters["sift_op"]);
                } else if (key === "polyphen") {
                    match = this._computeInputOption(data.polyphen, query, filters["polyphen_op"]);
                } else if (key === "phylop") {
                    match = this._computeInputOption(data.phylop, query, filters["phylop_op"]);
                } else if (key === "phastcons") {
                    match = this._computeInputOption(data.phastcons, query, filters["phastcons_op"]);
                } else if (key === "ct") {
                    ct_aux = data.ct.split(",");
                    match = this._checkValue(ct_aux, query);
                } else if (key.endsWith("_op")) {
                    continue;
                }
                filtered &= match;
            }
            return filtered;
        },
        _computeInputOption: function(value, query, op) {
            var aux = false;
            if (value === ".") {
                aux = true;
            }
            value = parseFloat(value);
            if (op == "==") {
                if (value == query) {
                    aux = true;
                }
            } else if (op == "!=") {
                if (value != query) {
                    aux = true;
                }
            } else if (op == "<") {
                if (value < query) {
                    aux = true;
                }
            } else if (op == "<=") {
                if (value <= query) {
                    aux = true;
                }
            } else if (op == ">") {
                if (value > query) {
                    aux = true;
                }
            } else if (op == ">=") {
                if (value >= query) {
                    aux = true;
                }
            }
            return aux;
        },
        _checkValue: function(value, query) {
            for (var i = 0; i < query.length; i++) {
                for (var j = 0; j < value.length; j++) {
                    if (value[j] == query[i]) {
                        return true;
                    }
                }
            }
            return false;
        },
        _checkPosition: function(chr, position, query) {
            for (var i = 0; i < query.length; i++) {
                var a = query[i].split(":");
                var chr_aux = a[0];
                if (chr == chr_aux) {
                    var pos = a[1].split("-");
                    var start = parseInt(pos[0]);
                    var end = parseInt(pos[1]);
                    if (position >= start && position <= end) {
                        return true;
                    }
                }
            }
            return false;
        },
        _checkData: function(value, query) {
            if (query === "none") {
                return true;
            } else if (query === "filterA") {
                if (value >= 0.75) {
                    return true;
                }
            } else if (query === "filterB") {
                if (value >= 0.50 && value < 0.75) {
                    return true;
                }
            } else if (query === "filterC") {
                if ((value >= 0.25 && value < 0.50) || value == ".") {
                    return true;
                }
            } else if (query === "filterD") {
                if (value < 0.25) {
                    return true;
                }
            }
            return false;
        }
    });
</script>
