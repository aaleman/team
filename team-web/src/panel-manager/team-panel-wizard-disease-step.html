<dom-module id="team-panel-wizard-disease-step"></dom-module>
<style>
    :host {
        display: block;
        position: relative;
        box-sizing: border-box;
        height: 100%;
        width: 100%;

    }

    .step-title {
        height: 50px;
        text-align: center;
        vertical-align: middle;
        line-height: 50px;
        font-size: 16pt;
    }

    .left, .right {
        width: 50%;
    }

    #allDiseases {
        height: 300px;
    }


</style>
<template>
    <div class="vertical layout">
        <div class="step-title">
            Step <span>{{stepNumber}}</span>: Diseases
        </div>
        <div class="step-content horizontal layout">
            <div class="left">
                <jso-table id="allDiseases" columns="{{diseaseColumns}}" data="{{allDiseasesData}}"
                           selected="{{currentSelectedDiseasesData}}" enable-select enable-filter></jso-table>
            </div>
            <div class="jso-btn jso-btn-shdw" on-click="handleAddSelected">Add Selected</div>
            <div class="right">
                <jso-table id="selectedDiseases" columns="{{diseaseColumns}}"
                           data="{{selectedDiseasesData}}"></jso-table>

            </div>
        </div>
    </div>
</template>

<script>
    Polymer({
        is: "team-panel-wizard-disease-step",
        properties: {
            stepNumber: {
                type: Number,
                value: 0
            },
            diseaseColumns: {
                type: Array,
                value: function () {
                    return [];
                }
            },
            diseaseColumns: {
                type: Array,
                value: function () {
                    return [];
                }
            },
            selectedDiseases: {
                type: Array,
                value: function () {
                    return [];
                },
                notify: true,
                observer: 'handleSelectedRows'
            },
            currentSelectedDiseasesData: {
                type: Array,
                value: function () {
                    return [];
                }
            }, selectedDiseasesData: {
                type: Array,
                value: function () {
                    return [];
                }
            },
            associatedGenes: {
                type: Object,
                value: function () {
                    return {};
                }
            }
        },
        ready: function () {

            var me = this;
            if (localStorage.bioinfo_team_diseases) {
                console.log("accediendo a localStorage");
                this.allDiseasesData = JSON.parse(localStorage.bioinfo_team_diseases);

            } else {
                console.log("Llamando a WS")
                $.ajax({
                    url: "http://bioinfodev.hpc.cam.ac.uk/cellbase/webservices/rest/v3/hsapiens/feature/clinical/phenotype-gene?include=clinvar,gwas",
                    dataType: 'json',
                    async: false,
                    success: function (response, textStatus, jqXHR) {
                        try {
                            var data = response.response;
                            var clinvar = data[0].result;
                            var gwas = data[1].result;

                            var diseases = [];

                            for (var i = 0; i < 100; i++) {
//                            for (var i = 0; i < clinvar.length; i++) {
                                var dis = clinvar[i];
                                dis.source = "clinvar";
                                diseases.push(dis);
                            }
                            for (var i = 0; i < 100; i++) {
//                            for (var i = 0; i < gwas.length; i++) {
                                var dis = gwas[i];
                                dis.source = "gwas";
                                diseases.push(dis);
                            }

                            diseases.sort(function (a, b) {
                                return a.phenotype.toLowerCase().localeCompare(b.phenotype.toLowerCase());
                            })


                            if (diseases.length > 0) {
                                localStorage.bioinfo_team_diseases = JSON.stringify(diseases);
                            }


                        } catch (e) {

                        }
                    }
                });

            }
            this.diseaseColumns = [
                {name: 'phenotype', title: 'Phenotype', type: 'text'},
                {
                    name: 'source', title: 'Source', type: 'select', options: ["clinvar", "gwas"], width: '40px'
                },
                {name: '', title: '', type:'action'}
            ];

        },
        handleSelectedRows: function (neo, old) {
            return neo;
        },
        handleAddSelected: function () {

            var newDiseases = this.selectedDiseasesData;
            for (var i = 0; i < this.currentSelectedDiseasesData.length; i++) {
                var row = this.currentSelectedDiseasesData[i];
                newDiseases.push(row);
            }

            this.$.selectedDiseases.update(newDiseases)
        }
    })
    ;
</script>
