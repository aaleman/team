<link rel="import" href="team-mutation-selector.html">

<dom-module id="team-panel-form-wizard">
    <style is="custom-style" include="iron-flex iron-flex-reverse iron-flex-alignment iron-flex-factors iron-positioning">
        :host {
            display: block;
            position: relative;
            box-sizing: border-box;
            min-height: 500px;
            width: 100%;
        }

        .wrapped-text {
            white-space: pre-wrap;
        }

        #genes-tab {
            height: calc(100vh - 300px);
            min-height: 450px;
            width: 35%;
            margin-top: 5px;
            padding-top: 10px;
            overflow-y: auto;
        }

        #genes-list {
            height: calc(100vh - 350px);
            min-height: 400px;
            width: 50%;
            margin: 15px 10px;
            border: 1px solid #d3d3d3;
        }

        .genes-tab-container-elem {
            margin: 20px;
        }

        #mutations-tab {
            height: calc(100vh - 300px);
            min-height: 450px;
            width: 35%;
            min-width: 280px;
            margin-top: 5px;
            padding-top: 10px;
            overflow-y: auto;
            /*min-width: 260px;*/
            font-size: 12px;
        }

        #mutations-list {
            min-height: 400px;
            height: calc(100vh - 350px);
            width: 46%;
            margin: 10px 5px;
            border: 1px solid #d3d3d3;
            margin-right: 15px;
            margin-top: 15px;
        }

        #personalData {
            border: 1px solid #d3d3d3;
            padding: 10px;
            margin: 0 auto;
            min- width: 500px;
            width: 60%;
        }

        .disease {
            min-width: 380px;
            min-height: 400px;
            height: calc(100vh - 350px);
            width: 45%;
            margin: 0 auto;
            border: 1px solid #d3d3d3;
        }

        #panelPreview,
        #panelPreviewMut {
            height: 60%;
        }

        #panelPreview .container,
        #panelPreviewMut .container {
            min-width: 700px;
            width: 100%;
            overflow-y: auto;
            overflow-x: auto;
            padding: 10px;
            box-sizing: border-box;
        }

        #appPanel .container {
            min-width: 700px;
            width: 100%;
            min-height: 500px;
            height: 80%;
            overflow-y: auto;
            overflow-x: auto;
        }

        .file {
            text-align: center;
            color: #445D76;
            margin: 5px;
            width: 100px;
            height: 20px;
            line-height: 17px;
        }

        .sgenesTextArea {
            box-sizing: border-box;
            display: block;
            width: 96%;
            height: 70px;
            resize: none;
            margin: 5px;
        }

        .data {
            color: #666;
            /*margin-top: 10px;*/
            margin-bottom: 5px;
        }

        .input {
            width: 90px;
            height: 10px;
            font-size: 11px;
        }

        .eye {
            border: 1px solid #d3d3d3;
        }

        .eye > i:hover {
            color: #666;
            cursor: pointer;
        }

        #allDiseases,
        #selectedDiseases,
        #geneTable,
        #mutationTable {
            min-height: 400px;
            height: 90%;
            width: 100%;
        }

        #panelAppDiseases {
            margin: 5px;
            min-height: 400px;
            height: 90%;
            width: 55%;
            border: 1px solid #d3d3d3;
            box-sizing: border-box;
        }

        #panelAppGenes {
            margin: 5px;
            min-height: 400px;
            height: 90%;
            width: 40%;
            border: 1px solid #d3d3d3;
            box-sizing: border-box;
        }

        stv-table::shadow .table-row {
            height: 25px;
        }

        stv-table::shadow {
            font-size: 11px;
        }

        stv-table::shadow .table-pager > input {
            width: 40px !important;
        }

        #mutationsFromPanel,
        #genesFromPanel {
            margin-top: 5px;
            margin-left: 5px;
        }

        .diseaseSelected {
            color: #445D76;
            padding: 5px 5px 5px 7px;
            word-wrap: break-word;
        }

        .boxDiseaseSelected {
            border-right: 1px solid var(--divider-color);
            min-width: 115px;
            min-height: 455px;
            height: calc(100vh - 300px);
            width: 25%;
            background-color: var(--light-secondary-color);
            margin-right: 5px;
            padding: 5px;
            overflow-y: auto;
        }

        stv-tooltip {
            font-size: 14px;
        }

        .errmsg {
            color: #8b0000;
            font-size: 15px;
            font-style: italic;
        }

        #panelAppSelectedGenes::shadow .column-LevelOfConfidence[title="HighEvidence"]::after {
            color: #16D824;
            font-family: FontAwesome;
            margin-left: 5px;
            content: '\f012';
        }

        #panelAppSelectedGenes::shadow .column-LevelOfConfidence[title="ModerateEvidence"]::after {
            color: #FF7C00;
            font-family: FontAwesome;
            margin-left: 5px;
            content: '\f012';
        }

        #panelAppSelectedGenes::shadow .column-LevelOfConfidence[title="LowEvidence"]::after {
            color: #FF2600;
            font-family: FontAwesome;
            margin-left: 5px;
            content: '\f012';
        }

        .step {
            /*height: 460px;*/
            min-height: 460px;
            height: calc(100vh - 300px);
        }

        .stepName {
            height: 30px;
        }

        stv-form-box {
            /*max-width: 200px;*/
            font-size: 11px;
        }

        stv-form-box .header {
            font-size: 12px;
        }

        stv-form-box .container {
            width: 100%;
        }

        .mut-element {
            width: 275px;
        }

        #progressDiv {
            background: black;
            opacity: 0.2;
            width: 100%;
            height: 100%;
            z-index: 1000;
            position: fixed;
            top: 0;
            left: 0;
        }

        #progressBar {
            z-index: 1000;
        }
    </style>
    <template>

        <stv-wizard id="jsoFormWizard">
            <div class="title">
                <div class="stepName">Select Diseases</div>
                <div class="stepName">Select Genes</div>
                <div class="stepName">Select Mutations</div>
                <div class="stepName">Panel Info</div>
            </div>
            <div class="container">
                <div class="step">
                    <div class="stv-formcontent horizontal layout" style="border-top:0px;">
                        <div class="disease vertical layout">
                            <stv-table id="allDiseases" class="flex" columns="{{allDiseaseColumns}}" data="{{allDiseasesData}}" selected="{{currentSelectedDiseasesData}}" enable-select enable-filter enable-paging hide-column-selector page-size="12"></stv-table>
                            <div class="horizontal layout" style="border-top: 1px solid #d3d3d3;">
                                <div class="flex"></div>
                                <div class="stv-btn stv-btn-shdw file" on-click="handleAddSelectedDiseases"><i class="fa fa-plus-square-o"></i>&nbsp; Add
                                </div>
                            </div>
                        </div>
                        <div class="disease vertical layout">
                            <stv-table id="selectedDiseases" class="flex" columns="{{diseaseColumns}}" on-removerow="handleRemoveDisease" enable-paging page-size="13" hide-column-selector>
                            </stv-table>
                            <div class="horizontal layout" style="border-top: 1px solid #d3d3d3;">
                                <div class="flex"></div>
                                <div class="stv-btn stv-btn-shdw file" on-click="handleClearSelectedDiseases">
                                    Clear
                                </div>
                            </div>
                        </div>
                    </div>

                </div>
                <div class="step">
                    <div class="horizontal layout">
                        <div class="vertical layout boxDiseaseSelected" flex>
                            <div style="margin-left:2px;color: #666;">Diseases Selected:&nbsp;
                                <template is="dom-repeat" items="{{formData.diseases}}">
                                    <div class="horizontal layout">
                                        <i class="fa fa-arrow-circle-o-right" style="color:#445D76;margin-top:5px"></i>

                                        <div class="diseaseSelected">{{item.phenotype}}</div>
                                    </div>
                                </template>
                            </div>
                        </div>

                        <div id="genes-tab" class="vertical layout">
                            <stv-form-box collapsible>
                                <div class="header">
                                    Genes/Regions &nbsp;
                                    <!-- <stv-tooltip type="info">
                                    </stv-tooltip> -->
                                </div>
                                <div class="container">
                                    <textarea class="jso sgenesTextArea" name="geneTextArea" id="geneTextArea" rows="3" placeholder="BRCA2,PPL"></textarea>
                                    <div class="horizontal layout">
                                        <div class="flex"></div>
                                        <div class="stv-btn stv-btn-shdw file" on-click="handleClickGeneTextAreaButton">
                                            <i class="fa fa-plus-square-o"></i>&nbsp; Add Genes
                                        </div>
                                    </div>
                                </div>
                            </stv-form-box>
                            <stv-form-box collapsible collapsed>
                                <div class="header">
                                    Import from BED &nbsp;
                                    <!-- <stv-tooltip type="info">
                                    </stv-tooltip> -->
                                </div>
                                <div class="container horizontal layout">
                                    <div class="flex"></div>
                                    <div class="stv-btn stv-btn-shdw file" on-click="showImportBEDComponent"><i class="fa fa-plus-square-o"></i>&nbsp; Import
                                    </div>
                                </div>
                            </stv-form-box>
                            <stv-form-box collapsible collapsed>
                                <div class="header">
                                    Import from other Panel &nbsp;
                                    <!-- <stv-tooltip type="info">
                                    </stv-tooltip> -->
                                </div>
                                <div class="container">
                                    <stv-select id="importGenesFromPanel" style="width:150px;margin-top:5px;margin-left:5px">
                                        <stv-option value=" "></stv-option>
                                        <template is="dom-repeat" items="{{panelsNotArchived}}">
                                            <stv-option value$="{{item.name}}" data-file$="{{item.fileId}}">{{item.name}}</stv-option>
                                        </template>
                                    </stv-select>

                                    <div class="horizontal layout">
                                        <div class="stv-btn stv-btn-shdw file" on-click="handlePreviewFile" style="width:105px;"> &nbsp; <i class="fa fa-eye"></i>&nbsp;View Panel
                                        </div>
                                        <div class="flex"></div>
                                        <div class="stv-btn stv-btn-shdw file" on-click="handleImportGenesPanel" style="width:105px;"><i class="fa fa-plus-square-o"></i>&nbsp; Import
                                        </div>
                                    </div>
                                </div>
                            </stv-form-box>
                            <stv-form-box collapsible collapsed>
                                <div class="header">
                                    Import from external App &nbsp;
                                    <!-- <stv-tooltip type="info">
                                    </stv-tooltip> -->
                                </div>
                                <div class="container horizontal layout">
                                    <li class="flex" style="margin-top:8px">Panel App</li>
                                    <div class="stv-btn stv-btn-shdw file" on-click="handleImportAppPanel"><i class="fa fa-plus-square-o"></i>&nbsp; Import
                                    </div>
                                </div>
                            </stv-form-box>
                        </div>

                        <div id="genes-list">
                            <stv-table id="geneTable" columns="{{geneColumns}}" enable-edit hide-column-selector enable-paging page-size="13"></stv-table>
                            <div class="horizontal layout" style="border-top: 1px solid #d3d3d3;">
                                <div class="flex"></div>
                                <div class="stv-btn stv-btn-shdw file" on-click="handleClickGeneListClear">Clear</div>
                            </div>
                        </div>

                    </div>
                    <stv-panel id="importBEDComponent" modal closable hidden>
                        <div class="header">
                            <i class="fa fa-plus-square-o"></i> Import File
                        </div>
                        <stv-import-file id="importBEDFile" class="container" on-importfile="handleImportBEDFile" bioformat="{{bedBioformat}}"></stv-import-file>
                    </stv-panel>

                    <stv-panel modal closable hidden id="panelPreview">
                        <div class="header">
                            <i class="fa fa-eye"></i> Panel Preview
                        </div>
                        <team-panel-preview class="container" selected-panel="{{selectedPanel}}" style="width:662px;">
                        </team-panel-preview>
                    </stv-panel>
                    <stv-panel modal movable fixed closable hidden id="appPanel">
                        <div class="header">
                            <i class="fa fa-plus-square-o"></i> Import from PanelApp
                        </div>

                        <div class="stv-formcontent horizontal layout container">

                            <div id="panelAppDiseases" class="vertical layout">
                                <stv-table class="flex" id="panelAppSelectedDisease" enable-filter columns="{{panelAppDiseasesColumns}}" data="{{panelAppDiseases}}" on-selected="handlePanelAppSelected" enable-select enable-paging hide-column-selector style="height:450px" page-size="12"></stv-table>

                                <div class="horizontal layout">
                                    <div class="flex"></div>
                                    <a href="https://bioinfo.extge.co.uk/crowdsourcing/PanelApp/" target="_blank">
                                        <div class="stv-btn stv-btn-shdw file" style="width: 150px"> >>More info
                                            << </div>
                                    </a>
                                    </div>
                                </div>
                                <div id="panelAppGenes" class="vertical layout">
                                    <stv-table class="flex" id="panelAppSelectedGenes" columns="{{panelAppGenesColumns}}" data="{{panelAppGenes}}" on-selected="handlePanelAppSelectedGen" enable-select hide-column-selector enable-paging style="height:450px"></stv-table>
                                    <div class="horizontal layout">
                                        <div class="flex errmsg">{{errorAddGenes}}</div>
                                        <div class="stv-btn stv-btn-shdw file" on-click="handlePanelAppAddGenes"><i class="fa fa-plus-square-o"></i>&nbsp;Add Genes
                                        </div>
                                    </div>
                                </div>
                            </div>
                    </stv-panel>
                    </div>
                    <div class="step">
                        <div class="horizontal layout">
                            <div class="vertical layout boxDiseaseSelected" flex>
                                <div style="margin-left:2px;color: #666;">Diseases Selected:&nbsp;
                                    <template is="dom-repeat" items="{{formData.diseases}}">
                                        <div class="horizontal layout">
                                            <i class="fa fa-arrow-circle-o-right" style="color:#445D76;margin-top:5px"></i>

                                            <div class="diseaseSelected">{{item.phenotype}}</div>
                                        </div>
                                    </template>
                                </div>
                            </div>
                            <div id="mutations-tab" flex>
                                <stv-form-box collapsible class="mut-element">
                                    <div class="header">
                                        Genomic Pos. &nbsp;
                                    </div>
                                    <div class="container vertical layout" id="mutation-tab-config-gv">
                                        <div class="horizontal layout data">
                                            <label style="font-size:11px;" for="">Chr: &nbsp;</label>
                                            <input class="input" type="text" name="mutationGVChr" id="mutationGVChr" />

                                            <div class="flex"></div>
                                            <label style="font-size:11px;" for="">Pos: &nbsp;</label>
                                            <input class="input" type="number" step="1" min="0" name="mutationGVPos" id="mutationGVPos" />
                                        </div>
                                        <div class="horizontal layout data">
                                            <label style="font-size:11px;" for="">Ref: &nbsp;&nbsp;</label>
                                            <input class="input" type="text" name="mutationGVRef" id="mutationGVRef" />

                                            <div class="flex"></div>
                                            <label style="font-size:11px;" for="">Alt: &nbsp;</label>
                                            <input class="input" type="text" name="mutationGVAlt" id="mutationGVAlt" />
                                        </div>
                                        <div class="horizontal layout data">
                                            <label style="font-size:11px;" for="">Phe: &nbsp;</label>
                                            <input class="input flex" type="text" name="mutationGVPhe" id="mutationGVPhe" />
                                            <!--<datalist id="dataListPhe">-->
                                            <!--<template is="dom-repeat" items="{{allDiseasesData}}">-->
                                            <!--<option value="{{item.phenotype}}">{{item.phenotype}}</option>-->
                                            <!--</template>-->
                                            <!--</datalist>-->
                                        </div>
                                        <div class="horizontal layout">
                                            <div class="stv-btn stv-btn-shdw file" style="width: 150px" on-click="handleOpenGV">
                                                Open Genome Browser
                                            </div>
                                            <div class="flex"></div>
                                            <div class="stv-btn stv-btn-shdw file" on-click="handleMutationAdd"><i class="fa fa-plus-square-o"></i>&nbsp; Add
                                            </div>

                                        </div>
                                    </div>
                                </stv-form-box>
                                <stv-form-box collapsible collapsed class="mut-element">
                                    <div class="header">
                                        Import VCF &nbsp;
                                    </div>
                                    <div class="container">
                                        <div class="horizontal layout data">
                                            <label style="font-size:12px;" for="">Phe: &nbsp;</label>
                                            <input class="input flex" type="text" name="mutationGVPheVCF" id="mutationGVPheVCF" />
                                            <!--<datalist id="dataListPheVCF">-->
                                            <!--<template is="dom-repeat" items="{{allDiseasesData}}">-->
                                            <!--<option value="{{item.phenotype}}">{{item.phenotype}}</option>-->
                                            <!--</template>-->
                                            <!--</datalist>-->
                                        </div>

                                        <div class="horizontal layout">
                                            <div class="flex"></div>
                                            <div class="stv-btn stv-btn-shdw file" on-click="showImportVCFComponent"><i class="fa fa-plus-square-o"></i>&nbsp; Import
                                            </div>
                                        </div>
                                    </div>
                                </stv-form-box>
                                <stv-form-box collapsible collapsed class="mut-element">
                                    <div class="header">
                                        Import CSV &nbsp;
                                    </div>
                                    <div class="container">
                                        <div class="horizontal layout">
                                            <label class="data" style="font-size:12px; margin-top:5px" for="">Separator:</label>
                                            <stv-select name="mutationCSVSeparator" id="mutationCSVSeparator" style="width:75px; margin-left:5px;margin-top: 5px; height: 17px;">
                                                <stv-option value=";" selected>;</stv-option>
                                                <stv-option value=",">,</stv-option>
                                                <stv-option value="tab">Tab</stv-option>
                                            </stv-select>
                                        </div>
                                        <div>
                                            <label class="data" style="font-size:12px;" for="">Ignore first line (header):
                                            </label>
                                            <input type="checkbox" name="mutationCSVHeader" id="mutationCSVHeader" value="ignore" checked/>
                                        </div>

                                        <input style="margin-top:5px" type="file" id="mutationCSVFileInput">

                                        <div class="horizontal layout">
                                            <div class="flex"></div>
                                            <div class="stv-btn stv-btn-shdw file" on-click="handleMutationImportCSV"><i class="fa fa-plus-square-o"></i>&nbsp; Import
                                            </div>
                                        </div>
                                    </div>
                                </stv-form-box>
                                <stv-form-box collapsible collapsed class="mut-element">
                                    <div class="header">
                                        Import from other Panel &nbsp;
                                    </div>
                                    <div class="container">
                                        <stv-select id="importMutationsFromPanel" style="width:150px; margin-top:5px">
                                            <stv-option value=" "></stv-option>
                                            <template is="dom-repeat" items="{{panelsNotArchived}}">
                                                <stv-option value$="{{item.name}}" data-file$="{{item.fileId}}">{{item.name}}</stv-option>
                                            </template>
                                        </stv-select>
                                        <div class="horizontal layout">
                                            <div class="stv-btn stv-btn-shdw file" on-click="handlePreviewFileMut"> &nbsp;
                                                <i class="fa fa-eye"></i>&nbsp;View Panel
                                            </div>
                                            <div class="flex"></div>
                                            <div class="stv-btn stv-btn-shdw file" on-click="handleImportMutationsPanel"><i class="fa fa-plus-square-o"></i>&nbsp; Import
                                            </div>
                                        </div>
                                    </div>
                                </stv-form-box>
                            </div>
                            <div id="mutations-list" flex>
                                <stv-table id="mutationTable" columns="{{mutationColumns}}" enable-paging page-size="13" enable-edit hide-column-selector></stv-table>
                                <div class="horizontal layout" style="border-top: 1px solid #d3d3d3;">
                                    <div class="flex"></div>
                                    <div class="stv-btn stv-btn-shdw file" on-click="handleClickMutationListClear">Clear
                                    </div>
                                </div>
                            </div>

                        </div>
                        <stv-panel id="importVCFComponent" modal closable hidden>
                            <div class="header">
                                <i class="fa fa-plus-square-o"></i> Import File
                            </div>
                            <stv-import-file id="importVCFFile" class="container" on-importfile="handleImportVCFFile" bioformat="{{vcfBioformat}}"></stv-import-file>
                        </stv-panel>
                        <stv-panel modal closable hidden id="panelPreviewMut">
                            <div class="header">
                                <i class="fa fa-eye"></i> Panel Preview
                            </div>
                            <team-panel-preview class="container" selected-panel="{{selectedPanel}}" style="width:662px;">
                            </team-panel-preview>
                        </stv-panel>

                        <stv-panel fixed movable closable hidden id="panelGV">
                            <div class="header">
                                <i class="fa fa-eye"></i> View Mutation
                            </div>
                            <team-mutation-selector class="container" id="mutationSelector" on-created-mutation="handleAddedMutationFromGV">
                            </team-mutation-selector>
                        </stv-panel>
                    </div>
                    <div class="step layout center">
                        <div class="stv-formcontent vertical layout" id="personalData">
                            <div style="color:#666;margin-top:5px;" for="">Name</div>
                            <input style="margin-top: 2px;border-color:#d3d3d3;" type="text" value="{{formData.name::input}}" />

                            <div class="data" for="">Author</div>
                            <input style="margin-top: 2px;border-color:#d3d3d3;" type="text" value="{{formData.author::input}}" />

                            <div class="data" for="">Date</div>
                            <input style="width:150px; margin-top: 2px;border-color:#d3d3d3;" type="date" value="{{formData.date::input}}" placeholder="mm/dd/yyyy" />

                            <div class="data" for="">Description &nbsp; </div>
                            <textarea class="jso sgenesTextArea" style="height: 120px" name="" id="" cols="30" rows="10" value="{{formData.description::input}}"></textarea>

                            <div id="savePanel" class="stv-btn stv-btn-shdw file" style="margin: 0 auto; margin-top:10px" on-click="handleClickSavePanel"><i class="fa fa-floppy-o"></i>&nbsp; Save
                            </div>
                            <div id="saveAsPanel" class="stv-btn stv-btn-shdw file" style="margin: 0 auto; margin-top:10px" on-click="handleClickSavePanel" hidden><i class="fa fa-floppy-o"></i>&nbsp; Save As
                            </div>
                        </div>
                    </div>
                </div>
        </stv-wizard>
        <div id="progressDiv" hidden>

        </div>
        <stv-progress-bar id="progressBar" percent="{{percent}}" text="{{textbar}}" hidden></stv-progress-bar>

    </template>
</dom-module>
<script>
    Polymer({
        is: "team-panel-form-wizard",
        properties: {
            userData: {
                type: Object,
                value: function() {
                    return {};
                },
            },
            step: {
                type: Number,
                value: 1
            },
            maxSteps: {
                type: Number,
                value: 4
            },
            formData: {
                type: Object,
                value: function() {
                    return {};
                },
                notify: true
            },
            diseaseColumns: {
                type: Array,
                value: function() {
                    return [];
                }
            },
            selectedDiseases: {
                type: Array,
                value: function() {
                    return [];
                },
                notify: true,
                observer: 'handleSelectedRows'
            },
            currentSelectedDiseasesData: {
                type: Array,
                value: function() {
                    return [];
                }
            },
            selectedDiseasesData: {
                type: Array,
                value: function() {
                    return [];
                }
            },
            associatedGenes: {
                type: Object,
                value: function() {
                    return {};
                }
            },
            geneTab: {
                type: String,
                value: ''
            },
            geneColumns: {
                type: Array,
                value: function() {
                    return [];
                }
            },
            mutationTab: {
                type: String,
                value: 'gv'
            },
            mutationColumns: {
                type: Array,
                value: function() {
                    return [];
                }
            },
            mutationData: {
                type: Array,
                value: function() {
                    return [];
                }
            },
            defaultStudy: {
                type: Object,
                value: function() {
                    return {};
                }
            },
            teamConfigFolder: {
                type: Object,
                value: function() {
                    return {};
                }
            },
            showPanel: {
                type: Object,
                value: function() {
                    return {};
                },
                observer: 'handleShowPanel'
            },
            dataListPhenotype: {
                type: Array,
                value: function() {
                    return [];
                }
            },
            panelConfig: {
                type: Object,
                value: function() {
                    return {};
                },
                observer: 'panelsChanged'
            },
            panelsNotArchived: {
                type: Array,
                value: function() {
                    return [];
                }
            },
            selectedPanel: {
                type: Object,
                value: function() {
                    return {};
                }
            },
            genes: {
                type: Array,
                value: function() {
                    return [];
                }
            },
            mutations: {
                type: Array,
                value: function() {
                    return [];
                }
            },
            panelAppDiseases: {
                type: Array,
                value: function() {
                    return [];
                }
            },
            panelAppGenes: {
                type: Array,
                value: function() {
                    return [];
                }
            },
            editingPanel: {
                type: Object,
                value: function() {
                    return {};
                }
            },
            bedBioformat: {
                type: Object,
                value: {
                    text: "BED",
                    value: "BED",
                    validator: BEDValidator
                }
            },
            vcfBioformat: {
                type: Object,
                value: {
                    text: "VCF 4.0",
                    value: "VARIANT",
                    validator: VCFValidator
                }
            },
            percent: {
                type: Number,
                value: 0
            },
            textbar: {
                type: String,
                value: 'Adding mutations...'
            },
        },
        observers: [
            "handleUpdatedGenes(formData.modCount)",
            "handleUpdatedMutations(formData.mutations.splices)",
            "handleUpdatedSelectedDiseases(formData.diseases.splices)"
        ],

        panelsChanged: function(neo, old) {
            if (neo.panels) {
                this.panelsNotArchived = [];
                for (var i = 0; i < neo.panels.length; i++) {
                    var panel = neo.panels[i];
                    if (!panel.archived) {
                        this.push('panelsNotArchived', panel);
                    }
                }
            }
        },
        handleUpdatedSelectedDiseases: function(neo, old, path) {
            if (neo) {
                this.$.selectedDiseases.refresh();
            }
        },
        handleUpdatedMutations: function(neo, old, path) {
            if (neo) {
                this.$.mutationTable.refresh();
            }
        },
        handleUpdatedGenes: function(neo, old, path) {
            if (neo) {
                this.$.geneTable.refresh();
            }
        },
        handleRemoveDisease: function(e) {
            var disease = e.detail.row;
            this.formData.removeGenesFromDisease(disease);
            this.formData.removeMutationsFromDisease(disease);
        },

        ready: function() {
            this.panelAppDiseases = BIOINFO_TEAM_PANELAPP_DISEASES;

            var me = this;

            var lastQuery = '';

            this.formData = new Panel();
            this.formData.polymer = this;
            this.formData.genes = [];

            // TEST CODE
            // this.formData.name = "test";
            // this.$.jsoFormWizard.goToStep(4);

            this.$.allDiseases.setLoading(true);

            if (localStorage.bioinfo_team_diseases) {

                this.allDiseasesData = JSON.parse(localStorage.bioinfo_team_diseases);

            } else {
                $.ajax({
                    url: "http://bioinfodev.hpc.cam.ac.uk/cellbase-legacy/webservices/rest/v3/hsapiens/feature/clinical/phenotype-gene?include=clinvar,gwas",
                    //only in cellbase v3
                    dataType: 'json',
                    async: false,
                    success: function(response, textStatus, jqXHR) {
                        try {
                            var data = response.response;
                            var clinvar = data[0].result;
                            var gwas = data[1].result;

                            var diseases = [];

                            //                            for (var i = 0; i < 100; i++) {
                            for (var i = 0; i < clinvar.length; i++) {
                                var dis = clinvar[i];
                                dis.source = "clinvar";
                                diseases.push(dis);
                            }
                            //                            for (var i = 0; i < 100; i++) {
                            for (var i = 0; i < gwas.length; i++) {
                                var dis = gwas[i];
                                dis.source = "gwas";
                                diseases.push(dis);
                            }

                            diseases.sort(function(a, b) {
                                return a.phenotype.localeCompare(b.phenotype);
                            });

                            if (diseases.length > 0) {
                                me.allDiseasesData = diseases;
                                localStorage.bioinfo_team_diseases = JSON.stringify(diseases);
                            }

                        } catch (e) {

                        }

                    }
                });

            }

            this.$.allDiseases.setLoading(false);

            this.allDiseaseColumns = [{
                name: 'phenotype',
                title: 'Phenotype',
                type: 'text',
                width: 325
            }, {
                name: 'source',
                title: 'Source',
                type: 'select',
                options: ["clinvar", "gwas"],
                width: 125
            }];
            this.diseaseColumns = [{
                name: 'phenotype',
                title: 'Phenotype',
                type: 'text',
                width: 310
            }, {
                name: 'source',
                title: 'Source',
                type: 'select',
                options: ["clinvar", "gwas"],
                width: 110
            }, {
                name: '',
                title: '',
                type: 'action',
                width: 30
            }];
            this.geneTab = 'text';
            this.geneColumns = [{
                name: 'name',
                title: 'Name',
                width: 120
            }, {
                name: 'chr',
                title: 'Chr',
                defaultValue: '.',
                width: 80
            }, {
                name: 'start',
                title: 'Start',
                defaultValue: '.',
                width: 110
            }, {
                name: 'end',
                title: 'End',
                defaultValue: '.',
                width: 110
            }, {
                name: '',
                title: '',
                type: 'action',
                width: 50
            }];

            this.mutationColumns = [{
                name: 'chr',
                title: 'Chr',
                width: 40
            }, {
                name: 'pos',
                title: 'Pos',
                width: 65
            }, {
                name: 'ref',
                title: 'Ref',
                width: 55
            }, {
                name: 'alt',
                title: 'Alt',
                width: 55
            }, {
                name: 'phe',
                title: 'Phenotype',
                width: 150
            }, {
                name: 'src',
                title: 'Source',
                width: 55
            }, {
                name: '',
                title: '',
                type: 'action',
                width: 50
            }];

            this.panelAppGenesColumns = [{
                name: "GeneSymbol",
                title: "Gene",
                width: 180
            }, {
                name: "LevelOfConfidence",
                title: "Level Of Confidence",
                width: 170
            }];
            this.panelAppDiseasesColumns = [{
                name: 'Name',
                title: 'Disease',
                width: 220

            }, {
                name: 'Number_of_Genes',
                title: 'NºGenes',
                width: 100
            }, {
                name: 'CurrentVersion',
                title: 'Version',
                width: 100
            }];

        },
        _setQuickSearchMenu: function(query) {
            this.dataListPhenotype = [];
            //            this.splice('dataListPhenotype',0,this.dataListPhenotype.length);
            for (var i = 0; i < this.allDiseasesData.length; i++) {
                var row = this.allDiseasesData[i];
                var disName = row.phenotype.toUpperCase();
                if (disName.indexOf(query) >= 0) {
                    this.push('dataListPhenotype', row);
                }
            }
        },

        collapseMenu: function(menuHidden, searchingFlag) {
            return menuHidden || searchingFlag;
        },
        hideProjectList: function(menuHidden, searchingFlag) {
            return menuHidden || searchingFlag;
        },

        handleSelectedRows: function(neo, old) {
            return neo;
        },
        handleAddSelectedDiseases: function() {
            if (this.currentSelectedDiseasesData.length > 0) {
                var me = this;
                var auxDisease = [];
                this.$.selectedDiseases.setLoading(true);
                this.$.progressBar.hidden = false;
                me.$.progressDiv.hidden = false;

                me.formData.addDiseases(me.currentSelectedDiseasesData, function(err) {
                    if (err == null) {
                        me.$.selectedDiseases.set("data", me.formData.diseases);
                        me.$.geneTable.set("data", me.formData.genes);
                        me.$.mutationTable.set("data", me.formData.mutations);
                        me.$.selectedDiseases.setLoading(false);
                        me.$.progressBar.hidden = true;
                        me.$.progressDiv.hidden = true;
                    } else {
                        this.formData.clearDiseases();
                        this.$.selectedDiseases.set("data", this.formData.diseases);
                        this.formData.clearGenes();
                        this.$.geneTable.set("data", this.formData.genes);
                        this.formData.clearMutations();
                        this.$.mutationTable.set("data", this.formData.mutations);
                        new StvDialog().alert(err);
                    }
                });

            } else {
                new StvDialog().alert('No disease selected.');
            }
        },
        handleClearSelectedDiseases: function() {
            this.formData.clearDiseases();
            this.$.selectedDiseases.set("data", this.formData.diseases);
        },
        handleHiddenGeneText: function(geneTab) {
            return geneTab != 'text';
        },
        handleHiddenGeneBed: function(geneTab) {
            return geneTab != 'bed';
        },
        handleHiddenGenePanel: function(geneTab) {
            return geneTab != 'panel';
        },
        handleClickGeneText: function(e) {
            this.geneTab = 'text';
        },
        handleClickGeneBed: function(e) {
            this.geneTab = 'bed';
        },
        handleClickGenePanel: function(e) {
            this.geneTab = 'panel';
        },
        handleClickGeneTextAreaButton: function(e) {
            var geneName;
            var me = this;
            var textAreaValue = this.$.geneTextArea.value.toUpperCase();
            var splits = textAreaValue.split(/,|\n/);

            var genesQuery = [];

            for (var i = 0; i < splits.length; i++) {
                geneName = splits[i];
                if (geneName != '') {
                    var re = /^(\w+):(\d+)-(\d+)$/;
                    if (re.test(geneName)) {
                        var groups = geneName.match(re);
                        var chr = groups[1];
                        var start = parseInt(groups[2]);
                        var end = parseInt(groups[3]);
                        if (start > end) {
                            new StvDialog().alert("Malformed Region: " + geneName + ", END must be greater than or equal to START");
                            return;
                        } else {
                            var gene = {
                                name: geneName,
                                chr: chr,
                                start: start,
                                end: end
                            };
                            me.formData.addGene(gene);
                        }
                    } else {
                        genesQuery.push(geneName);
                    }
                }
            }

            if (genesQuery.length > 0) {
                Utils.applyFunctionBatch(genesQuery, 100, function(array) {
                    CellBaseManager.get({
                        species: 'hsapiens',
                        category: 'feature',
                        subCategory: 'gene',
                        resource: 'info',
                        async: false,
                        query: array.join(","),
                        params: {
                            include: "name,chromosome,start,end"
                        },
                        success: function(data) {
                            if (data.response && data.response.length > 0) {
                                for (var i = 0; i < data.response.length; i++) {
                                    var elem = data.response[i];
                                    if (elem.result.length > 0) {
                                        for (var j = 0; j < elem.result.length; j++) {
                                            var row = data.response[i].result[j];
                                            var gene = {
                                                name: row.name,
                                                chr: row.chromosome,
                                                start: row.start,
                                                end: row.end
                                            };
                                            me.formData.addGene(gene);
                                        }
                                    } else {
                                        // me.formData.addGene({
                                        //     name: elem.id
                                        // });
                                        new StvDialog().alert("Gene/Region '" + geneName + "' not exits");
                                    }
                                }
                            }
                        }
                    });
                });
            }
            me.$.geneTable.set("data", me.formData.genes);
            this.$.geneTextArea.value = '';
        },
        handleGenesImportBed: function(bed_file) {
            this.$.geneTable.setLoading(true);
            // debugger
            var me = this;
            setTimeout(function() {
                var log = [];
                var line = 0;
                var genes = [];

                if (bed_file != null) {

                    var _navigator = new LineNavigator(bed_file);
                    var indexToStartWith = 0;

                    _navigator.readSomeLines(indexToStartWith, function linesReadHandler(err, index, lines, eof, progress) {
                        if (err) {
                            return;
                        }
                        console.log(lines.length);

                        for (var i = 0; i < lines.length; i++) {
                            var l = lines[i];

                            if ((l.indexOf("#") < 0 && l.indexOf("browser") < 0 && l.indexOf("track") < 0) && l != '') {
                                var fields = l.split("\t");
                                var chr = fields[0];
                                var start = fields[1];
                                var end = fields[2];
                                var gene = {
                                    name: chr + ":" + start + "-" + end,
                                    chr: chr,
                                    start: start,
                                    end: end
                                };
                                genes.push(gene);
                                // me.formData.addGene(gene);
                            }
                            line++;
                        }
                        if (eof) {
                            if (genes.length > 0) {
                                var panelGenes = me.formData.addAllGenes(genes);
                                me.set('formData.genes', panelGenes);
                                me.$.geneTable.set("data", me.formData.genes);
                                me.$.geneTable.setLoading(false);
                            }
                            return;
                        }
                        _navigator.readSomeLines(index + lines.length, linesReadHandler);
                    })
                } else {
                    me.$.geneTable.setLoading(false);
                }
            }, 50);
        },
        handleImportAppPanel: function(e) {
            this.$.appPanel.hidden = false;
        },
        handleClickGeneListClear: function(e) {
            this.formData.clearGenes();
            this.$.geneTable.set("data", this.formData.genes);
        },
        handleClickMutationGV: function(e) {
            this.mutationTab = 'gv';
        },
        handleClickMutationVCF: function(e) {
            this.mutationTab = 'vcf';
        },
        handleClickMutationCSV: function(e) {
            this.mutationTab = 'csv';
        },
        handleClickMutationPanel: function(e) {
            this.mutationTab = 'panel';
        },
        handleHiddenMutationGV: function(mutationTab) {
            return mutationTab != 'gv';
        },
        handleHiddenMutationVCF: function(mutationTab) {
            return mutationTab != 'vcf';
        },
        handleHiddenMutationCSV: function(mutationTab) {
            return mutationTab != 'csv';
        },
        handleHiddenMutationPanel: function(mutationTab) {
            return mutationTab != 'panel';
        },
        handleMutationImportVCF: function(vcf_file) {
            var me = this;
            this.$.mutationTable.setLoading(true);
            var phe = this.$.mutationGVPheVCF.value;
            if (phe == "") {
                new StvDialog().alert("Phenotype is mandatory");
                return;
            }
            var src = "user-defined";
            setTimeout(function() {
                var log = [];
                var line = 0;

                if (vcf_file != null) {

                    var _navigator = new LineNavigator(vcf_file);
                    var indexToStartWith = 0;

                    _navigator.readSomeLines(indexToStartWith, function linesReadHandler(err, index, lines, eof, progress) {
                        if (err) {
                            return;
                        }
                        console.log(lines.length);
                        for (var i = 0; i < lines.length; i++) {
                            var l = lines[i];
                            if (l.indexOf("#") < 0 && l != '') {
                                var fields = l.split("\t");
                                var chr = fields[0];
                                var pos = fields[1];
                                var ref = fields[3];
                                var alt = fields[4];

                                var mut = {
                                    chr: chr,
                                    pos: pos,
                                    ref: ref,
                                    alt: alt,
                                    phe: phe,
                                    src: src
                                };
                                me.formData.addMutation(mut);
                            }
                            line++;
                        }
                        if (eof) {
                            me.$.mutationTable.set("data", me.formData.mutations);
                            me.$.mutationTable.setLoading(false);
                            return;
                        }
                        _navigator.readSomeLines(index + lines.length, linesReadHandler);
                    })
                } else {
                    me.$.mutationTable.setLoading(false);
                }
            }, 50);
        },
        handleMutationImportCSV: function(e) {
            var me = this;
            this.$.mutationTable.setLoading(true);
            var csv_file = this.$.mutationCSVFileInput.files[0];
            var src = "user-defined";
            setTimeout(function() {
                var log = [];
                var line = 0;

                if (csv_file != null) {
                    var separator = me.$.mutationCSVSeparator.selectedOption.value;
                    separator = (separator === "tab") ? '\t' : separator;
                    var ignoreHeader = me.$.mutationCSVHeader.checked;

                    var _navigator = new LineNavigator(csv_file);
                    var indexToStartWith = 0;

                    _navigator.readSomeLines(indexToStartWith, function linesReadHandler(err, index, lines, eof, progress) {
                        if (err) {
                            return;
                        }
                        console.log(lines.length);

                        for (var i = 0; i < lines.length; i++) {
                            var l = lines[i];
                            if (ignoreHeader) {
                                ignoreHeader = false;
                            } else {

                                var fields = l.split(separator);
                                var chr = fields[0];
                                var pos = fields[1];
                                var ref = fields[2];
                                var alt = fields[3];
                                var phe = fields[4];
                                var mut = {
                                    chr: chr,
                                    pos: pos,
                                    ref: ref,
                                    alt: alt,
                                    phe: phe,
                                    src: src
                                }
                                me.formData.addMutation(mut);
                            }
                            line++;
                        }
                        if (eof) {
                            me.$.mutationTable.set("data", me.formData.mutations);
                            me.$.mutationTable.setLoading(false);
                            return;
                        }
                        _navigator.readSomeLines(index + lines.length, linesReadHandler);
                    })
                } else {
                    me.$.mutationTable.setLoading(false);
                }
            }, 50);
        },
        handleClickMutationListClear: function(e) {
            this.formData.clearMutations();
            this.$.mutationTable.set("data", this.formData.mutations);
        },
        handleMutationAdd: function(e) {

            var chr = this.$.mutationGVChr.value;
            var pos = this.$.mutationGVPos.value;
            var ref = this.$.mutationGVRef.value.toUpperCase();
            var alt = this.$.mutationGVAlt.value.toUpperCase();
            var phe = this.$.mutationGVPhe.value;

            var re = /^[ACTG]*$/;

            if (chr == "" || pos.length == 0 || phe == "") {
                new StvDialog().alert("Chromosome, Position and Phenotype are mandatory");
                return;
            } else if (ref == "" && alt == "") {
                new StvDialog().alert("Reference or Alternate is mandatory");
                return;
            } else if (!re.test(ref) || !re.test(alt)) {
                new StvDialog().alert("Reference and Alternate must contain only ACTG");
                return;
            }
            var src = "user-defined";
            var mut = {
                chr: chr,
                pos: pos,
                ref: ref,
                alt: alt,
                phe: phe,
                src: src
            };

            this.formData.addMutation(mut);
            this.$.mutationTable.set("data", this.formData.mutations);
            this.$.mutationGVChr.value = "";
            this.$.mutationGVPos.value = "";
            this.$.mutationGVRef.value = "";
            this.$.mutationGVAlt.value = "";
            this.$.mutationGVPhe.value = "";
        },
        handleClickSavePanel: function(e) {
            var me = this;
            this.formData.name = this.formData.name.replace(/[^a-zA-Z0-9._\-]/g, "_");
            // var re = /[¿\?\[\]<>\^\{\}\|#%"\\\\]/;
            // if (re.test(this.formData.name)) {
            //     new StvDialog().alert("The Panel name shouldn't have these characteres '¿ ? [ ] < > ^ { } | # % \\ \" ' ");
            //     return;
            // }
            if (this.formData.name == "") {
                new StvDialog().alert("The Panel name is mandatory");
                return;
            }
            for (var i = 0; i < this.panelConfig.panels.length; i++) {
                if (this.formData.name === this.panelConfig.panels[i].name) {
                    new StvDialog().alert("The Panel name already exists");
                    return;
                }
            }
            if (JSON.stringify(this.formData) === JSON.stringify(this.editingPanel)) {
                new StvDialog().alert("The panel hasn't been modified");
                return;
            }

            new StvDialog().confirm("Are you sure?", function(answer) {
                if (answer == true) {
                    if (me.defaultStudy && me.teamConfigFolder) {
                        //                    var content = pako.deflate(JSON.stringify(this.formData));
                        content = JSON.stringify(me.formData);
                        var separator = "-_-";
                        var fileName = "panel" + separator + me.formData.name + separator + me.formData.version;
                        var jsonPanelData = {
                            "name": me.formData.name,
                            "version": me.formData.version,
                            "archived": false,
                            "used": 0,
                            "fileId": null
                        };

                        me.uploadFile(content, fileName, me.defaultStudy.id, function(id) {
                            var _me = me;

                            var userData = _me.userData;

                            jsonPanelData.fileId = id;
                            _me.panelConfig.addPanelConfig(jsonPanelData);

                            _me.formData = new Panel();
                            _me.formData.polymer = this;

                            _me.$.jsoFormWizard.goToStep(1);
                            // var a = document.getElementById("manager");
                            // a.$.newPanelPanel.hidden = true;
                            new StvDialog().alert("The panel has been created succesfully");

                        });
                    }
                } else {
                    return;
                }
            });
        },
        uploadFile: function(fileContent, fileName, studyId, callback) {
            var url = OpencgaManager.files.upload({
                query: {
                    sid: Cookies("bioinfo_sid")
                },
                request: {
                    url: true
                }
            });
            var blob = new Blob([fileContent], {
                type: 'text/plain'
            });
            var formData = new FormData();

            var userId = Cookies("bioinfo_user");
            var studyId = studyId;
            var relativeFilePath = '.team_config/' + fileName;
            var fileFormat = 'GZIP';
            var bioFormat = 'NONE';
            var description = '';
            var chunkId = 0;

            formData.append('chunk_content', blob);
            formData.append('chunk_id', chunkId);
            formData.append('chunk_size', blob.size);
            /*formData.append('chunk_hash', hash);*/
            formData.append("filename", fileName);
            formData.append('userId', userId);
            formData.append('studyId', studyId);
            formData.append('relativeFilePath', relativeFilePath);
            /*formData.append('chunk_gzip', );*/
            formData.append("last_chunk", true);
            formData.append("total_size", blob.size);
            formData.append("fileFormat", fileFormat);
            formData.append("bioFormat", bioFormat);
            formData.append("description", description);

            var xhr = new XMLHttpRequest();
            xhr.open('POST', url, false);

            xhr.onload = function(e) {
                var response = JSON.parse(this.response);
                try {
                    var id = response.response[0].result[0].id;
                    callback(id);
                } catch (c) {

                }
                console.log('upload Done!');
            };
            xhr.send(formData);
        },
        handleShowPanel: function(neo, old) {
            if (neo.id) {
                this.formData = new Panel(neo);
                this.formData.polymer = this;
            }
        },
        handlePreviewFile: function(e) {
            var fileId;
            if (this.$.importGenesFromPanel.value != " ") {
                var panels = this.$.importGenesFromPanel.querySelectorAll("stv-option");
                for (var i = 0; i < panels.length; i++) {
                    if (this.$.importGenesFromPanel.value == panels[i].value) {
                        fileId = parseInt(panels[i].dataset.file);
                    }
                }
                var data;

                OpencgaManager.files.content({
                    id: fileId,
                    query: {
                        sid: Cookies('bioinfo_sid'),
                        limit: 100
                    },
                    request: {
                        async: false,
                        success: function(response) {
                            data = response;
                        },
                        error: function() {}
                    }
                });
                if (data) {
                    this.selectedPanel = JSON.parse(data);
                    this.$.panelPreview.hidden = false;
                }
            } else {
                new StvDialog().alert("No panel selected");
            }
        },
        handleImportGenesPanel: function(e) {
            this.$.geneTable.setLoading(true);
            var me = this;
            setTimeout(function() {
                if (me.$.importGenesFromPanel.value != " ") {
                    var fileId = parseInt(me.$.importGenesFromPanel.selectedOption.dataset.file);

                    for (var i = 0; i < me.panelsNotArchived.length; i++) {
                        var panel = me.panelsNotArchived[i];
                        if (panel.fileId === fileId) {
                            var panelContent = "";
                            OpencgaManager.files.content({
                                id: fileId,
                                query: {
                                    sid: Cookies('bioinfo_sid')
                                },
                                request: {
                                    async: false,
                                    success: function(response) {
                                        panelContent = response;
                                    },
                                    error: function() {}
                                }
                            });
                            if (panelContent != "") {
                                me.selectedPanel = JSON.parse(panelContent);
                                if (me.selectedPanel.genes != "") {
                                    me.genes = me.selectedPanel.genes;
                                } else {
                                    new StvDialog().alert("The selected panel hasn't got genes");
                                    me.$.geneTable.setLoading(false);
                                    return;
                                }
                            }
                        }
                    }
                    var panelGenes = me.formData.addAllGenes(me.genes);
                    me.set('formData.genes', panelGenes);
                    me.$.geneTable.set("data", me.formData.genes);
                    me.$.geneTable.setLoading(false);
                } else {
                    new StvDialog().alert("No panel selected");
                    me.$.geneTable.setLoading(false);
                    return;
                }
            }, 50);
            // this.$.importGenesFromPanel.value = " ";
        },
        handlePreviewFileMut: function(e) {
            var fileId;
            if (this.$.importMutationsFromPanel.value != " ") {
                var panels = this.$.importMutationsFromPanel.querySelectorAll("stv-option");
                for (var i = 0; i < panels.length; i++) {
                    if (this.$.importMutationsFromPanel.value == panels[i].value) {
                        fileId = parseInt(panels[i].dataset.file);
                    }
                }
                var data;
                OpencgaManager.files.content({
                    id: fileId,
                    query: {
                        sid: Cookies('bioinfo_sid'),
                        limit: 100
                    },
                    request: {
                        async: false,
                        success: function(response) {
                            data = response;
                        },
                        error: function() {}
                    }
                });
                if (data) {
                    this.selectedPanel = JSON.parse(data);
                    this.$.panelPreviewMut.hidden = false;
                }
            } else {
                new StvDialog().alert("No panel selected");
            }
        },
        handleImportMutationsPanel: function(e) {
            var me = this;
            this.$.mutationTable.setLoading(true);
            setTimeout(function() {
                    if (me.$.importMutationsFromPanel.value != " ") {
                        var fileId = parseInt(me.$.importMutationsFromPanel.selectedOption.dataset.file);
                        for (var i = 0; i < me.panelsNotArchived.length; i++) {
                            var panel = me.panelsNotArchived[i];
                            if (panel.fileId === fileId) {
                                var panelContent = "";
                                OpencgaManager.files.content({
                                    id: fileId,
                                    query: {
                                        sid: Cookies('bioinfo_sid')
                                    },
                                    request: {
                                        async: false,
                                        success: function(response) {
                                            panelContent = response;
                                        },
                                        error: function() {}
                                    }
                                });
                                if (panelContent != "") {
                                    me.selectedPanel = JSON.parse(panelContent);
                                    if (me.selectedPanel.mutations != "") {
                                        me.mutations = me.selectedPanel.mutations;
                                    } else {
                                        new StvDialog().alert("The selected panel hasn't got mutations");
                                        me.$.mutationTable.setLoading(false);
                                        return;
                                    }
                                }
                            }
                        }
                        for (var i = 0; i < me.mutations.length; i++) {
                            var mut = me.mutations[i];
                            if (mut["src"] == null) {
                                var src = "user-defined";
                            } else {
                                src = mut["src"];
                            }
                            mut = {
                                chr: mut["chr"],
                                pos: mut["pos"],
                                ref: mut["ref"],
                                alt: mut["alt"],
                                phe: mut["phe"],
                                src: src
                            };
                            me.formData.addMutation(mut);
                        }
                        me.$.mutationTable.set("data", me.formData.mutations);
                        me.$.mutationTable.setLoading(false);
                    } else {
                        new StvDialog().alert("No panel selected");
                        me.$.mutationTable.setLoading(false);
                        return;
                    }
                }, 50)
                // this.$.importMutationsFromPanel.value = " ";
        },

        handleOpenGV: function(e) {
            this.$.panelGV.hidden = false;
        },
        handleAddedMutationFromGV: function(e) {
            this.$.panelGV.hidden = true;
            var mut = e.detail;
            var src = "user-defined";
            mut = {
                chr: mut["chr"],
                pos: mut["pos"],
                ref: mut["ref"],
                alt: mut["alt"],
                phe: mut["phe"],
                src: src
            };
            this.formData.addMutation(mut);
            this.$.mutationTable.set("data", this.formData.mutations);
        },
        handlePanelAppSelected: function(e) {
            var me = this;
            this.$.panelAppSelectedGenes.selected = [];
            var selectedPanelAppDisease = e.detail.length > 0 ? e.detail[0] : {};

            if (selectedPanelAppDisease.Name && selectedPanelAppDisease.Name !== "") {

                var query = "https://bioinfo.extge.co.uk/crowdsourcing/WebServices/get_panel/" + selectedPanelAppDisease.Name + "/?format=json"

                $.ajax({
                    url: query,
                    dataType: 'json',
                    async: false,
                    success: function(response, textStatus, jqXHR) {
                        me.panelAppGenes = response.result.Genes;
                    }
                });
            }
        },
        handlePanelAppAddGenes: function(e) {
            var me = this;
            this.$.geneTable.setLoading(true);
            setTimeout(function() {
                var lowLevel = false;
                for (var i = 0; i < me.$.panelAppSelectedGenes.selected.length; i++) {
                    var elem = me.$.panelAppSelectedGenes.selected[i];
                    // lowLevel |= (elem.LevelOfConfidence <= 2) ? true : false;
                    if (elem.LevelOfConfidence == 'LowEvidence') {
                        lowLevel = true;
                    }
                }
                if (lowLevel) {
                    new StvDialog().confirm("Your selection contains genes with low level of confidence. Do you want to continue?", function(answer) {
                        if (answer == true) {
                          me._addGenesPanelApp(me.$.panelAppSelectedGenes.selected);
                        } else {
                            return;
                        }

                    });
                } else {
                    if (me.$.panelAppSelectedGenes.selected.length == 0) {
                        new StvDialog().alert("Any selected gene");
                        me.$.geneTable.setLoading(false);
                        return;
                    }else{
                      me._addGenesPanelApp(me.$.panelAppSelectedGenes.selected);
                    }
                }
            }, 50)
        },
        _addGenesPanelApp: function(sgenes){
              this.errorAddGenes = "";
              var geneName = [];
              for (var i = 0; i < sgenes.length; i++) {
                  geneName[i] = sgenes[i].GeneSymbol;
              }
              geneName = geneName.join(",");
              // var me = this;
              var genes = [];
              CellBaseManager.get({
                  species: 'hsapiens',
                  category: 'feature',
                  subCategory: 'gene',
                  resource: 'info',
                  async: false,
                  query: geneName,
                  params: {
                      include: "name,chromosome,start,end"
                  },
                  success: function(data) {

                      if (data.response && data.response.length > 0) {

                          for (var i = 0; i < data.response.length; i++) {
                              var elem = data.response[i];
                              if (elem.result.length > 0) {
                                  var row = data.response[i].result[0];
                                  var gene = {
                                      name: row.name,
                                      chr: row.chromosome,
                                      start: row.start,
                                      end: row.end
                                  };
                                  // me.formData.addGene(gene);
                                  genes.push(gene);
                              } else {
                                  // me.formData.addGene({
                                  //     name: elem.id
                                  // });
                                  genes.push({
                                      name: elem.id
                                  });
                              }
                          }
                      }
                  }
              });
              var panelGenes = this.formData.addAllGenes(genes);
              this.set('formData.genes', panelGenes);
              this.$.geneTable.set("data", this.formData.genes);
              this.$.appPanel.hidden = true;
              this.panelAppGenes = "";
              this.$.panelAppSelectedGenes.selected = [];
              this.$.panelAppSelectedDisease.selected = [];
              this.$.geneTable.setLoading(false);
        },
        handlePanelAppSelectedGen: function(e) {
            this.errorAddGenes = "";
        },
        addFromPanelManager: function(selectedPanel, op) {
            // this.set('formData.name', (selectedPanel.name + "_2"));
            // this.set('formData.version', (selectedPanel.version + 1));
            // this.set('formData.id',Utils.genId("Panel"));
            this.set('formData', selectedPanel);
            this.editingPanel = Utils.clone(this.formData);
            this.$.selectedDiseases.set("data", this.formData.diseases);
            this.$.geneTable.set("data", this.formData.genes);
            this.$.mutationTable.set("data", this.formData.mutations);
            this.formData.polymer = this;
            // var aux = this.$.personalData.querySelectorAll("input");
            if (op == "edit") {
                //     aux[0].disabled = true;
                //     aux[1].disabled = true;
                this.set('formData.name', (selectedPanel.name + "_2"));
                if (this.formData.used == true) {
                    this.$.saveAsPanel.hidden = false;
                    this.$.savePanel.hidden = true;
                } else {
                    this.$.saveAsPanel.hidden = true;
                    this.$.savePanel.hidden = false;
                }
            } else if (op == "new") {
                //   aux[0].disabled = false;
                // aux[1].disabled = false;
                this.$.saveAsPanel.hidden = true;
                this.$.savePanel.hidden = false;
            }
        },
        showImportBEDComponent: function() {
            this.$.importBEDComponent.hidden = false;
        },
        handleImportBEDFile: function() {
            var file = this.$.importBEDFile.$.fileInput.files[0];

            if (!(this.$.importBEDFile.$.validator.errorCount > 0)) {
                this.handleGenesImportBed(file);
                this.$.importBEDComponent.hidden = true;
            }
        },
        showImportVCFComponent: function() {
            if (this.$.mutationGVPheVCF.value != "") {
                this.$.importVCFComponent.hidden = false;
            } else {
                new StvDialog().alert("Phenotype is mandatory");
                return;
            }
        },
        handleImportVCFFile: function() {
            var file = this.$.importVCFFile.$.fileInput.files[0];

            if (!(this.$.importVCFFile.$.validator.errorCount > 0)) {
                this.handleMutationImportVCF(file);
                this.$.mutationGVPheVCF.value = "";
                this.$.importVCFComponent.hidden = true;
            }
        },
    });
</script>
