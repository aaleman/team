<link rel="import" href="../../lib/jsorolla/src/lib/components/table/jso-table.html">

<dom-module id="team-panel-form-wizard">
    <style>
        :host {
            display: block;
            position: relative;
            box-sizing: border-box;
            height: 600px;
            width: 100%;
        }

        #wizard-content {
            height: calc(100% - 40px);
        }

        #wizard-bottom {
            box-sizing: border-box;
            height: 40px;
            padding: 7px 10px;
            background-color: var(--light-secondary-color);
            border-top: 1px solid var(--divider-color);
        }

        #wizard-bottom > div {
            margin-left: 10px;
            width: 120px;
        }

        .step {
            padding: 10px;
        }

        .step-title {
            padding-bottom: 15px;
            text-align: center;
            vertical-align: middle;
            font-size: 16pt;
        }

        .step-content {
            height: 100%;
            margin-top: 10px;
        }

        #genes-tab {
            height: 80%;
            width: 40%;
            border: 1px solid #d3d3d3;
        }

        #genes-list {
            height: 80%;
            width: 55%;
            margin: 0 auto;
            border: 1px solid #d3d3d3;
        }

        .genes-tab-container-elem {
            margin: 20px;
        }

        #mutations-tab {
            height: 80%;
            width: 50%;
            border: 1px solid #d3d3d3;
        }

        #mutations-list {
            height: 80%;
            width: 45%;
            margin: 0 auto;
            border: 1px solid #d3d3d3;
        }

        #personalData {
            border: 1px solid #d3d3d3;
            padding: 10px;
        }

        .disease {
            width: 45%;
            height: 450px;
            margin: 0 auto;
            border: 1px solid #d3d3d3;
        }

        jso-table {
            height: 450px;
        }

        .next {
            text-align: right;
            color: #6B6B6B;
        }

        .prev {
            text-align: left;
            color: #6B6B6B;
        }

        #panelPreview .container {
            width: 800px;
            height: 600px;
            overflow-y: auto;
            overflow-x: auto;
        }

        #panelPreviewMut .container {
            width: 800px;
            height: 600px;
            overflow-y: auto;
            overflow-x: auto;
        }

        .file {
            text-align: center;
            color: #445D76;
            margin-top: 5px;
            width: 100px;
        }

        .sgenesTextArea {
            box-sizing: border-box;
            width: 100%;
            height: 40px;
            resize: none;
        }

        .data {
            color: #666;
            margin-top: 2px;
        }

        .input {
            width: 100px;
            height: 15px;
        }

        .eye > i:hover {
            color: #666;
            cursor: pointer;
        }

        .next > i:hover {
            color: #445D76;
            cursor: pointer;
        }

        .prev > i:hover {
            color: #445D76;
            cursor: pointer;
        }


    </style>
    <template>
        <div id="wizard-content">

            <div class="step vertical layout" hidden$="{{handleHiddenStep1(step)}}" id="step1">
                <div class="jso-formtitle horizontal layout">
                    <div class="flex"> </div>
                    <div class="step-title">Step 1: Diseases</div>
                    <div class="flex next" on-click="handleNextStepButton"><i>Step 2 &nbsp;</i><i class="fa fa-angle-double-right"></i></div>
                </div>
                <div class="step-content horizontal layout">
                    <div class="disease">
                        <jso-table id="allDiseases" class="disease-left" columns="{{allDiseaseColumns}}" data="{{allDiseasesData}}" selected="{{currentSelectedDiseasesData}}" enable-select enable-filter></jso-table>
                        <div class="jso-btn jso-btn-shdw file" on-click="handleAddSelectedDiseases"><i class="fa fa-plus-square-o"></i>&nbsp; Add
                        </div>
                    </div>
                    <div class="disease">
                        <jso-table id="selectedDiseases" columns="{{diseaseColumns}}" on-removerow="handleRemoveDisease" data="{{formData.diseases}}"></jso-table>
                        <div class="jso-btn jso-btn-shdw file" on-click="handleClearSelectedDiseases">
                            Clear
                        </div>
                    </div>
                </div>
            </div>


            <div class="step vertical layout" id="step2" hidden$={{handleHiddenStep2(step)}}>
                <div class="jso-formtitle horizontal layout">
                    <div class="prev flex" on-click="handlePrevStepButton"><i class="fa fa-angle-double-left"></i><i>&nbsp; Step 1</i></div>
                    <div class="step-title">Step 2: Genes</div>
                    <div class="flex next" on-click="handleNextStepButton"><i>Step 3 &nbsp;</i><i class="fa fa-angle-double-right"></i></div>
                </div>
                <div class="step-content horizontal layout">

                    <div id="genes-tab" class="vertical layout">

                        <div class="jso-formtitle" style="font-size:14px;">Genes/Regions &nbsp;</div>
                        <div class="jso-formcontent">
                            <textarea class="jso sgenesTextArea" name="geneTextArea" id="geneTextArea" rows="3" placeholder="BRCA2,PPL"></textarea>
                            <div class="jso-btn jso-btn-shdw file" on-click="handleClickGeneTextAreaButton"><i class="fa fa-plus-square-o"></i>&nbsp; Add Genes</div>
                        </div>
                        <div class="jso-formtitle" style="font-size:14px;">Import from BED &nbsp;</div>
                        <div class="jso-formcontent">
                            <input type="file" id="geneBedFileInput">
                            <div class="jso-btn jso-btn-shdw file" on-click="handleGenesImportBed"><i class="fa fa-plus-square-o"></i>&nbsp; Import</div>
                        </div>
                        <div class="jso-formtitle" style="font-size:14px;">Import from other Panel &nbsp;</div>
                        <div class="jso-formcontent">
                            <select id="importGenesFromPanel">
                                <option value="none"> </option>
                                <template is="dom-repeat" items="{{panels}}">
                                    <option value$="{{item.file.id}}">{{item.name}}</option>
                                </template>
                            </select>
                            <span class="eye">&nbsp;<i class="fa fa-eye" on-click="handlePreviewFile"></i></span>
                            <div class="jso-btn jso-btn-shdw file" on-click="handleImportGenesPanel"><i class="fa fa-plus-square-o"></i>&nbsp; Import</div>
                        </div>
                    </div>

                    <div id="genes-list">
                        <jso-table id="geneTable" columns="{{geneColumns}}" data="{{formData.genes}}" enable-edit></jso-table>
                        <div class="jso-btn jso-btn-shdw file" style="margin:0 auto" on-click="handleClickGeneListClear">Clear</div>
                    </div>

                </div>
                <jso-panel modal closable hidden id="panelPreview">
                    <div class="header">
                        <i class="fa fa-book"></i> Panel Preview
                    </div>
                    <div class="container">
                        <!-- <pre> -->
                        <code class="wrapped-text">{{contentData}}</code>
                        <!-- </pre> -->
                    </div>
                </jso-panel>
            </div>

            <div class="step vertical layout" id="step3" hidden$={{handleHiddenStep3(step)}}>
                <div class="jso-formtitle horizontal layout">
                    <div class="prev flex" on-click="handlePrevStepButton"><i class="fa fa-angle-double-left"></i><i>&nbsp; Step 2</i></div>
                    <div class="step-title">Step 3: Mutations</div>
                    <div class="flex next" on-click="handleNextStepButton"><i>Step 4 &nbsp;</i><i class="fa fa-angle-double-right"></i></div>
                </div>
                <div class="step-content horizontal layout">
                    <div id="mutations-tab" flex>
                        <div class="jso-formtitle" style="font-size:14px;">Genomic Pos. &nbsp;</div>
                        <div class="jso-formcontent vertical layout" id="mutation-tab-config-gv">
                            <div class="horizontal layout data">
                                <label for="">Chr: &nbsp;</label>
                                <input class="input" type="text" name="mutationGVChr" id="mutationGVChr" />
                                <div class="flex"></div>
                                <label for="">Pos: &nbsp;</label>
                                <input class="input" type="text" name="mutationGVPos" id="mutationGVPos" />
                            </div>
                            <div class="horizontal layout data">
                                <label for="">Ref: &nbsp;&nbsp;</label>
                                <input class="input" type="text" name="mutationGVRef" id="mutationGVRef" />
                                <div class="flex"></div>
                                <label for="">Alt: &nbsp;</label>
                                <input class="input" type="text" name="mutationGVAlt" id="mutationGVAlt" />
                            </div>
                            <div class="horizontal layout data">
                                <label for="">Phe: &nbsp;</label>
                                <input class="input flex" type="text" name="mutationGVPhe" id="mutationGVPhe" list="dataListPhe" />
                                <datalist id="dataListPhe">
                                    <template is="dom-repeat" items="{{allDiseasesData}}">
                                        <option value="{{item.phenotype}}">{{item.phenotype}}</option>
                                    </template>
                                </datalist>
                            </div>

                            <div class="jso-btn jso-btn-shdw file" on-click="handleMutationAdd"><i class="fa fa-plus-square-o"></i>&nbsp; Add</div>
                            <jso-genome-viewer-element id="gv"></jso-genome-viewer-element>
                        </div>
                        <div class="jso-formtitle" style="font-size:14px;">Import VCF &nbsp;</div>
                        <div class="jso-formcontent" id="mutation-tab-config-vcf">
                            <input type="file" id="mutationVCFFileInput">
                            <div class="jso-btn jso-btn-shdw file" on-click="handleMutationImportVCF"><i class="fa fa-plus-square-o"></i>&nbsp; Import</div>
                        </div>
                        <div class="jso-formtitle" style="font-size:14px;">Import CSV &nbsp;</div>
                        <div class="jso-formcontent" id="mutation-tab-config-csv">
                            <div>
                                <label for="">Separator:</label>
                                <select name="mutationCSVSeparator" id="mutationCSVSeparator">
                                    <option value=";" selected>;</option>
                                    <option value=",">,</option>
                                    <option value="\t">Tab</option>
                                </select>
                            </div>
                            <div>
                                <label for="">Ignore first line (header):</label>
                                <input type="checkbox" name="mutationCSVHeader" id="mutationCSVHeader" value="ignore" checked/>
                            </div>
                            <input type="file" id="mutationCSVFileInput">
                            <div class="jso-btn jso-btn-shdw file" on-click="handleMutationImportCSV"><i class="fa fa-plus-square-o"></i>&nbsp; Import</div>

                        </div>
                        <div class="jso-formtitle" style="font-size:14px;">Import from other Panel &nbsp;</div>
                        <div class="jso-formcontent" id="mutation-tab-config-panel">
                            <select id="importMutationsFromPanel">
                                <option value="none"> </option>
                                <template is="dom-repeat" items="{{panels}}">
                                    <option value$="{{item.file.id}}">{{item.name}}</option>
                                </template>
                            </select>
                            <span class="eye">&nbsp; <i class="fa fa-eye" on-click="handlePreviewFileMut"></i></span>
                            <div class="jso-btn jso-btn-shdw file" on-click="handleImportMutationsPanel"><i class="fa fa-plus-square-o"></i>&nbsp; Import</div>
                        </div>
                    </div>
                    <div id="mutations-list" flex>
                        <jso-table id="mutationTable" columns="{{mutationColumns}}" data="{{formData.mutations}}" enable-edit></jso-table>
                        <div class="jso-btn jso-btn-shdw file" style="margin:0 auto" on-click="handleClickMutationListClear">Clear</div>
                    </div>
                </div>
                <jso-panel modal closable hidden id="panelPreviewMut">
                    <div class="header">
                        <i class="fa fa-book"></i> Panel Preview
                    </div>
                    <div class="container">
                        <!-- <pre> -->
                        <code class="wrapped-text">{{contentData}}</code>
                        <!-- </pre> -->
                    </div>
                </jso-panel>
            </div>

            <div class="step vertical layout" id="step4" hidden$={{handleHiddenStep4(step)}}>
                <div class="jso-formtitle horizontal layout">
                    <div class="prev flex" on-click="handlePrevStepButton"><i class="fa fa-angle-double-left"></i><i>&nbsp; Step 3</i></div>
                    <div class="step-title">Step 4: Panel Info</div>
                    <div class="flex"> </div>
                </div>
                <div class="step-content vertical layout" id="personalData">

                    <div class="horizontal layout data" style="line-height:10px;">
                        <div for="">Name: &nbsp; &nbsp; </div>
                        <input class="flex" type="text" value="{{formData.name::input}}" />
                    </div>
                    <div class="horizontal layout data" style="line-height:10px;">

                        <div for="">Author:&nbsp;</div>
                        <input class="flex" type="text" value="{{formData.author::input}}" />
                    </div>
                    <div class="horizontal layout data" style="line-height:10px;">

                        <div class="flex" for="">Date: </div>
                        <input style="text-align:right" type="date" value="{{formData.date::input}}" />
                    </div>

                    <div class="horizontal layout data" style="margin:3px;">
                        <div for="">Description: &nbsp; </div>
                        <textarea class="jso sgenesTextArea flex" style="height: 100px; width:100%;" name="" id="" cols="30" rows="10" value="{{formData.description::input}}"></textarea>
                    </div>

                    <div class="jso-btn jso-btn-shdw file" style="margin: 0 auto; margin-top:10px" on-click="handleClickSavePanel"><i class="fa fa-floppy-o"></i>&nbsp; Save</div>
                </div>
            </div>

        </div>
        <div id="wizard-bottom" class="horizontal layout end-justified">
            <div class="jso-btn jso-btn-shdw file" on-click="handlePrevStepButton" hidden="{{!handleHiddenStep1(step)}}"><i class="fa fa-angle-double-left"></i>&nbsp; Previous</div>
            <div class="jso-btn jso-btn-shdw file" on-click="handleNextStepButton" hidden="{{!handleHiddenStep4(step)}}">Next &nbsp;<i class="fa fa-angle-double-right"></i></div>
            <div hidden="{{handleHiddenStep4(step)}}"> &nbsp; </div>
        </div>
    </template>
</dom-module>
<script>
    Polymer({
        is: "team-panel-form-wizard",
        properties: {
            step: {
                type: Number,
                value: 1
            },
            maxSteps: {
                type: Number,
                value: 4
            },
            formData: {
                type: Object,
                value: function() {
                    return {};
                },
                notify: true
            },
            diseaseColumns: {
                type: Array,
                value: function() {
                    return [];
                }
            },
            selectedDiseases: {
                type: Array,
                value: function() {
                    return [];
                },
                notify: true,
                observer: 'handleSelectedRows'
            },
            currentSelectedDiseasesData: {
                type: Array,
                value: function() {
                    return [];
                }
            },
            selectedDiseasesData: {
                type: Array,
                value: function() {
                    return [];
                }
            },
            associatedGenes: {
                type: Object,
                value: function() {
                    return {};
                }
            },
            geneTab: {
                type: String,
                value: ''
            },
            geneColumns: {
                type: Array,
                value: function() {
                    return [];
                }
            },
            mutationTab: {
                type: String,
                value: 'gv'
            },
            mutationColumns: {
                type: Array,
                value: function() {
                    return [];
                }
            },
            mutationData: {
                type: Array,
                value: function() {
                    return [];
                }
            },
            defaultStudy: {
                type: Object,
                value: function() {
                    return {};
                }
            },
            teamConfigFolder: {
                type: Object,
                value: function() {
                    return {};
                }
            },
            showPanel: {
                type: Object,
                value: function() {
                    return {};
                },
                observer: 'handleShowPanel'
            },
            dataListPhenotype: {
                type: Array,
                value: function() {
                    return [];
                }
            },
            panels: {
                type: Array,
                value: function() {
                    return [];
                }
            },
            selectedPanel: {
                type: Object,
                value: function() {
                    return {};
                }
            },
            genes: {
                type: Array,
            },
            mutations: {
                type: Array,
            },

        },
        observers: [
            "handleUpdatedGenes(formData.modCount)",
            "handleUpdatedSelectedDiseases(formData.diseases.splices)",
            //            "handleUpdatedMutations(formData.mutations.splices)"
        ],


        handleUpdatedSelectedDiseases: function(neo, old, path) {

        },
        handleUpdatedGenes: function(neo, old, path) {
            if (neo) {
                this.$.geneTable.refresh();
            }
        },
        handleRemoveDisease: function(e) {
            var disease = e.detail.row;
            this.formData.removeGenesFromDisease(disease);
            this.formData.removeMutationsFromDisease(disease);

        },
        ready: function() {


            var me = this;

            var lastQuery = '';

            this.formData = new Panel();
            this.formData.polymer = this;

            this.$.allDiseases.setLoading(true);

            if (localStorage.bioinfo_team_diseases) {

                this.allDiseasesData = JSON.parse(localStorage.bioinfo_team_diseases);

            } else {
                $.ajax({
                    url: "http://bioinfodev.hpc.cam.ac.uk/cellbase/webservices/rest/v3/hsapiens/feature/clinical/phenotype-gene?include=clinvar,gwas",
                    dataType: 'json',
                    async: false,
                    success: function(response, textStatus, jqXHR) {
                        try {
                            var data = response.response;
                            var clinvar = data[0].result;
                            var gwas = data[1].result;

                            var diseases = [];

                            for (var i = 0; i < 100; i++) {
                                //for (var i = 0; i < clinvar.length; i++) {
                                var dis = clinvar[i];
                                dis.source = "clinvar";
                                diseases.push(dis);
                            }
                            for (var i = 0; i < 100; i++) {
                                //for (var i = 0; i < gwas.length; i++) {
                                var dis = gwas[i];
                                dis.source = "gwas";
                                diseases.push(dis);
                            }

                            diseases.sort(function(a, b) {
                                return a.phenotype.localeCompare(b.phenotype);
                            });


                            if (diseases.length > 0) {
                                me.allDiseasesData = diseases;
                                localStorage.bioinfo_team_diseases = JSON.stringify(diseases);
                            }


                        } catch (e) {

                        }

                    }
                });

            }
            this.$.allDiseases.setLoading(false);

            this.allDiseaseColumns = [{
                name: 'phenotype',
                title: 'Phenotype',
                type: 'text',
                width: 140
            }, {
                name: 'source',
                title: 'Source',
                type: 'select',
                options: ["clinvar", "gwas"],
                width: 120
            }];
            this.diseaseColumns = [{
                name: 'phenotype',
                title: 'Phenotype',
                type: 'text',
                width: 150
            }, {
                name: 'source',
                title: 'Source',
                type: 'select',
                options: ["clinvar", "gwas"],
                width: 100
            }, {
                name: '',
                title: '',
                type: 'action',
                width: 30
            }];
            this.geneTab = 'text';
            this.geneColumns = [{
                name: 'name',
                title: 'Name'
            }, {
                name: 'chr',
                title: 'Chr',
                defaultValue: '.'
            }, {
                name: 'start',
                title: 'Start',
                defaultValue: '.'
            }, {
                name: 'end',
                title: 'End',
                defaultValue: '.'
            }, {
                name: '',
                title: '',
                type: 'action',
                width: 30
            }];

            this.mutationColumns = [{
                name: 'chr',
                title: 'Chr',
                width: 40
            }, {
                name: 'pos',
                title: 'Pos'
            }, {
                name: 'ref',
                title: 'Ref',
                width: 70
            }, {
                name: 'alt',
                title: 'Alt',
                width: 70
            }, {
                name: 'phe',
                title: 'Phenotype'
            }, {
                name: '',
                title: '',
                type: 'action',
                width: 30
            }];


            //            this.$.mutationGVPhe.addEventListener('keyup', function (event) {
            //                        var query = this.value.toUpperCase();
            //                        if (query.length > 2 && lastQuery !== query && event.which !== 13) {
            //                            me._setQuickSearchMenu(query);
            //                            lastQuery = query;
            //                        }
            //                    }
            //            );

            var stepNumbers = this.getElementsByClassName("step-number");
        },
        _setQuickSearchMenu: function(query) {


            this.dataListPhenotype = [];
            //            this.splice('dataListPhenotype',0,this.dataListPhenotype.length);
            for (var i = 0; i < this.allDiseasesData.length; i++) {
                var row = this.allDiseasesData[i];
                var disName = row.phenotype.toUpperCase();
                if (disName.indexOf(query) >= 0) {
                    this.push('dataListPhenotype', row);
                }

            }
            console.log(this.dataListPhenotype);
        },
        handleHiddenStep1: function(step) {
            return step != 1;
        },
        handleHiddenStep2: function(step) {
            return step != 2;
        },
        handleHiddenStep3: function(step) {
            return step != 3;
        },
        handleHiddenStep4: function(step) {
            return step != 4;
        },
        collapseMenu: function(menuHidden, searchingFlag) {
            return menuHidden || searchingFlag;
        },
        hideProjectList: function(menuHidden, searchingFlag) {
            return menuHidden || searchingFlag;
        },
        handlePrevStepButton: function(e) {
            this.step = (this.step <= 1) ? 1 : this.step - 1;
            console.log(this.step);
        },
        handleNextStepButton: function(e) {
            this.step = (this.step >= this.maxSteps) ? this.maxSteps : this.step + 1;
        },
        handleSelectedRows: function(neo, old) {
            return neo;
        },
        handleAddSelectedDiseases: function() {

            var me = this;
            this.$.selectedDiseases.setLoading(true);
            setTimeout(function() {
                for (var i = 0; i < me.currentSelectedDiseasesData.length; i++) {
                    var row = me.currentSelectedDiseasesData[i];

                    if (!me.formData.containsDisease(row)) {
                        me.formData.addDisease(row);

                    }
                }
                me.$.selectedDiseases.setLoading(false);
            }, 50)
        },
        handleClearSelectedDiseases: function() {
            this.formData.clearDiseases();
        },

        handleHiddenGeneText: function(geneTab) {
            return geneTab != 'text';
        },
        handleHiddenGeneBed: function(geneTab) {
            return geneTab != 'bed';
        },
        handleHiddenGenePanel: function(geneTab) {
            return geneTab != 'panel';
        },
        handleClickGeneText: function(e) {
            this.geneTab = 'text';
        },
        handleClickGeneBed: function(e) {
            this.geneTab = 'bed';
        },
        handleClickGenePanel: function(e) {
            this.geneTab = 'panel';
        },
        handleClickGeneTextAreaButton: function(e) {

            var me = this;
            var textAreaValue = this.$.geneTextArea.value.toUpperCase();
            var splits = textAreaValue.split(",");

            for (var i = 0; i < splits.length; i++) {
                var geneName = splits[i];

                if (geneName != '') {

                    var re = /(\w+):(\d+)-(\d)+/;
                    if (re.test(geneName)) {
                        //                        var groups = re.match(geneName);
                        var groups = geneName.match(re);

                        var chr = groups[1];
                        var start = parseInt(groups[2]);
                        var end = parseInt(groups[3]);

                        if (start > end) {
                            alert("Malformed Region: " + geneName);
                        } else {
                            var gene = {
                                name: geneName,
                                chr: chr,
                                start: start,
                                end: end
                            };

                            me.formData.addGene(gene);
                        }
                    } else {

                        this.$.geneTable.setLoading(true);

                        setTimeout(function() {

                            CellBaseManager.get({
                                //  host: "http://bioinfodev.hpc.cam.ac.uk/cellbase/webservices/rest",
                                species: 'hsapiens',
                                category: 'feature',
                                subCategory: 'gene',
                                resource: 'info',
                                async: false,
                                query: geneName,
                                params: {
                                    include: "name,chromosome,start,end"
                                },
                                success: function(data) {

                                    if (data.response && data.response.length > 0) {

                                        for (var i = 0; i < data.response.length; i++) {
                                            var elem = data.response[i];
                                            if (elem.result.length > 0) {
                                                var row = data.response[i].result[0];
                                                var gene = {
                                                    name: elem.id,
                                                    chr: row.chromosome,
                                                    start: row.start,
                                                    end: row.end
                                                };
                                                me.formData.addGene(gene);

                                            } else {
                                                me.formData.addGene({
                                                    name: elem.id
                                                });
                                            }


                                        }
                                    }
                                }
                            });
                            me.$.geneTable.setLoading(false);
                        }, 50);
                    }
                }
            }
            this.$.geneTextArea.value = '';
        },
        handleGenesImportBed: function(e) {

            var me = this;
            var bed_file = this.$.geneBedFileInput.files[0];
            if (bed_file != null) {
                var reader = new FileReader();
                reader.onload = function(e) {
                    var data = e.target.result;
                    var lines = data.split("\n");
                    for (var i = 0; i < lines.length; i++) {
                        var line = lines[i];
                        if (line.indexOf("#") < 0 && line != '') {
                            var fields = line.split("\t");
                            var chr = fields[0];
                            var start = fields[1];
                            var end = fields[2];

                            var gene = {
                                name: chr + ":" + start + "-" + end,
                                chr: chr,
                                start: start,
                                end: end
                            };

                            me.formData.addGene(gene);
                        }
                    }
                };
                reader.readAsText(bed_file);
            }
        },

        handlePreviewFile: function(e) {

            var fileId = parseInt(this.$.importGenesFromPanel.value);

            var data;
            OpencgaManager.files.content({
                id: fileId,
                query: {
                    sid: Cookies('bioinfo_sid'),
                    limit: 100
                },
                request: {
                    async: false,
                    success: function(response) {
                        data = response;
                    },
                    error: function() {

                    }
                }
            });

            if (data) {
                this.contentData = data;
                this.$.panelPreview.hidden = false;
            }


        },
        handlePreviewFileMut: function(e) {

            var fileId = parseInt(this.$.importMutationsFromPanel.value);

            var data;
            OpencgaManager.files.content({
                id: fileId,
                query: {
                    sid: Cookies('bioinfo_sid'),
                    limit: 100
                },
                request: {
                    async: false,
                    success: function(response) {
                        data = response;
                    },
                    error: function() {

                    }
                }
            });

            if (data) {
                this.contentData = data;
                this.$.panelPreviewMut.hidden = false;
            }


        },


        handleClickGeneListClear: function(e) {
            this.formData.clearGenes();
        },
        handleClickMutationGV: function(e) {
            this.mutationTab = 'gv';
        },
        handleClickMutationVCF: function(e) {
            this.mutationTab = 'vcf';
        },
        handleClickMutationCSV: function(e) {
            this.mutationTab = 'csv';
        },
        handleClickMutationPanel: function(e) {
            this.mutationTab = 'panel';
        },
        handleHiddenMutationGV: function(mutationTab) {
            return mutationTab != 'gv';
        },
        handleHiddenMutationVCF: function(mutationTab) {
            return mutationTab != 'vcf';
        },
        handleHiddenMutationCSV: function(mutationTab) {
            return mutationTab != 'csv';
        },
        handleHiddenMutationPanel: function(mutationTab) {
            return mutationTab != 'panel';
        },
        handleMutationImportVCF: function(e) {

            var me = this;
            var vcf_file = this.$.mutationVCFFileInput.files[0];

            if (vcf_file != null) {

                var reader = new FileReader();

                reader.onload = function(e) {
                    var data = e.target.result;
                    var lines = data.split("\n");
                    for (var i = 0; i < lines.length; i++) {
                        var line = lines[i];
                        if (line.indexOf("#") < 0 && line != '') {
                            var fields = line.split("\t");
                            var chr = fields[0];
                            var pos = fields[1];
                            var ref = fields[3];
                            var alt = fields[4];

                            var mut = {
                                chr: chr,
                                pos: pos,
                                ref: ref,
                                alt: alt,
                                phe: "TODO"
                            }
                            me.formData.addMutation(mut);

                        }
                    }
                };
                reader.readAsText(vcf_file);
            }
        },
        handleMutationImportCSV: function(e) {

            var me = this;
            var csv_file = this.$.mutationCSVFileInput.files[0];

            if (csv_file != null) {

                var reader = new FileReader();
                var separator = this.$.mutationCSVSeparator.selectedOptions[0].value;
                var ignoreHeader = this.$.mutationCSVHeader.checked;

                reader.onload = function(e) {
                    var data = e.target.result;
                    var lines = data.split("\n");
                    var i = ignoreHeader ? 1 : 0;

                    for (; i < lines.length; i++) {
                        var line = lines[i];
                        if (line != '') {
                            var fields = line.split(separator);
                            var chr = fields[0];
                            var pos = fields[1];
                            var ref = fields[2];
                            var alt = fields[3];
                            var phe = fields[4];

                            var mut = {
                                chr: chr,
                                pos: pos,
                                ref: ref,
                                alt: alt,
                                phe: phe

                            }
                            me.formData.addMutation(mut);
                        }
                    }
                };
                reader.readAsText(csv_file);
            }
        },
        handleClickMutationListClear: function(e) {
            this.formData.clearMutations();
        },
        handleMutationAdd: function(e) {

            var chr = this.$.mutationGVChr.value;
            var pos = this.$.mutationGVPos.value;
            var ref = this.$.mutationGVRef.value;
            var alt = this.$.mutationGVAlt.value;
            var phe = this.$.mutationGVPhe.value;

            var mut = {
                chr: chr,
                pos: pos,
                ref: ref,
                alt: alt,
                phe: phe

            }
            this.formData.addMutation(mut);

            this.$.mutationGVChr.value = "";
            this.$.mutationGVPos.value = "";
            this.$.mutationGVRef.value = "";
            this.$.mutationGVAlt.value = "";
            this.$.mutationGVPhe.value = "";

        },
        handleClickSavePanel: function(e) {
            if (this.formData.name == "") {
                alert("The Panel name is mandatory!!");
                return;
            }
            if (confirm("Are you sure?")) {

                if (this.defaultStudy && this.teamConfigFolder) {
                    //                    var content = pako.deflate(JSON.stringify(this.formData));
                    content = JSON.stringify(this.formData);
                    var separator = "-_-";
                    var fileName = "panel" + separator + this.formData.name + separator + this.formData.version + separator + this.formData.archived;

                    this.uploadFile(content, fileName, this.defaultStudy.id);
                }

            }
        },
        uploadFile: function(fileContent, fileName, studyId) {
            var url = OpencgaManager.files.upload({
                query: {
                    sid: Cookies("bioinfo_sid")
                },
                request: {
                    url: true
                }
            });

            console.log(url);

            var blob = new Blob([fileContent], {
                type: 'text/plain'
            });

            var formData = new FormData();
            var userId = Cookies("bioinfo_user");
            var studyId = studyId;
            var relativeFilePath = '.team_config/' + fileName;
            var fileFormat = 'GZIP';
            var bioFormat = 'NONE';
            var description = '';
            var chunkId = 0;

            formData.append('chunk_content', blob);
            formData.append('chunk_id', chunkId);
            formData.append('chunk_size', blob.size);
            /*formData.append('chunk_hash', hash);*/
            formData.append("filename", fileName);
            formData.append('userId', userId);
            formData.append('studyId', studyId);
            formData.append('relativeFilePath', relativeFilePath);
            /*formData.append('chunk_gzip', );*/

            formData.append("last_chunk", true);
            formData.append("total_size", blob.size);
            formData.append("fileFormat", fileFormat);
            formData.append("bioFormat", bioFormat);
            formData.append("description", description);

            var xhr = new XMLHttpRequest();
            xhr.open('POST', url, false);
            xhr.onloadend = function(e) {
                console.log('upload Done!');

            };
            xhr.send(formData);
        },
        handleShowPanel: function(neo, old) {
            if (neo.id) {

                this.formData = new Panel(neo);
                this.formData.polymer = this;
            }
        },

        handleImportGenesPanel: function(e) {

            var me = this;
            var fileId = parseInt(this.$.importGenesFromPanel.value);
            for (var i = 0; i < this.panels.length; i++) {
                var panel = this.panels[i];
                if (panel.file.id === fileId) {
                    var panelContent = "";
                    OpencgaManager.files.content({
                        id: fileId,
                        query: {
                            sid: Cookies('bioinfo_sid')
                        },
                        request: {
                            async: false,
                            success: function(response) {
                                panelContent = response;
                            },
                            error: function() {}
                        }
                    });
                    if (panelContent != "") {
                        this.selectedPanel = JSON.parse(panelContent);
                        this.genes = this.selectedPanel.genes;
                    }
                }
            }
            for (var i = 0; i < this.genes.length; i++) {
                me.formData.addGene(this.genes[i]);
            }

        },
        handleImportMutationsPanel: function(e) {
            var me = this;
            var fileId = parseInt(this.$.importMutationsFromPanel.value);
            for (var i = 0; i < this.panels.length; i++) {
                var panel = this.panels[i];
                if (panel.file.id === fileId) {
                    var panelContent = "";
                    OpencgaManager.files.content({
                        id: fileId,
                        query: {
                            sid: Cookies('bioinfo_sid')
                        },
                        request: {
                            async: false,
                            success: function(response) {
                                panelContent = response;
                            },
                            error: function() {}
                        }
                    });
                    if (panelContent != "") {
                        this.selectedPanel = JSON.parse(panelContent);
                        this.mutations = this.selectedPanel.mutations;
                    }
                }
            }
            for (var i = 0; i < this.mutations.length; i++) {
                me.formData.addMutation(this.mutations[i]);
            }
        },
    });
</script>
