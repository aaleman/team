<link rel="import" href="../../lib/jsorolla/src/lib/components/table/jso-table.html">
<link rel="import" href="team-mutation-selector.html">

<dom-module id="team-panel-form-wizard">
    <style>
        :host {
            display: block;
            position: relative;
            box-sizing: border-box;
            height: 700px;
            width: 100%;
        }

        .wrapped-text {
            white-space: pre-wrap;
        }

        #genes-tab {
            height: 100%;
            width: 40%;
        }

        #genes-list {
            height: 80%;
            width: 55%;
            margin: 0 auto;
            border: 1px solid #d3d3d3;
        }

        .genes-tab-container-elem {
            margin: 20px;
        }

        #mutations-tab {
            height: 80%;
            width: 45%;
        }

        #mutations-list {
            height: 80%;
            width: 50%;
            margin: 0 auto;
            border: 1px solid #d3d3d3;
        }

        #personalData {
            border: 1px solid #d3d3d3;
            padding: 10px;
            margin: 20px 100px;
        }

        .disease {
            width: 400px;
            height: 500px;
            margin: 0 auto;
            border: 1px solid #d3d3d3;
        }

        jso-table {
            height: 600px;
        }

        #panelPreview .container {
            width: 800px;
            height: 600px;
            overflow-y: auto;
            overflow-x: auto;
        }

        #appPanel .container {
            width: 800px;
            height: 600px;
            overflow-y: auto;
            overflow-x: auto;
        }

        #panelPreviewMut .container {
            width: 800px;
            height: 600px;
            overflow-y: auto;
            overflow-x: auto;
        }

        .file {
            text-align: center;
            color: #445D76;
            margin: 5px;
            width: 100px;
        }

        .sgenesTextArea {
            box-sizing: border-box;
            width: 100%;
            height: 40px;
            resize: none;
            margin: 5px;
        }

        .data {
            color: #666;
            margin-top: 10px;
            margin-bottom: 5px;
        }

        .input {
            width: 100px;
            height: 13px;
        }

        .eye {
            border: 1px solid #d3d3d3;
        }

        .eye > i:hover {
            color: #666;
            cursor: pointer;
        }

        #allDiseases,
        #selectedDiseases,
        #geneTable,
        #mutationTable {
            height: 450px;
            width: 400px;
        }

        #panelAppDiseases {
            margin: 5px;
            width: 55%;
            border: 1px solid #d3d3d3;
            box-sizing: border-box;
        }

        #panelAppGenes {
            margin: 5px;
            width: 45%;
            border: 1px solid #d3d3d3;
            box-sizing: border-box;
        }

        .genes-tab-elem {
            margin-bottom: 5px;
            border: 1px solid #d3d3d3;
            padding: 5px;
        }

        .mutations-tab-elem {
            margin-bottom: 5px;
            border: 1px solid #d3d3d3;
            padding: 5px;
        }

        jso-table::shadow .table-row {
            height: 25px;
        }

        jso-table::shadow {
            font-size: 11px;
        }

        jso-table::shadow .table-pager > input {
            width: 40px;
        }

        .stepName {
            font-size: 20px;
            text-align: center;
            color: #445D76;
            margin-bottom: 10px;
        }
    </style>
    <template>

        <jso-wizard id="formWizard">
            <div class="step">
                <!-- <div class="jso-formbox vertical layout"> -->
                <div class="stepName">Step 1: Select Diseases</div>
                <div class="jso-formcontent horizontal layout">
                    <div class="disease vertical layout">
                        <jso-table id="allDiseases" class="flex" columns="{{allDiseaseColumns}}" data="{{allDiseasesData}}" selected="{{currentSelectedDiseasesData}}" enable-select enable-filter enable-paging></jso-table>
                        <div class="horizontal layout">
                            <div class="flex"></div>
                            <div class="jso-btn jso-btn-shdw file" on-click="handleAddSelectedDiseases"><i class="fa fa-plus-square-o"></i>&nbsp; Add
                            </div>
                        </div>
                    </div>
                    <div class="disease vertical layout">
                        <jso-table id="selectedDiseases" class="flex" columns="{{diseaseColumns}}" on-removerow="handleRemoveDisease" data="{{formData.diseases}}">

                        </jso-table>
                        <div class="horizontal layout">
                            <div class="flex"></div>
                            <div class="jso-btn jso-btn-shdw file" on-click="handleClearSelectedDiseases">
                                Clear
                            </div>
                        </div>
                    </div>
                </div>
                <!-- </div> -->
            </div>
            <div class="step">
                <!-- <div class="jso-formbox"> -->
                <div class="stepName">Step 2: Select Genes</div>
                <div class="jso-formcontent horizontal layout">
                    <div id="genes-tab" class="vertical layout">
                        <div class="genes-tab-elem">
                            <div class="jso-formtitle" style="font-size:14px;">Genes/Regions &nbsp;</div>
                            <!-- <div class=""> -->
                            <textarea class="jso sgenesTextArea" name="geneTextArea" id="geneTextArea" rows="3" placeholder="BRCA2,PPL" style="width: 60%;"></textarea>

                            <div class="horizontal layout">
                                <div class="flex"></div>
                                <div class="jso-btn jso-btn-shdw file" on-click="handleClickGeneTextAreaButton">
                                    <i class="fa fa-plus-square-o"></i>&nbsp; Add Genes
                                </div>
                            </div>
                            <!-- </div> -->
                        </div>
                        <div class="genes-tab-elem">
                            <div class="jso-formtitle" style="font-size:14px;">Import from BED &nbsp;</div>
                            <!-- <div class="jso-formcontent"> -->
                            <input type="file" style="margin-top:5px" id="geneBedFileInput">

                            <div class="horizontal layout">
                                <div class="flex"></div>
                                <div class="jso-btn jso-btn-shdw file" on-click="handleGenesImportBed"><i class="fa fa-plus-square-o"></i>&nbsp; Import
                                </div>
                            </div>
                            <!-- </div> -->
                        </div>

                        <div class="genes-tab-elem">
                            <div class="jso-formtitle" style="font-size:14px;">Import from other Panel &nbsp;</div>
                            <!-- <div class="jso-formcontent"> -->
                            <select id="importGenesFromPanel" style="width:150px;margin-top:5px">
                                <option value="none"></option>
                                <template is="dom-repeat" items="{{panels}}">
                                    <option value$="{{item.file.id}}">{{item.name}}</option>
                                </template>
                            </select>
                            <div class="horizontal layout">
                            <div class="jso-btn jso-btn-shdw file" on-click="handlePreviewFile"> &nbsp; <i class="fa fa-eye"></i>&nbsp;View Panel</div>
                                <div class="flex"></div>
                                <div class="jso-btn jso-btn-shdw file" on-click="handleImportGenesPanel"><i class="fa fa-plus-square-o"></i>&nbsp; Import
                                </div>
                            </div>
                            <!-- </div> -->
                        </div>
                        <div class="genes-tab-elem">
                            <div class="jso-formtitle" style="font-size:14px;">Import from PanelApp &nbsp;</div>
                            <!-- <div class="jso-formcontent"> -->
                            <div class="horizontal layout">
                                <div class="flex"></div>
                                <div class="jso-btn jso-btn-shdw file" on-click="handleImportAppPanel"><i class="fa fa-plus-square-o"></i>&nbsp; Import
                                </div>
                            </div>
                            <!-- </div> -->
                        </div>
                    </div>

                    <div id="genes-list">
                        <jso-table id="geneTable" columns="{{geneColumns}}" data="{{formData.genes}}" enable-edit></jso-table>
                        <div class="horizontal layout">
                            <div class="flex"></div>
                            <div class="jso-btn jso-btn-shdw file" on-click="handleClickGeneListClear">Clear</div>
                        </div>
                    </div>

                </div>
                <jso-panel modal closable hidden id="panelPreview">
                    <div class="header">
                        <i class="fa fa-eye"></i> Panel Preview
                    </div>
                    <team-panel-preview class="container" selected-panel="{{selectedPanel}}">
                    </team-panel-preview>
                </jso-panel>
                <jso-panel movable fixed closable hidden id="appPanel">
                    <div class="header">
                        <i class="fa fa-plus-square-o"></i> Import from PanelApp
                    </div>

                    <div class="jso-formcontent horizontal layout container">

                        <div id="panelAppDiseases" class="vertical layout">
                            <jso-table class="flex" enable-filter columns="{{panelAppDiseasesColumns}}" data="{{panelAppDiseases}}" on-selected="handlePanelAppSelected" enable-select style="height:550px">

                            </jso-table>

                            <div class="horizontal layout">
                                <div class="flex"></div>
                                <a href="https://bioinfo.extge.co.uk/crowdsourcing/PanelApp/">
                                    <div class="jso-btn jso-btn-shdw file">>>More info
                                        <<</div>
                                </a>
                                </div>
                            </div>
                            <div id="panelAppGenes" class="vertical layout">
                                <jso-table class="flex" id="panelAppSelectedGenes" columns="{{panelAppGenesColumns}}" data="{{panelAppGenes}}" enable-select style="height:550px">

                                </jso-table>
                                <div class="horizontal layout">
                                    <div class="flex"></div>
                                    <div class="jso-btn jso-btn-shdw file" on-click="handlePanelAppAddGenes"><i class="fa fa-plus-square-o"></i>&nbsp;Add Genes
                                    </div>
                                </div>
                            </div>
                        </div>

                </jso-panel>
                <!-- </div> -->
                </div>
                <div class="step">
                    <!-- <div class="jso-formbox"> -->
                    <div class="stepName">Step 3: Select Mutations</div>
                    <div class="jso-formcontent horizontal layout">
                        <div id="mutations-tab" flex>
                            <div class="mutations-tab-elem">
                                <div class="jso-formtitle" style="font-size:13px;">Genomic Pos. &nbsp;</div>
                                <div class="vertical layout" id="mutation-tab-config-gv">
                                    <div class="horizontal layout data">
                                        <label style="font-size:12px;" for="">Chr: &nbsp;</label>
                                        <input class="input" type="text" name="mutationGVChr" id="mutationGVChr" />

                                        <div class="flex"></div>
                                        <label style="font-size:12px;" for="">Pos: &nbsp;</label>
                                        <input class="input" type="number" step="1" min="0" name="mutationGVPos" id="mutationGVPos" />
                                    </div>
                                    <div class="horizontal layout data">
                                        <label style="font-size:12px;" for="">Ref: &nbsp;&nbsp;</label>
                                        <input class="input" type="text" name="mutationGVRef" id="mutationGVRef" />

                                        <div class="flex"></div>
                                        <label style="font-size:12px;" for="">Alt: &nbsp;</label>
                                        <input class="input" type="text" name="mutationGVAlt" id="mutationGVAlt" />
                                    </div>
                                    <div class="horizontal layout data">
                                        <label style="font-size:12px;" for="">Phe: &nbsp;</label>
                                        <input class="input flex" type="text" name="mutationGVPhe" id="mutationGVPhe" />
                                        <!--<datalist id="dataListPhe">-->
                                        <!--<template is="dom-repeat" items="{{allDiseasesData}}">-->
                                        <!--<option value="{{item.phenotype}}">{{item.phenotype}}</option>-->
                                        <!--</template>-->
                                        <!--</datalist>-->
                                    </div>
                                    <div class="horizontal layout">
                                        <div class="jso-btn jso-btn-shdw file" style="width: 150px" on-click="handleOpenGV">
                                            Open Genome Browser
                                        </div>
                                        <div class="flex"></div>
                                        <div class="jso-btn jso-btn-shdw file" on-click="handleMutationAdd"><i class="fa fa-plus-square-o"></i>&nbsp; Add
                                        </div>

                                    </div>

                                </div>
                            </div>
                            <div class="mutations-tab-elem">

                                <div class="jso-formtitle" style="font-size:13px;">Import VCF &nbsp;</div>
                                <div class="" id="mutation-tab-config-vcf">

                                    <div class="horizontal layout data">
                                        <label style="font-size:12px;" for="">Phe: &nbsp;</label>
                                        <input class="input flex" type="text" name="mutationGVPheVCF" id="mutationGVPheVCF" />
                                        <!--<datalist id="dataListPheVCF">-->
                                        <!--<template is="dom-repeat" items="{{allDiseasesData}}">-->
                                        <!--<option value="{{item.phenotype}}">{{item.phenotype}}</option>-->
                                        <!--</template>-->
                                        <!--</datalist>-->
                                    </div>
                                    <input style="margin-top:10px" type="file" id="mutationVCFFileInput">

                                    <div class="horizontal layout">
                                        <div class="flex"></div>
                                        <div class="jso-btn jso-btn-shdw file" on-click="handleMutationImportVCF"><i class="fa fa-plus-square-o"></i>&nbsp; Import
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="mutations-tab-elem">
                                <div class="jso-formtitle" style="font-size:13px;">Import CSV &nbsp;</div>
                                <div class="" id="mutation-tab-config-csv">
                                    <div>
                                        <label class="data" style="font-size:12px; margin-top:5px" for="">Separator:</label>
                                        <select name="mutationCSVSeparator" id="mutationCSVSeparator">
                                            <option value=";" selected>;</option>
                                            <option value=",">,</option>
                                            <option value="\t">Tab</option>
                                        </select>
                                    </div>
                                    <div>
                                        <label class="data" style="font-size:12px;" for="">Ignore first line (header):
                                        </label>
                                        <input type="checkbox" name="mutationCSVHeader" id="mutationCSVHeader" value="ignore" checked/>
                                    </div>

                                    <input style="margin-top:5px" type="file" id="mutationCSVFileInput">

                                    <div class="horizontal layout">
                                        <div class="flex"></div>
                                        <div class="jso-btn jso-btn-shdw file" on-click="handleMutationImportCSV"><i class="fa fa-plus-square-o"></i>&nbsp; Import
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <div class="mutations-tab-elem">
                                <div class="jso-formtitle" style="font-size:13px">Import from other Panel &nbsp;</div>
                                <div class="" id="mutation-tab-config-panel">
                                    <select id="importMutationsFromPanel" style="width:150px; margin-top:5px">
                                        <option value="none"></option>
                                        <template is="dom-repeat" items="{{panels}}">
                                            <option value$="{{item.file.id}}">{{item.name}}</option>
                                        </template>
                                    </select>
                                    <div class="horizontal layout">
                                        <div class="jso-btn jso-btn-shdw file" on-click="handlePreviewFileMut"> &nbsp; <i class="fa fa-eye"></i>&nbsp;View Panel</div>
                                        <div class="flex"></div>
                                        <div class="jso-btn jso-btn-shdw file" on-click="handleImportMutationsPanel"><i class="fa fa-plus-square-o"></i>&nbsp; Import
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div id="mutations-list" flex>
                            <jso-table id="mutationTable" columns="{{mutationColumns}}" data="{{formData.mutations}}" enable-edit></jso-table>
                            <div class="horizontal layout">
                                <div class="flex"></div>
                                <div class="jso-btn jso-btn-shdw file" on-click="handleClickMutationListClear">Clear
                                </div>
                            </div>
                        </div>
                    </div>
                    <jso-panel modal closable hidden id="panelPreviewMut">
                        <div class="header">
                            <i class="fa fa-book"></i> Panel Preview
                        </div>
                        <team-panel-preview class="container" selected-panel="{{selectedPanel}}">
                        </team-panel-preview>
                    </jso-panel>

                    <jso-panel movable fixed closable hidden id="panelGV">
                        <div class="header">
                            <i class="fa fa-eye"></i> View Mutation
                        </div>
                        <team-mutation-selector class="container" id="mutationSelector" on-created-mutation="handleAddedMutationFromGV">
                        </team-mutation-selector>
                    </jso-panel>
                    <!-- </div> -->
                </div>
                <div class="step">
                    <!-- <div class="jso-formbox"> -->
                    <div class="stepName">Step 4: Panel Info</div>
                    <div class="jso-formcontent vertical layout" id="personalData">
                        <div style="color:#666;margin-top:5px;" for="">Name</div>
                        <input style="margin-top: 2px;border-color:#d3d3d3;" type="text" value="{{formData.name::input}}" />

                        <div class="data" for="">Author</div>
                        <input style="margin-top: 2px;border-color:#d3d3d3;" type="text" value="{{formData.author::input}}" />

                        <div class="data" for="">Date</div>
                        <input style="width:150px; margin-top: 2px;border-color:#d3d3d3;" type="date" value="{{formData.date::input}}" />

                        <div class="data" for="">Description &nbsp; </div>
                        <textarea class="jso sgenesTextArea" style="height: 100px;" name="" id="" cols="30" rows="10" value="{{formData.description::input}}"></textarea>

                        <div class="jso-btn jso-btn-shdw file" style="margin: 0 auto; margin-top:10px" on-click="handleClickSavePanel"><i class="fa fa-floppy-o"></i>&nbsp; Save
                        </div>
                    </div>
                    <!-- </div> -->
                </div>
        </jso-wizard>


    </template>
</dom-module>
<script>
    Polymer({
        is: "team-panel-form-wizard",
        properties: {
            step: {
                type: Number,
                value: 1
            },
            maxSteps: {
                type: Number,
                value: 4
            },
            formData: {
                type: Object,
                value: function() {
                    return {};
                },
                notify: true
            },
            diseaseColumns: {
                type: Array,
                value: function() {
                    return [];
                }
            },
            selectedDiseases: {
                type: Array,
                value: function() {
                    return [];
                },
                notify: true,
                observer: 'handleSelectedRows'
            },
            currentSelectedDiseasesData: {
                type: Array,
                value: function() {
                    return [];
                }
            },
            selectedDiseasesData: {
                type: Array,
                value: function() {
                    return [];
                }
            },
            associatedGenes: {
                type: Object,
                value: function() {
                    return {};
                }
            },
            geneTab: {
                type: String,
                value: ''
            },
            geneColumns: {
                type: Array,
                value: function() {
                    return [];
                }
            },
            mutationTab: {
                type: String,
                value: 'gv'
            },
            mutationColumns: {
                type: Array,
                value: function() {
                    return [];
                }
            },
            mutationData: {
                type: Array,
                value: function() {
                    return [];
                }
            },
            defaultStudy: {
                type: Object,
                value: function() {
                    return {};
                }
            },
            teamConfigFolder: {
                type: Object,
                value: function() {
                    return {};
                }
            },
            showPanel: {
                type: Object,
                value: function() {
                    return {};
                },
                observer: 'handleShowPanel'
            },
            dataListPhenotype: {
                type: Array,
                value: function() {
                    return [];
                }
            },
            panels: {
                type: Array,
                value: function() {
                    return [];
                }
            },
            selectedPanel: {
                type: Object,
                value: function() {
                    return {};
                }
            },
            genes: {
                type: Array,
            },
            mutations: {
                type: Array,
            },
            panelAppDiseases: {
                type: Array,
                value: function() {
                    return [];
                }
            },
            panelAppGenes: {
                type: Array,
                value: function() {
                    return [];
                }
            },

        },
        observers: [
            "handleUpdatedGenes(formData.modCount)",
            "handleUpdatedSelectedDiseases(formData.diseases.splices)",
        ],


        handleUpdatedSelectedDiseases: function(neo, old, path) {

        },
        handleUpdatedGenes: function(neo, old, path) {
            if (neo) {
                this.$.geneTable.refresh();
            }
        },
        handleRemoveDisease: function(e) {
            var disease = e.detail.row;
            this.formData.removeGenesFromDisease(disease);
            this.formData.removeMutationsFromDisease(disease);

        },
        handlePanelAppSelected: function(e) {

            var me = this;

            var selectedPanelAppDisease = e.detail.length > 0 ? e.detail[0] : {};

            if (selectedPanelAppDisease.Name && selectedPanelAppDisease.Name !== "") {

                var query = "https://bioinfo.extge.co.uk/crowdsourcing/WebServices/get_panel/" + selectedPanelAppDisease.Name + "/?format=json"

                $.ajax({
                    url: query,
                    dataType: 'json',
                    async: false,
                    success: function(response, textStatus, jqXHR) {
                        me.panelAppGenes = response.result.Genes;
                    }
                });
            }
        },
        ready: function() {


            var me = this;

            var lastQuery = '';

            this.formData = new Panel();
            this.formData.polymer = this;

            this.$.allDiseases.setLoading(true);

            if (localStorage.bioinfo_team_diseases) {

                this.allDiseasesData = JSON.parse(localStorage.bioinfo_team_diseases);

            } else {
                $.ajax({
                    url: "http://bioinfodev.hpc.cam.ac.uk/cellbase/webservices/rest/v3/hsapiens/feature/clinical/phenotype-gene?include=clinvar,gwas",
                    dataType: 'json',
                    async: false,
                    success: function(response, textStatus, jqXHR) {
                        try {
                            var data = response.response;
                            var clinvar = data[0].result;
                            var gwas = data[1].result;

                            var diseases = [];

                            //                            for (var i = 0; i < 100; i++) {
                            for (var i = 0; i < clinvar.length; i++) {
                                var dis = clinvar[i];
                                dis.source = "clinvar";
                                diseases.push(dis);
                            }
                            //                            for (var i = 0; i < 100; i++) {
                            for (var i = 0; i < gwas.length; i++) {
                                var dis = gwas[i];
                                dis.source = "gwas";
                                diseases.push(dis);
                            }

                            diseases.sort(function(a, b) {
                                return a.phenotype.localeCompare(b.phenotype);
                            });


                            if (diseases.length > 0) {
                                me.allDiseasesData = diseases;
                                localStorage.bioinfo_team_diseases = JSON.stringify(diseases);
                            }


                        } catch (e) {

                        }

                    }
                });

            }


            this.$.allDiseases.setLoading(false);

            this.allDiseaseColumns = [{
                name: 'phenotype',
                title: 'Phenotype',
                type: 'text',
                width: 300
            }, {
                name: 'source',
                title: 'Source',
                type: 'select',
                options: ["clinvar", "gwas"],
                width: 100
            }];
            this.diseaseColumns = [{
                name: 'phenotype',
                title: 'Phenotype',
                type: 'text',
                width: 290
            }, {
                name: 'source',
                title: 'Source',
                type: 'select',
                options: ["clinvar", "gwas"],
                width: 90
            }, {
                name: '',
                title: '',
                type: 'action',
                width: 30
            }];
            this.geneTab = 'text';
            this.geneColumns = [{
                name: 'name',
                title: 'Name'
            }, {
                name: 'chr',
                title: 'Chr',
                defaultValue: '.'
            }, {
                name: 'start',
                title: 'Start',
                defaultValue: '.'
            }, {
                name: 'end',
                title: 'End',
                defaultValue: '.'
            }, {
                name: '',
                title: '',
                type: 'action',
                width: 30
            }];


            this.mutationColumns = [{
                name: 'chr',
                title: 'Chr',
                width: 40
            }, {
                name: 'pos',
                title: 'Pos'
            }, {
                name: 'ref',
                title: 'Ref',
                width: 70
            }, {
                name: 'alt',
                title: 'Alt',
                width: 70
            }, {
                name: 'phe',
                title: 'Phenotype'
            }, {
                name: '',
                title: '',
                type: 'action',
                width: 30
            }];

            this.panelAppGenesColumns = [{
                name: "GeneSymbol",
                title: "Gene",
                width: 180
            }, {
                name: "LevelOfConfidence",
                title: "Level Of Confidence",
                width: 170
            }];
            this.panelAppDiseasesColumns = [{
                name: 'Name',
                title: 'Disease',
                width: 220

            }, {
                name: 'Number_of_Genes',
                title: 'NÂºGenes',
                width: 100
            }, {
                name: 'CurrentVersion',
                title: 'Version',
                width: 100
            }];


            if (localStorage.bioinfo_team_panelapp_diseases) {
                this.panelAppDiseases = JSON.parse(localStorage.bioinfo_team_panelapp_diseases);
            } else {
                $.ajax({
                    url: "https://bioinfo.extge.co.uk/crowdsourcing/WebServices/list_panels?format=json",
                    dataType: 'json',
                    async: false,
                    success: function(response, textStatus, jqXHR) {
                        var result = response.result;
                        if (result.length > 0) {
                            me.panelAppDiseases = result;
                            localStorage.bioinfo_team_panelapp_diseases = JSON.stringify(result);
                        }
                    }
                });

            }

            //            this.$.mutationGVPhe.addEventListener('keyup', function (event) {
            //                        var query = this.value.toUpperCase();
            //                        if (query.length > 2 && lastQuery !== query && event.which !== 13) {
            //                            me._setQuickSearchMenu(query);
            //                            lastQuery = query;
            //                        }
            //                    }
            //            );

            var stepNumbers = this.getElementsByClassName("step-number");
        },
        _setQuickSearchMenu: function(query) {
            this.dataListPhenotype = [];
            //            this.splice('dataListPhenotype',0,this.dataListPhenotype.length);
            for (var i = 0; i < this.allDiseasesData.length; i++) {
                var row = this.allDiseasesData[i];
                var disName = row.phenotype.toUpperCase();
                if (disName.indexOf(query) >= 0) {
                    this.push('dataListPhenotype', row);
                }
            }
            console.log(this.dataListPhenotype);
        },

        collapseMenu: function(menuHidden, searchingFlag) {
            return menuHidden || searchingFlag;
        },
        hideProjectList: function(menuHidden, searchingFlag) {
            return menuHidden || searchingFlag;
        },

        handleSelectedRows: function(neo, old) {
            return neo;
        },
        handleAddSelectedDiseases: function() {
            var me = this;
            this.$.selectedDiseases.setLoading(true);
            setTimeout(function() {
                for (var i = 0; i < me.currentSelectedDiseasesData.length; i++) {
                    var row = me.currentSelectedDiseasesData[i];

                    if (!me.formData.containsDisease(row)) {
                        me.formData.addDisease(row);

                    }
                }
                me.$.selectedDiseases.setLoading(false);
            }, 50)
        },
        handleClearSelectedDiseases: function() {
            this.formData.clearDiseases();
        },
        handleHiddenGeneText: function(geneTab) {
            return geneTab != 'text';
        },
        handleHiddenGeneBed: function(geneTab) {
            return geneTab != 'bed';
        },
        handleHiddenGenePanel: function(geneTab) {
            return geneTab != 'panel';
        },
        handleClickGeneText: function(e) {
            this.geneTab = 'text';
        },
        handleClickGeneBed: function(e) {
            this.geneTab = 'bed';
        },
        handleClickGenePanel: function(e) {
            this.geneTab = 'panel';
        },
        handleClickGeneTextAreaButton: function(e) {
            var me = this;
            var textAreaValue = this.$.geneTextArea.value.toUpperCase();
            var splits = textAreaValue.split(",");

            for (var i = 0; i < splits.length; i++) {
                var geneName = splits[i];

                if (geneName != '') {

                    var re = /(\w+):(\d+)-(\d)+/;
                    if (re.test(geneName)) {
                        //                        var groups = re.match(geneName);
                        var groups = geneName.match(re);

                        var chr = groups[1];
                        var start = parseInt(groups[2]);
                        var end = parseInt(groups[3]);

                        if (start > end) {
                            alert("Malformed Region: " + geneName);
                        } else {
                            var gene = {
                                name: geneName,
                                chr: chr,
                                start: start,
                                end: end
                            };
                            me.formData.addGene(gene);
                        }
                    } else {
                        this.$.geneTable.setLoading(true);
                        setTimeout(function() {
                            CellBaseManager.get({
                                species: 'hsapiens',
                                category: 'feature',
                                subCategory: 'gene',
                                resource: 'info',
                                async: false,
                                query: geneName,
                                params: {
                                    include: "name,chromosome,start,end"
                                },
                                success: function(data) {
                                    if (data.response && data.response.length > 0) {
                                        for (var i = 0; i < data.response.length; i++) {
                                            var elem = data.response[i];
                                            if (elem.result.length > 0) {
                                                var row = data.response[i].result[0];
                                                var gene = {
                                                    name: elem.id,
                                                    chr: row.chromosome,
                                                    start: row.start,
                                                    end: row.end
                                                };
                                                me.formData.addGene(gene);
                                            } else {
                                                me.formData.addGene({
                                                    name: elem.id
                                                });
                                            }
                                        }
                                    }
                                }
                            });
                            me.$.geneTable.setLoading(false);
                        }, 50);
                    }
                }
            }
            this.$.geneTextArea.value = '';
        },
        handleGenesImportBed: function(e) {
            var me = this;
            var bed_file = this.$.geneBedFileInput.files[0];
            if (bed_file != null) {
                var reader = new FileReader();
                reader.onload = function(e) {
                    var data = e.target.result;
                    var lines = data.split("\n");
                    for (var i = 0; i < lines.length; i++) {
                        var line = lines[i];
                        if (line.indexOf("#") < 0 && line != '') {
                            var fields = line.split("\t");
                            var chr = fields[0];
                            var start = fields[1];
                            var end = fields[2];
                            var gene = {
                                name: chr + ":" + start + "-" + end,
                                chr: chr,
                                start: start,
                                end: end
                            };
                            me.formData.addGene(gene);
                        }
                    }
                };
                reader.readAsText(bed_file);
            }
        },
        handleImportAppPanel: function(e) {
            this.$.appPanel.hidden = false;
        },
        handleClickGeneListClear: function(e) {
            this.formData.clearGenes();
        },
        handleClickMutationGV: function(e) {
            this.mutationTab = 'gv';
        },
        handleClickMutationVCF: function(e) {
            this.mutationTab = 'vcf';
        },
        handleClickMutationCSV: function(e) {
            this.mutationTab = 'csv';
        },
        handleClickMutationPanel: function(e) {
            this.mutationTab = 'panel';
        },
        handleHiddenMutationGV: function(mutationTab) {
            return mutationTab != 'gv';
        },
        handleHiddenMutationVCF: function(mutationTab) {
            return mutationTab != 'vcf';
        },
        handleHiddenMutationCSV: function(mutationTab) {
            return mutationTab != 'csv';
        },
        handleHiddenMutationPanel: function(mutationTab) {
            return mutationTab != 'panel';
        },
        handleMutationImportVCF: function(e) {
            var me = this;
            var vcf_file = this.$.mutationVCFFileInput.files[0];
            phe = this.$.mutationGVPheVCF.value;
            if (vcf_file != null) {
                var reader = new FileReader();
                reader.onload = function(e) {
                    var data = e.target.result;
                    var lines = data.split("\n");
                    for (var i = 0; i < lines.length; i++) {
                        var line = lines[i];
                        if (line.indexOf("#") < 0 && line != '') {
                            var fields = line.split("\t");
                            var chr = fields[0];
                            var pos = fields[1];
                            var ref = fields[3];
                            var alt = fields[4];

                            var mut = {
                                chr: chr,
                                pos: pos,
                                ref: ref,
                                alt: alt,
                                phe: phe

                            };
                            me.formData.addMutation(mut);
                        }
                    }
                };
                reader.readAsText(vcf_file);
            }
        },
        handleMutationImportCSV: function(e) {
            var me = this;
            var csv_file = this.$.mutationCSVFileInput.files[0];
            if (csv_file != null) {
                var reader = new FileReader();
                var separator = this.$.mutationCSVSeparator.selectedOptions[0].value;
                var ignoreHeader = this.$.mutationCSVHeader.checked;
                reader.onload = function(e) {
                    var data = e.target.result;
                    var lines = data.split("\n");
                    var i = ignoreHeader ? 1 : 0;
                    for (; i < lines.length; i++) {
                        var line = lines[i];
                        if (line != '') {
                            var fields = line.split(separator);
                            var chr = fields[0];
                            var pos = fields[1];
                            var ref = fields[2];
                            var alt = fields[3];
                            var phe = fields[4];
                            var mut = {
                                chr: chr,
                                pos: pos,
                                ref: ref,
                                alt: alt,
                                phe: phe
                            };
                            me.formData.addMutation(mut);
                        }
                    }
                };
                reader.readAsText(csv_file);
            }
        },
        handleClickMutationListClear: function(e) {
            this.formData.clearMutations();
        },
        handleMutationAdd: function(e) {

            var chr = this.$.mutationGVChr.value;
            var pos = this.$.mutationGVPos.value;
            var ref = this.$.mutationGVRef.value;
            var alt = this.$.mutationGVAlt.value;
            var phe = this.$.mutationGVPhe.value;
            var mut = {
                chr: chr,
                pos: pos,
                ref: ref,
                alt: alt,
                phe: phe
            };

            this.formData.addMutation(mut);
            this.$.mutationGVChr.value = "";
            this.$.mutationGVPos.value = "";
            this.$.mutationGVRef.value = "";
            this.$.mutationGVAlt.value = "";
            this.$.mutationGVPhe.value = "";
        },
        handleClickSavePanel: function(e) {
            if (this.formData.name == "") {
                alert("The Panel name is mandatory!!");
                return;
            }
            if (confirm("Are you sure?")) {
                if (this.defaultStudy && this.teamConfigFolder) {
                    //                    var content = pako.deflate(JSON.stringify(this.formData));
                    content = JSON.stringify(this.formData);
                    var separator = "-_-";
                    var fileName = "panel" + separator + this.formData.name + separator + this.formData.version + separator + this.formData.archived;
                    this.uploadFile(content, fileName, this.defaultStudy.id);
                }
            }
        },
        uploadFile: function(fileContent, fileName, studyId) {
            var url = OpencgaManager.files.upload({
                query: {
                    sid: Cookies("bioinfo_sid")
                },
                request: {
                    url: true
                }
            });
            console.log(url);
            var blob = new Blob([fileContent], {
                type: 'text/plain'
            });
            var formData = new FormData();
            var userId = Cookies("bioinfo_user");
            var studyId = studyId;
            var relativeFilePath = '.team_config/' + fileName;
            var fileFormat = 'GZIP';
            var bioFormat = 'NONE';
            var description = '';
            var chunkId = 0;

            formData.append('chunk_content', blob);
            formData.append('chunk_id', chunkId);
            formData.append('chunk_size', blob.size);
            /*formData.append('chunk_hash', hash);*/
            formData.append("filename", fileName);
            formData.append('userId', userId);
            formData.append('studyId', studyId);
            formData.append('relativeFilePath', relativeFilePath);
            /*formData.append('chunk_gzip', );*/
            formData.append("last_chunk", true);
            formData.append("total_size", blob.size);
            formData.append("fileFormat", fileFormat);
            formData.append("bioFormat", bioFormat);
            formData.append("description", description);

            var xhr = new XMLHttpRequest();
            xhr.open('POST', url, false);
            xhr.onloadend = function(e) {
                console.log('upload Done!');
            };
            xhr.send(formData);
        },
        handleShowPanel: function(neo, old) {
            if (neo.id) {
                this.formData = new Panel(neo);
                this.formData.polymer = this;
            }
        },
        handlePreviewFile: function(e) {
            var fileId = parseInt(this.$.importGenesFromPanel.value);
            var data;

            OpencgaManager.files.content({
                id: fileId,
                query: {
                    sid: Cookies('bioinfo_sid'),
                    limit: 100
                },
                request: {
                    async: false,
                    success: function(response) {
                        data = response;
                    },
                    error: function() {}
                }
            });
            if (data) {
                this.selectedPanel = JSON.parse(data);
                this.$.panelPreview.hidden = false;
            }
        },
        handleImportGenesPanel: function(e) {
            var me = this;
            var fileId = parseInt(this.$.importGenesFromPanel.value);
            for (var i = 0; i < this.panels.length; i++) {
                var panel = this.panels[i];
                if (panel.file.id === fileId) {
                    var panelContent = "";
                    OpencgaManager.files.content({
                        id: fileId,
                        query: {
                            sid: Cookies('bioinfo_sid')
                        },
                        request: {
                            async: false,
                            success: function(response) {
                                panelContent = response;
                            },
                            error: function() {}
                        }
                    });
                    if (panelContent != "") {
                        this.selectedPanel = JSON.parse(panelContent);
                        this.genes = this.selectedPanel.genes;
                    }
                }
            }
            for (var i = 0; i < this.genes.length; i++) {
                me.formData.addGene(this.genes[i]);
            }
        },
        handlePreviewFileMut: function(e) {
            var fileId = parseInt(this.$.importMutationsFromPanel.value);
            var data;
            OpencgaManager.files.content({
                id: fileId,
                query: {
                    sid: Cookies('bioinfo_sid'),
                    limit: 100
                },
                request: {
                    async: false,
                    success: function(response) {
                        data = response;
                    },
                    error: function() {}
                }
            });
            if (data) {
                this.selectedPanel = JSON.parse(data);
                this.$.panelPreviewMut.hidden = false;
            }
        },
        handleImportMutationsPanel: function(e) {
            var me = this;
            var fileId = parseInt(this.$.importMutationsFromPanel.value);
            for (var i = 0; i < this.panels.length; i++) {
                var panel = this.panels[i];
                if (panel.file.id === fileId) {
                    var panelContent = "";
                    OpencgaManager.files.content({
                        id: fileId,
                        query: {
                            sid: Cookies('bioinfo_sid')
                        },
                        request: {
                            async: false,
                            success: function(response) {
                                panelContent = response;
                            },
                            error: function() {}
                        }
                    });
                    if (panelContent != "") {
                        this.selectedPanel = JSON.parse(panelContent);
                        this.mutations = this.selectedPanel.mutations;
                    }
                }
            }
            for (var i = 0; i < this.mutations.length; i++) {
                me.formData.addMutation(this.mutations[i]);
            }
        },

        handleOpenGV: function(e) {
            this.$.panelGV.hidden = false;
        },
        handleAddedMutationFromGV: function(e) {
            this.$.panelGV.hidden = true;
            var mut = e.detail;
            this.formData.addMutation(mut);
        },
        handlePanelAppAddGenes: function(e) {
            var geneName = [];
            var sgenes = this.$.panelAppSelectedGenes.selected;
            for (var i = 0; i < sgenes.length; i++) {
                geneName[i] = sgenes[i].GeneSymbol;
            }
            geneName = geneName.join(",");
            var me = this;
            CellBaseManager.get({
                species: 'hsapiens',
                category: 'feature',
                subCategory: 'gene',
                resource: 'info',
                async: false,
                query: geneName,
                params: {
                    include: "name,chromosome,start,end"
                },
                success: function(data) {

                    if (data.response && data.response.length > 0) {

                        for (var i = 0; i < data.response.length; i++) {
                            var elem = data.response[i];
                            if (elem.result.length > 0) {
                                var row = data.response[i].result[0];
                                var gene = {
                                    name: elem.id,
                                    chr: row.chromosome,
                                    start: row.start,
                                    end: row.end
                                };
                                me.formData.addGene(gene);
                            } else {
                                me.formData.addGene({
                                    name: elem.id
                                });
                            }
                        }
                    }
                }
            });
            this.$.appPanel.hidden = true;
        }
    });
</script>
