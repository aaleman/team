<link rel="import" href="../../lib/jsorolla/src/lib/components/table/jso-table.html">

<dom-module id="team-panel-form-wizard">
    <style>
        :host {
            display: block;
            position: relative;
            box-sizing: border-box;
            width: 900px;
            height: 600px;
            margin: 50px auto 0;
            border: solid white 1px;
        }

        #wizard-bottom {
            height: 30px;
            background-color: lightgrey;

        }

        .step-title {
            height: 50px;
            text-align: center;
            vertical-align: middle;
            line-height: 50px;
            font-size: 16pt;
        }

        #genes-tab {
            height: 80%;
            width: 50%;
        }

        #genes-list {
            height: 80%;
            width: 50%;
        }

        .genes-tab-container-elem {
            margin: 20px;
        }

        .step-content {
            height: calc(100% - 50px);
        }

        #mutations-tab {
            height: 80%;
            width: 50%;
        }

        #mutations-list {
            height: 80%;
            width: 50%;
        }

        .mutations-tab-container-elem {
            margin: 20px;
        }

        .disease-left, .disease-right {
            width: 40%;
            height: 80%;
            margin: 0 auto;
        }

        #addDiseaseBtn {
            margin-top: 5px;
        }
    </style>
    <template>
        <div id="wizard-content" flex>

            <div class="step vertical layout" hidden$="{{handleHiddenStep1(step)}}" id="step1">
                <div class="step-title">
                    Step 1: Diseases
                </div>
                <div class="step-content horizontal layout">
                    <div class="disease-left ">
                        <jso-table id="allDiseases" columns="{{allDiseaseColumns}}" data="{{allDiseasesData}}"
                                   selected="{{currentSelectedDiseasesData}}" enable-select enable-filter></jso-table>
                        <div id="addDiseaseBtn" class="jso-btn jso-btn-shdw" on-click="handleAddSelectedDiseases">Add
                            Selected
                        </div>
                    </div>
                    <div class="disease-right">
                        <jso-table id="selectedDiseases" columns="{{diseaseColumns}}" on-removerow="handleRemoveDisease"
                                   data="{{formData.diseases}}"></jso-table>
                        <div id="clearDiseasesBtn" class="jso-btn jso-btn-shdw" on-click="handleClearSelectedDiseases">
                            Clear
                        </div>
                    </div>
                </div>
            </div>


            <div class="step vertical layout" id="step2" hidden$={{handleHiddenStep2(step)}}>
                <div class="step-title">
                    Step 2: Genes
                </div>
                <div class="step-content horizontal layout">
                    <div id="genes-tab" flex>
                        <div id="genes-tab-menu" class="horizontal layout">
                            <div class="jso-btn jso-btn-shdw" on-click="handleClickGeneText">Genes/Regions</div>
                            <div class="jso-btn jso-btn-shdw" on-click="handleClickGeneBed">Import from BED</div>
                            <div class="jso-btn jso-btn-shdw" on-click="handleClickGenePanel">Import from other Panel
                            </div>
                        </div>
                        <div id="genes-tab-container">
                            <div id="gene-tab-config-text" class="genes-tab-container-elem"
                                 hidden$={{handleHiddenGeneText(geneTab)}}>
                                    <textarea class="jso" name="geneTextArea" id="geneTextArea" rows="3"
                                              placeholder="BRCA2,PPL"></textarea>

                                <div class="jso-btn jso-btn-shdw" on-click="handleClickGeneTextAreaButton">Add
                                    Genes
                                </div>
                            </div>
                            <div id="gene-tab-config-bed" class="genes-tab-container-elem"
                                 hidden$={{handleHiddenGeneBed(geneTab)}}>
                                <input type="file" id="geneBedFileInput">

                                <div class="jso-btn jso-btn-shdw" on-click="handleGenesImportBed">
                                    <span>Import!!</span>
                                </div>
                                <br>
                            </div>
                            <div id="gene-tab-config-panel"
                                 hidden$={{handleHiddenGenePanel(geneTab)}}>PANEL
                            </div>
                        </div>
                    </div>
                    <div id="genes-list" flex>
                        <jso-table id="geneTable" columns="{{geneColumns}}" data="{{formData.genes}}"></jso-table>
                        <div class="jso-btn jso-btn-shdw" on-click="handleClickGeneListClear">Clear</div>
                    </div>
                </div>
            </div>

            <div class="step vertical layout" id="step3" hidden$={{handleHiddenStep3(step)}}>
                <div class="step-title">
                    Step 3: Mutations
                </div>
                <div class="step-content horizontal layout">
                    <div id="mutations-tab" flex>
                        <div id="mutations-tab-menu" class="horizontal layout">
                            <div class="jso-btn jso-btn-shdw" on-click="handleClickMutationGV">Genomic Pos.</div>
                            <div class="jso-btn jso-btn-shdw" on-click="handleClickMutationVCF">Import VCF</div>
                            <div class="jso-btn jso-btn-shdw" on-click="handleClickMutationCSV">Import CSV</div>
                            <div class="jso-btn jso-btn-shdw" on-click="handleClickMutationPanel">Import from other
                                Panel
                            </div>
                        </div>
                        <div id="mutations-tab-container">
                            <div id="mutation-tab-config-gv" class="mutations-tab-container-elem vertical layout"
                                 hidden$={{handleHiddenMutationGV(mutationTab)}}>
                                <div class="vertical layout">
                                    <div class="horizontal layout">
                                        <div>
                                            <label for="">Chr</label>
                                            <input type="text" name="mutationGVChr" id="mutationGVChr"/>
                                        </div>
                                        <div>
                                            <label for="">Pos</label>
                                            <input type="text" name="mutationGVPos" id="mutationGVPos"/>
                                        </div>
                                        <div>
                                            <label for="">Ref</label>
                                            <input type="text" name="mutationGVRef" id="mutationGVRef"/>
                                        </div>
                                        <div>
                                            <label for="">Alt</label>
                                            <input type="text" name="mutationGVAlt" id="mutationGVAlt"/>
                                        </div>
                                        <div>
                                            <label for="">Phe</label>
                                            <input type="text" name="mutationGVPhe" id="mutationGVPhe"/>
                                        </div>
                                    </div>
                                    <div class="jso-btn jso-btn-shdw" on-click="handleMutationAdd">
                                        <span>Add!!</span>
                                    </div>

                                </div>
                                <jso-genome-viewer-element id="gv"></jso-genome-viewer-element>
                            </div>
                            <div id="mutation-tab-config-vcf" class="mutations-tab-container-elem"
                                 hidden$={{handleHiddenMutationVCF(mutationTab)}}>

                                <input type="file" id="mutationVCFFileInput">

                                <div class="jso-btn jso-btn-shdw" on-click="handleMutationImportVCF">
                                    <span>Import!!</span>
                                </div>
                            </div>
                            <div id="mutation-tab-config-csv"
                                 hidden$={{handleHiddenMutationCSV(mutationTab)}} class="vertical layout">

                                <div>
                                    <label for="">Separator:</label>
                                    <select name="mutationCSVSeparator" id="mutationCSVSeparator">
                                        <option value=";" selected>;</option>
                                        <option value=",">,</option>
                                        <option value="\t">Tab</option>
                                    </select>
                                </div>


                                <div>
                                    <label for="">Ignore first line (header):</label>
                                    <input type="checkbox" name="mutationCSVHeader" id="mutationCSVHeader"
                                           value="ignore"
                                           checked/>
                                </div>


                                <input type="file" id="mutationCSVFileInput">

                                <div class="jso-btn jso-btn-shdw" on-click="handleMutationImportCSV">
                                    <span>Import!!</span>
                                </div>
                            </div>
                            <div id="mutation-tab-config-panel"
                                 hidden$={{handleHiddenMutationPanel(mutationTab)}}>TODO
                            </div>
                        </div>
                    </div>
                    <div id="mutations-list" flex>
                        <jso-table id="mutationTable" columns="{{mutationColumns}}"
                                   data="{{formData.mutations}}"></jso-table>
                        <div class="jso-btn jso-btn-shdw" on-click="handleClickMutationListClear">Clear</div>
                    </div>
                </div>
            </div>

            <div class="step vertical layout" id="step4" hidden$={{handleHiddenStep4(step)}}>
                <div class="step-title">
                    Step 4: Panel Info
                </div>
                <div class="step-content vertical layout">

                    <div>
                        <label for="">Name:</label>
                        <input type="text" value="{{formData.name::input}}"/>
                    </div>

                    <div>
                        <label for="">Author</label>
                        <input type="text" value="{{formData.author::input}}"/>
                    </div>

                    <div>
                        <label for="">Date</label>
                        <input type="date" value="{{formData.date::input}}"/>
                    </div>

                    <div>
                        <label for="">Description</label>
                        <textarea name="" id="" cols="30" rows="10" value="{{formData.description::input}}"></textarea>
                    </div>

                    <div class="jso-btn jso-btn-shdw" on-click="handleClickSavePanel">Save!!</div>
                </div>
            </div>

        </div>
        <div id="wizard-bottom" class="horizontal layout end-justified">
            <div class="jso-btn jso-btn-shdw" on-click="handlePrevStepButton">Prev</div>
            <div class="jso-btn jso-btn-shdw" on-click="handleNextStepButton">Next</div>
        </div>
    </template>
</dom-module>
<script>
    Polymer({
        is: "team-panel-form-wizard",
        properties: {
            step: {
                type: Number,
                value: 1
            },
            maxSteps: {
                type: Number,
                value: 4
            },
            formData: {
                type: Object,
                value: function () {
                    return {};
                },
                notify: true
            },
            diseaseColumns: {
                type: Array,
                value: function () {
                    return [];
                }
            },
            selectedDiseases: {
                type: Array,
                value: function () {
                    return [];
                },
                notify: true,
                observer: 'handleSelectedRows'
            },
            currentSelectedDiseasesData: {
                type: Array,
                value: function () {
                    return [];
                }
            }, selectedDiseasesData: {
                type: Array,
                value: function () {
                    return [];
                }
            },
            associatedGenes: {
                type: Object,
                value: function () {
                    return {};
                }
            },
            geneTab: {
                type: String,
                value: ''
            },
            geneColumns: {
                type: Array,
                value: function () {
                    return [];
                }
            },
            mutationTab: {
                type: String,
                value: 'gv'
            },
            mutationColumns: {
                type: Array,
                value: function () {
                    return [];
                }
            },
            mutationData: {
                type: Array,
                value: function () {
                    return [];
                }
            },
            metaStudy: {
                type: Object,
                value: function () {
                    return {};
                }
            },
            teamConfigFolder: {
                type: Object,
                value: function () {
                    return {};
                }
            }
        },
        observers: [
            "handleUpdatedGenes(formData.modCount)",
            "handleUpdatedSelectedDiseases(formData.diseases.splices)"
        ],
        handleUpdatedSelectedDiseases: function (neo, old, path) {

        },
        handleUpdatedGenes: function (neo, old, path) {
            if (neo) {
                this.$.geneTable.refresh();
            }
        },
        handleRemoveDisease: function (e) {
            var disease = e.detail.row;
            this.formData.removeGenesFromDisease(disease);

        },
        ready: function () {
            var me = this;

            this.formData = new Panel({polymer: this});
            this.$.allDiseases.setLoading(true);

            if (localStorage.bioinfo_team_diseases) {

                this.allDiseasesData = JSON.parse(localStorage.bioinfo_team_diseases);

            } else {
                $.ajax({
                    url: "http://bioinfodev.hpc.cam.ac.uk/cellbase/webservices/rest/v3/hsapiens/feature/clinical/phenotype-gene?include=clinvar,gwas",
                    dataType: 'json',
                    async: false,
                    success: function (response, textStatus, jqXHR) {
                        try {
                            var data = response.response;
                            var clinvar = data[0].result;
                            var gwas = data[1].result;

                            var diseases = [];

                            for (var i = 0; i < 100; i++) {
                                //for (var i = 0; i < clinvar.length; i++) {
                                var dis = clinvar[i];
                                dis.source = "clinvar";
                                diseases.push(dis);
                            }
                            for (var i = 0; i < 100; i++) {
                                //for (var i = 0; i < gwas.length; i++) {
                                var dis = gwas[i];
                                dis.source = "gwas";
                                diseases.push(dis);
                            }

                            diseases.sort(function (a, b) {
                                return a.phenotype.localeCompare(b.phenotype);
                            });


                            if (diseases.length > 0) {
                                me.allDiseasesData = diseases;
                                localStorage.bioinfo_team_diseases = JSON.stringify(diseases);
                            }


                        } catch (e) {

                        }

                    }
                });

            }
            this.$.allDiseases.setLoading(false);

            this.allDiseaseColumns = [
                {name: 'phenotype', title: 'Phenotype', type: 'text'},
                {
                    name: 'source', title: 'Source', type: 'select', options: ["clinvar", "gwas"], width: 100
                }
            ];
            this.diseaseColumns = [
                {name: 'phenotype', title: 'Phenotype', type: 'text'},
                {
                    name: 'source', title: 'Source', type: 'select', options: ["clinvar", "gwas"], width: 100
                },
                {name: '', title: '', type: 'action', width: 30}
            ];
            this.geneTab = 'text';
            this.geneColumns = [
                {name: 'name', title: 'Name'},
                {name: 'chr', title: 'Chr', defaultValue: '.'},
                {name: 'start', title: 'Start', defaultValue: '.'},
                {name: 'end', title: 'End', defaultValue: '.'},
                {name: '', title: '', type: 'action', width: 30}
            ];

            this.mutationColumns = [
                {name: 'chr', title: 'Chr', width: 40},
                {name: 'pos', title: 'Pos'},
                {name: 'ref', title: 'Ref', width: 70},
                {name: 'alt', title: 'Alt', width: 70},
                {name: 'phe', title: 'Phenotype'},
                {name: '', title: '', type: 'action', width: 30}
            ];
        },
        handleHiddenStep1: function (step) {
            return step != 1;
        }
        ,
        handleHiddenStep2: function (step) {
            return step != 2;
        }
        ,
        handleHiddenStep3: function (step) {
            return step != 3;
        }
        ,
        handleHiddenStep4: function (step) {
            return step != 4;
        }
        ,
        collapseMenu: function (menuHidden, searchingFlag) {
            return menuHidden || searchingFlag;
        }
        ,
        hideProjectList: function (menuHidden, searchingFlag) {
            return menuHidden || searchingFlag;
        }
        ,
        handlePrevStepButton: function (e) {
            this.step = (this.step <= 1) ? 1 : this.step - 1;
            console.log(this.step);
        }
        ,
        handleNextStepButton: function (e) {
            this.step = (this.step >= this.maxSteps) ? this.maxSteps : this.step + 1;
            console.log(this.step);
        }
        ,
        handleSelectedRows: function (neo, old) {
            return neo;
        }
        ,
        handleAddSelectedDiseases: function () {

            this.$.selectedDiseases.setLoading(true);
            for (var i = 0; i < this.currentSelectedDiseasesData.length; i++) {
                var row = this.currentSelectedDiseasesData[i];

                if (!this.formData.containsDisease(row)) {
                    this.formData.addDisease(row);

                }
            }
            this.$.selectedDiseases.setLoading(false);
        }
        ,
        handleClearSelectedDiseases: function () {
            this.formData.clearDiseases();
        }
        ,
        handleGenesImportBed: function (e) {

            var me = this;
            var bed_file = this.$.geneBedFileInput.files[0];
            if (bed_file != null) {
                var reader = new FileReader();
                reader.onload = function (e) {
                    var data = e.target.result;
                    var lines = data.split("\n");
                    for (var i = 0; i < lines.length; i++) {
                        var line = lines[i];
                        if (line.indexOf("#") < 0 && line != '') {
                            var fields = line.split("\t");
                            var chr = fields[0];
                            var start = fields[1];
                            var end = fields[2];

                            var gene = {
                                name: chr + ":" + start + "-" + end,
                                chr: chr,
                                start: start,
                                end: end
                            };

                            me.formData.addGene(gene);
                        }
                    }
                };
                reader.readAsText(bed_file);
            }
        }
        ,
        handleHiddenGeneText: function (geneTab) {
            return geneTab != 'text';
        }
        ,
        handleHiddenGeneBed: function (geneTab) {
            return geneTab != 'bed';
        }
        ,
        handleHiddenGenePanel: function (geneTab) {
            return geneTab != 'panel';
        }
        ,
        handleClickGeneText: function (e) {
            this.geneTab = 'text';
        }
        ,
        handleClickGeneBed: function (e) {
            this.geneTab = 'bed';
        }
        ,
        handleClickGenePanel: function (e) {
            this.geneTab = 'panel';
        }
        ,
        handleClickGeneTextAreaButton: function (e) {

            var textAreaValue = this.$.geneTextArea.value;
            var splits = textAreaValue.split(",");
            var genes = [];
            for (var i = 0; i < splits.length; i++) {
                var geneName = splits[i];

                if (geneName != '') {
                    this.formData.addGene({
                        name: geneName
                    })
                }
            }
            this.$.geneTextArea.value = '';
        }
        ,
        handleClickGeneListClear: function (e) {

            this.formData.clearGenes();
        }
        ,
        handleClickMutationGV: function (e) {
            this.mutationTab = 'gv';
        }
        ,
        handleClickMutationVCF: function (e) {
            this.mutationTab = 'vcf';
        }
        ,
        handleClickMutationCSV: function (e) {
            this.mutationTab = 'csv';
        }
        ,
        handleClickMutationPanel: function (e) {
            this.mutationTab = 'panel';
        }
        ,
        handleHiddenMutationGV: function (mutationTab) {
            return mutationTab != 'gv';
        }
        ,
        handleHiddenMutationVCF: function (mutationTab) {
            return mutationTab != 'vcf';
        }
        ,
        handleHiddenMutationCSV: function (mutationTab) {
            return mutationTab != 'csv';
        }
        ,
        handleHiddenMutationPanel: function (mutationTab) {
            return mutationTab != 'panel';
        }
        ,
        handleMutationImportVCF: function (e) {

            var me = this;
            var vcf_file = this.$.mutationVCFFileInput.files[0];

            if (vcf_file != null) {

                var reader = new FileReader();

                reader.onload = function (e) {
                    var data = e.target.result;
                    var lines = data.split("\n");
                    for (var i = 0; i < lines.length; i++) {
                        var line = lines[i];
                        if (line.indexOf("#") < 0 && line != '') {
                            var fields = line.split("\t");
                            var chr = fields[0];
                            var pos = fields[1];
                            var ref = fields[3];
                            var alt = fields[4];

                            var mut = {
                                chr: chr,
                                pos: pos,
                                ref: ref,
                                alt: alt,
                                phe: "TODO"
                            }
                            me.formData.addMutation(mut);

                        }
                    }
                };
                reader.readAsText(vcf_file);
            }
        }
        ,
        handleMutationImportCSV: function (e) {

            var me = this;
            var csv_file = this.$.mutationCSVFileInput.files[0];

            if (csv_file != null) {

                var reader = new FileReader();
                var separator = this.$.mutationCSVSeparator.selectedOptions[0].value;
                var ignoreHeader = this.$.mutationCSVHeader.checked;

                reader.onload = function (e) {
                    var data = e.target.result;
                    var lines = data.split("\n");
                    var i = ignoreHeader ? 1 : 0;

                    for (; i < lines.length; i++) {
                        var line = lines[i];
                        if (line != '') {
                            var fields = line.split(separator);
                            var chr = fields[0];
                            var pos = fields[1];
                            var ref = fields[2];
                            var alt = fields[3];
                            var phe = fields[4];

                            var mut = {
                                chr: chr,
                                pos: pos,
                                ref: ref,
                                alt: alt,
                                phe: phe

                            }
                            me.formData.addMutation(mut);
                        }
                    }
                };
                reader.readAsText(csv_file);
            }
        }
        ,
        handleClickMutationListClear: function (e) {
            this.formData.clearMutations();
        }
        ,
        handleMutationAdd: function (e) {

            var chr = this.$.mutationGVChr.value;
            var pos = this.$.mutationGVPos.value;
            var ref = this.$.mutationGVRef.value;
            var alt = this.$.mutationGVAlt.value;
            var phe = this.$.mutationGVPhe.value;

            var mut = {
                chr: chr,
                pos: pos,
                ref: ref,
                alt: alt,
                phe: phe

            }
            this.formData.addMutation(mut);

            this.$.mutationGVChr.value = "";
            this.$.mutationGVPos.value = "";
            this.$.mutationGVRef.value = "";
            this.$.mutationGVAlt.value = "";
            this.$.mutationGVPhe.value = "";

        }
        ,
        handleClickSavePanel: function (e) {
            if (this.formData.name == "") {
                alert("The Panel name is mandatory!!");
                return;
            }
            if (confirm("Are you sure?")) {

                if (this.metaStudy && this.teamConfigFolder) {


                    var content = pako.gzip(JSON.stringify(this.formData), {to: 'string'});
                    var separator = "#-#";
                    var fileName = "panel" + separator + this.formData.name + separator + this.formData.version + separator + this.formData.archived;
                    this.uploadFile(content, fileName, this.metaStudy.id);
                }

            }
        },
        uploadFile: function (fileContent, fileName, studyId) {
            var url = OpencgaManager.files.upload({
                query: {
                    sid: Cookies("bioinfo_sid")
                },
                request: {
                    url: true
                }
            });

            var blob = new Blob([fileContent], {type: 'text/plain'});

            var formData = new FormData();
            var userId = Cookies("bioinfo_user");
            var studyId = studyId;
            var relativeFilePath = '.team_config/' + fileName;
            var fileFormat = 'GZIP';
            var bioFormat = 'NONE';
            var description = '';
            var chunkId = 0;

            formData.append('chunk_content', blob);
            formData.append('chunk_id', chunkId);
            formData.append('chunk_size', blob.size);
            /*formData.append('chunk_hash', hash);*/
            formData.append("filename", fileName);
            formData.append('userId', userId);
            formData.append('studyId', studyId);
            formData.append('relativeFilePath', relativeFilePath);
            /*formData.append('chunk_gzip', );*/

            formData.append("last_chunk", true);
            formData.append("total_size", blob.size);
            formData.append("fileFormat", fileFormat);
            formData.append("bioFormat", bioFormat);
            formData.append("description", description);

            var xhr = new XMLHttpRequest();
            xhr.open('POST', url, false);
            xhr.onloadend = function (e) {
                console.log('upload Done!');

            };
            xhr.send(formData);
        }
    })
    ;
</script>
