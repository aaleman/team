<dom-module id="team-panel-wizard-mutation-step"></dom-module>
<style>
    :host {
        display: block;
        position: relative;
        box-sizing: border-box;
        height: 100%;
    }

    .step-title {
        height: 50px;
        text-align: center;
        vertical-align: middle;
        line-height: 50px;
        font-size: 16pt;
    }

    #mutations-tab {
        height: 80%;
        width: 50%;
    }

    #mutations-list {
        height: 80%;
        width: 50%;
    }

    .mutations-tab-container-elem {
        margin: 20px;
    }

    .step-content {
        height: calc(100% - 50px);
    }

</style>
<template>
    <div class="vertical layout">
        <div class="step-title">
            Step <span>{{stepNumber}}</span>: Mutations
        </div>
        <div class="step-content horizontal layout">
            <div id="mutations-tab" flex>
                <div id="mutations-tab-menu" class="horizontal layout">
                    <div class="jso-btn jso-btn-shdw" on-click="handleClickMutationGV">Genomic Pos.</div>
                    <div class="jso-btn jso-btn-shdw" on-click="handleClickMutationVCF">Import VCF</div>
                    <div class="jso-btn jso-btn-shdw" on-click="handleClickMutationCSV">Import CSV</div>
                    <div class="jso-btn jso-btn-shdw" on-click="handleClickMutationPanel">Import from other Panel</div>
                </div>
                <div id="mutations-tab-container">
                    <div id="mutation-tab-config-gv" class="mutations-tab-container-elem vertical layout"
                         hidden$={{handleHiddenMutationGV(mutationTab)}}>
                        <div class="vertical layout">
                            <div class="horizontal layout">
                                <div>
                                    <label for="">Chr</label>
                                    <input type="text" name="mutationGVChr" id="mutationGVChr"/>
                                </div>
                                <div>
                                    <label for="">Pos</label>
                                    <input type="text" name="mutationGVPos" id="mutationGVPos"/>
                                </div>
                                <div>
                                    <label for="">Ref</label>
                                    <input type="text" name="mutationGVRef" id="mutationGVRef"/>
                                </div>
                                <div>
                                    <label for="">Alt</label>
                                    <input type="text" name="mutationGVAlt" id="mutationGVAlt"/>
                                </div>
                                <div>
                                    <label for="">Phe</label>
                                    <input type="text" name="mutationGVPhe" id="mutationGVPhe"/>
                                </div>
                            </div>
                            <div class="jso-btn jso-btn-shdw" on-click="handleMutationAdd">
                                <span>Add!!</span>
                            </div>

                        </div>
                        <jso-genome-viewer-element id="gv"></jso-genome-viewer-element>
                    </div>
                    <div id="mutation-tab-config-vcf" class="mutations-tab-container-elem"
                         hidden$={{handleHiddenMutationVCF(mutationTab)}}>

                        <input type="file" id="mutationVCFFileInput">

                        <div class="jso-btn jso-btn-shdw" on-click="handleMutationImportVCF">
                            <span>Import!!</span>
                        </div>
                    </div>
                    <div id="mutation-tab-config-csv"
                         hidden$={{handleHiddenMutationCSV(mutationTab)}} class="vertical layout">

                        <div>
                            <label for="">Separator:</label>
                            <select name="mutationCSVSeparator" id="mutationCSVSeparator">
                                <option value=";" selected>;</option>
                                <option value=",">,</option>
                                <option value="\t">Tab</option>
                            </select>
                        </div>


                        <div>
                            <label for="">Ignore first line (header):</label>
                            <input type="checkbox" name="mutationCSVHeader" id="mutationCSVHeader" value="ignore"
                                   checked/>
                        </div>


                        <input type="file" id="mutationCSVFileInput">

                        <div class="jso-btn jso-btn-shdw" on-click="handleMutationImportCSV">
                            <span>Import!!</span>
                        </div>
                    </div>
                    <div id="mutation-tab-config-panel"
                         hidden$={{handleHiddenMutationPanel(mutationTab)}}>TODO
                    </div>
                </div>
            </div>
            <div id="mutations-list" flex>
                <jso-table id="mutationTable" columns="{{mutationColumns}}" data="{{formData.mutations}}"></jso-table>
                <div class="jso-btn jso-btn-shdw" on-click="handleClickMutationListClear">Clear</div>
            </div>
        </div>
    </div>
</template>
<script>
    Polymer({
        is: "team-panel-wizard-mutation-step",
        properties: {
            stepNumber: {
                type: Number,
                value: 0
            },
            mutationTab: {
                type: String,
                value: ''
            },
            mutationColumns: {
                type: Array,
                value: function () {
                    return [];
                }
            },
            mutationData: {
                type: Array,
                value: function () {
                    return [];
                }
            },
            formData: {
                type: Object,
                value: function () {
                    return {};
                }
            }
        },
        handleClickMutationGV: function (e) {
            this.mutationTab = 'gv';
        },
        handleClickMutationVCF: function (e) {
            this.mutationTab = 'vcf';
        },
        handleClickMutationCSV: function (e) {
            this.mutationTab = 'csv';
        },
        handleClickMutationPanel: function (e) {
            this.mutationTab = 'panel';
        },
        handleHiddenMutationGV: function (mutationTab) {
            return mutationTab != 'gv';
        },
        handleHiddenMutationVCF: function (mutationTab) {
            return mutationTab != 'vcf';
        },
        handleHiddenMutationCSV: function (mutationTab) {
            return mutationTab != 'csv';
        },
        handleHiddenMutationPanel: function (mutationTab) {
            return mutationTab != 'panel';
        },
        ready: function () {
            this.mutationTab = 'gv';

            this.mutationColumns = [
                {name: 'chr', title: 'Chr', width: 40},
                {name: 'pos', title: 'Pos'},
                {name: 'ref', title: 'Ref', width: 70},
                {name: 'alt', title: 'Alt', width: 70},
                {name: 'phe', title: 'Phenotype'},
            ];
        },
        handleMutationImportVCF: function (e) {

            var me = this;
            var vcf_file = this.$.mutationVCFFileInput.files[0];

            if (vcf_file != null) {

                var reader = new FileReader();

                reader.onload = function (e) {
                    var data = e.target.result;
                    var lines = data.split("\n");
                    for (var i = 0; i < lines.length; i++) {
                        var line = lines[i];
                        if (line.indexOf("#") < 0 && line != '') {
                            var fields = line.split("\t");
                            var chr = fields[0];
                            var pos = fields[1];
                            var ref = fields[3];
                            var alt = fields[4];

                            var mut = {
                                chr: chr,
                                pos: pos,
                                ref: ref,
                                alt: alt
                            }
                            me.formData.addMutation(mut);

                        }
                    }

                    me.$.mutationTable.refresh();

                };

                reader.readAsText(vcf_file);

            }

        },
        handleMutationImportCSV: function (e) {

            var me = this;
            var csv_file = this.$.mutationCSVFileInput.files[0];

            if (csv_file != null) {

                var reader = new FileReader();
                var separator = this.$.mutationCSVSeparator.selectedOptions[0].value;
                var ignoreHeader = this.$.mutationCSVHeader.checked;

                reader.onload = function (e) {
                    var data = e.target.result;
                    var lines = data.split("\n");
                    var i = ignoreHeader ? 1 : 0;

                    for (; i < lines.length; i++) {
                        var line = lines[i];
                        if (line != '') {
                            var fields = line.split(separator);
                            var chr = fields[0];
                            var pos = fields[1];
                            var ref = fields[2];
                            var alt = fields[3];
                            var phe = fields[4];

                            var mut = {
                                chr: chr,
                                pos: pos,
                                ref: ref,
                                alt: alt,
                                phe: phe

                            }
                            me.formData.addMutation(mut);
                        }
                    }
                    me.$.mutationTable.refresh();
                };
                reader.readAsText(csv_file);
            }
        },
        handleClickMutationListClear: function (e) {
            this.formData.clearMutations();
        },
        handleMutationAdd: function (e) {

            var chr = this.$.mutationGVChr.value;
            var pos = this.$.mutationGVPos.value;
            var ref = this.$.mutationGVRef.value;
            var alt = this.$.mutationGVAlt.value;
            var phe = this.$.mutationGVPhe.value;

            var mut = {
                chr: chr,
                pos: pos,
                ref: ref,
                alt: alt,
                phe: phe

            }
            this.formData.addMutation(mut);
            this.$.mutationTable.refresh();


            this.$.mutationGVChr.value = "";
            this.$.mutationGVPos.value = "";
            this.$.mutationGVRef.value = "";
            this.$.mutationGVAlt.value = "";
            this.$.mutationGVPhe.value = "";

        }


    });
</script>
