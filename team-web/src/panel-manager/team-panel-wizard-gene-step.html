<dom-module id="team-panel-wizard-gene-step"></dom-module>
<style>
    :host {
        display: block;
        position: relative;
        box-sizing: border-box;
        height: 100%;

    }

    .step-title {
        height: 50px;
        text-align: center;
        vertical-align: middle;
        line-height: 50px;
        font-size: 16pt;
    }

    #genes-tab {
        height: 80%;
        width: 50%;
    }

    #genes-list {
        height: 80%;
        width: 50%;
    }

    .genes-tab-container-elem {
        margin: 20px;
    }

    .step-content {
        height: calc(100% - 50px);
    }
</style>
<template>
    <div class="vertical layout">
        <div class="step-title">
            Step <span>{{stepNumber}}</span>: Genes
        </div>
        <div class="step-content horizontal layout">
            <div id="genes-tab" flex>
                <div id="genes-tab-menu" class="horizontal layout">
                    <div class="jso-btn jso-btn-shdw" on-click="handleClickGeneText">Genes/Regions</div>
                    <div class="jso-btn jso-btn-shdw" on-click="handleClickGeneBed">Import from BED</div>
                    <div class="jso-btn jso-btn-shdw" on-click="handleClickGenePanel">Import from other Panel</div>
                </div>
                <div id="genes-tab-container">
                    <div id="gene-tab-config-text" class="genes-tab-container-elem"
                         hidden$={{handleHiddenGeneText(geneTab)}}>
                                    <textarea class="jso" name="geneTextArea" id="geneTextArea" rows="3"
                                              placeholder="BRCA2,PPL"></textarea>

                        <div class="jso-btn jso-btn-shdw" on-click="handleClickGeneTextAreaButton">Add
                            Genes
                        </div>
                    </div>
                    <div id="gene-tab-config-bed" class="genes-tab-container-elem"
                         hidden$={{handleHiddenGeneBed(geneTab)}}>
                        <input type="file" id="geneBedFileInput">

                        <div class="jso-btn jso-btn-shdw" on-click="handleGenesImportBed">
                            <span>Import!!</span>
                        </div>
                        <br>
                    </div>
                    <div id="gene-tab-config-panel"
                         hidden$={{handleHiddenGenePanel(geneTab)}}>PANEL
                    </div>
                </div>
            </div>
            <div id="genes-list" flex>
                <jso-table id="geneTable" columns="{{geneColumns}}" data="{{formData.genes}}"></jso-table>
                <div class="jso-btn jso-btn-shdw" on-click="handleClickGeneListClear">Clear</div>
            </div>
        </div>
    </div>
</template>

<script>
    Polymer({
        is: "team-panel-wizard-gene-step",
        properties: {
            stepNumber: {
                type: Number,
                value: 0
            },
            geneTab: {
                type: String,
                value: ''
            },
            geneColumns: {
                type: Array,
                value: function () {
                    return [];
                }
            },
            formData: {
                type: Object,
                value: function () {
                    return {};
                }
            },
            notify: true
        },
        observers: ["handleUpdatedGenes(formData.modCount)"],
        handleUpdatedGenes: function (neo, old, path) {
            if (neo) {
                this.$.geneTable.refresh();
            }
        },
        ready: function () {
            this.geneTab = 'text';
            this.geneColumns = [
                {name: 'name', title: 'Name'},
                {name: 'chr', title: 'CHR', defaultValue: '.'},
                {name: 'start', title: 'Start', defaultValue: '.'},
                {name: 'end', title: 'End', defaultValue: '.'},
                {name: "", type: 'action'}
            ];


            this.$.geneTextArea.value = "a,b,c,d,e,f,g"
        }
        ,
        handleGenesImportBed: function (e) {

            var me = this;
            var bed_file = this.$.geneBedFileInput.files[0];
            if (bed_file != null) {
                var reader = new FileReader();
                reader.onload = function (e) {
                    var data = e.target.result;
                    var lines = data.split("\n");
                    for (var i = 0; i < lines.length; i++) {
                        var line = lines[i];
                        if (line.indexOf("#") < 0 && line != '') {
                            var fields = line.split("\t");
                            var chr = fields[0];
                            var start = fields[1];
                            var end = fields[2];

                            var gene = {
                                name: chr + ":" + start + "-" + end,
                                chr: chr,
                                start: start,
                                end: end
                            };

                            me.formData.addGene(gene);
                        }
                    }
                    me.$.geneTable.refresh();
                };
                reader.readAsText(bed_file);
            }
        }
        ,
        handleHiddenGeneText: function (geneTab) {
            return geneTab != 'text';
        }
        ,

        handleHiddenGeneBed: function (geneTab) {
            return geneTab != 'bed';
        }
        ,
        handleHiddenGenePanel: function (geneTab) {
            return geneTab != 'panel';
        }
        ,
        handleClickGeneText: function (e) {
            this.geneTab = 'text';
        }
        ,
        handleClickGeneBed: function (e) {
            this.geneTab = 'bed';
        }
        ,
        handleClickGenePanel: function (e) {
            this.geneTab = 'panel';
        }
        ,
        handleClickGeneTextAreaButton: function (e) {

            var textAreaValue = this.$.geneTextArea.value;
            var splits = textAreaValue.split(",");
            var genes = [];
            for (var i = 0; i < splits.length; i++) {
                var geneName = splits[i];

                if (geneName != '') {

                    this.formData.addGene({
                        name: geneName
                    })
                }
            }
            this.$.geneTable.update(this.formData.genes);
            this.$.geneTextArea.value = '';
        }
        ,
        handleClickGeneListClear: function (e) {

            this.formData.clearGenes();
            this.$.geneTable.update(this.formData.genes);
        }

    })
    ;
</script>
